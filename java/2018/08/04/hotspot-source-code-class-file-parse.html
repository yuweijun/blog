<!doctype html>




<html class="theme-next mist">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">


















  

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">






  <link rel="alternate" href="/blog/atom.xml" title="一" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1">






<meta name="description" content="Java 的版本号定义如下： 80818283848586878889909192939495// Used for two backward compatibility reasons:// - to check for new additions to the class file format in JDK1.5// - to check for bug fixes in the forma">
<meta property="og:type" content="article">
<meta property="og:title" content="hotspot source code - class file parse">
<meta property="og:url" content="http://www.4e00.com/java/2018/08/04/hotspot-source-code-class-file-parse.html">
<meta property="og:site_name" content="一">
<meta property="og:description" content="Java 的版本号定义如下： 80818283848586878889909192939495// Used for two backward compatibility reasons:// - to check for new additions to the class file format in JDK1.5// - to check for bug fixes in the forma">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-03-06T01:24:26.136Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hotspot source code - class file parse">
<meta name="twitter:description" content="Java 的版本号定义如下： 80818283848586878889909192939495// Used for two backward compatibility reasons:// - to check for new additions to the class file format in JDK1.5// - to check for bug fixes in the forma">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide"},
    fancybox: false,
    motion: false,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://www.4e00.com/blog/java/2018/08/04/hotspot-source-code-class-file-parse.html">

  <title> hotspot source code - class file parse | 一 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/" class="brand" rel="start">
      <span class="site-title">一</span>
    </a>
  </div>
  <p class="site-subtitle">{"type":"编程笔记"}</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      <li class="menu-item menu-item-search">
        <a href="https://www.google.com.hk/search?q=site%3Ahttp://www.4e00.com/blog/" class="popup-trigger">
          <i class="menu-item-icon fa fa-search fa-fw"></i>Search
        </a>
      </li>
    </ul>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                hotspot source code - class file parse
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-08-04T22:01:46+08:00" content="2018-08-04">
              2018-08-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Java 的版本号定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">80</span><span class="line">81</span><span class="line">82</span><span class="line">83</span><span class="line">84</span><span class="line">85</span><span class="line">86</span><span class="line">87</span><span class="line">88</span><span class="line">89</span><span class="line">90</span><span class="line">91</span><span class="line">92</span><span class="line">93</span><span class="line">94</span><span class="line">95</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Used for two backward compatibility reasons:</span></span><span class="line"><span class="comment">// - to check for new additions to the class file format in JDK1.5</span></span><span class="line"><span class="comment">// - to check for bug fixes in the format checker in JDK1.5</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_1_5_VERSION                  49</span></span><span class="line"></span><span class="line"><span class="comment">// Used for backward compatibility reasons:</span></span><span class="line"><span class="comment">// - to check for javac bug fixes that happened after 1.5</span></span><span class="line"><span class="comment">// - also used as the max version when running in jdk6</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_6_VERSION                    50</span></span><span class="line"></span><span class="line"><span class="comment">// Used for backward compatibility reasons:</span></span><span class="line"><span class="comment">// - to check NameAndType_info signatures more aggressively</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_7_VERSION                    51</span></span><span class="line"></span><span class="line"><span class="comment">// Extension method support.</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_8_VERSION                    52</span></span></pre></td></tr></table></figure>
<p>Java7 常量池中新增加了3个常量类型，如<code>InvokeDynamic</code>，<code>MethodHandle</code>和<code>MethodType</code>，Java7 发布时 JVM 中新增加了一个指令<code>invokedynamic</code>，在常量池解析时就会碰到与这个指令直接相关的新增加的3个常量类型和新增加的属性<code>BootstrapMethods</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">97</span><span class="line">98</span><span class="line">99</span><span class="line">100</span><span class="line">101</span><span class="line">102</span><span class="line">103</span><span class="line">104</span><span class="line">105</span><span class="line">106</span><span class="line">107</span><span class="line">108</span><span class="line">109</span><span class="line">110</span><span class="line">111</span><span class="line">112</span><span class="line">113</span><span class="line">114</span><span class="line">115</span><span class="line">116</span><span class="line">117</span><span class="line">118</span><span class="line">119</span><span class="line">120</span><span class="line">121</span><span class="line">122</span><span class="line">123</span><span class="line">124</span><span class="line">125</span><span class="line">126</span><span class="line">127</span><span class="line">128</span><span class="line">129</span><span class="line">130</span><span class="line">131</span><span class="line">132</span><span class="line">133</span><span class="line">134</span><span class="line">135</span><span class="line">136</span><span class="line">137</span><span class="line">138</span><span class="line">139</span><span class="line">140</span><span class="line">141</span><span class="line">142</span><span class="line">143</span><span class="line">144</span><span class="line">145</span><span class="line">146</span><span class="line">147</span><span class="line">148</span><span class="line">149</span><span class="line">150</span><span class="line">151</span><span class="line">152</span><span class="line">153</span><span class="line">154</span><span class="line">155</span><span class="line">156</span><span class="line">157</span><span class="line">158</span><span class="line">159</span><span class="line">160</span><span class="line">161</span><span class="line">162</span><span class="line">163</span><span class="line">164</span><span class="line">165</span><span class="line">166</span><span class="line">167</span><span class="line">168</span><span class="line">169</span><span class="line">170</span><span class="line">171</span><span class="line">172</span><span class="line">173</span><span class="line">174</span><span class="line">175</span><span class="line">176</span><span class="line">177</span><span class="line">178</span><span class="line">179</span><span class="line">180</span><span class="line">181</span><span class="line">182</span><span class="line">183</span><span class="line">184</span><span class="line">185</span><span class="line">186</span><span class="line">187</span><span class="line">188</span><span class="line">189</span><span class="line">190</span><span class="line">191</span><span class="line">192</span><span class="line">193</span><span class="line">194</span><span class="line">195</span><span class="line">196</span><span class="line">197</span><span class="line">198</span><span class="line">199</span><span class="line">200</span><span class="line">201</span><span class="line">202</span><span class="line">203</span><span class="line">204</span><span class="line">205</span><span class="line">206</span><span class="line">207</span><span class="line">208</span><span class="line">209</span><span class="line">210</span><span class="line">211</span><span class="line">212</span><span class="line">213</span><span class="line">214</span><span class="line">215</span><span class="line">216</span><span class="line">217</span><span class="line">218</span><span class="line">219</span><span class="line">220</span><span class="line">221</span><span class="line">222</span><span class="line">223</span><span class="line">224</span><span class="line">225</span><span class="line">226</span><span class="line">227</span><span class="line">228</span><span class="line">229</span><span class="line">230</span><span class="line">231</span><span class="line">232</span><span class="line">233</span><span class="line">234</span><span class="line">235</span><span class="line">236</span><span class="line">237</span><span class="line">238</span><span class="line">239</span><span class="line">240</span><span class="line">241</span><span class="line">242</span><span class="line">243</span><span class="line">244</span><span class="line">245</span><span class="line">246</span><span class="line">247</span><span class="line">248</span><span class="line">249</span><span class="line">250</span><span class="line">251</span><span class="line">252</span><span class="line">253</span><span class="line">254</span><span class="line">255</span><span class="line">256</span><span class="line">257</span><span class="line">258</span><span class="line">259</span><span class="line">260</span><span class="line">261</span><span class="line">262</span><span class="line">263</span><span class="line">264</span><span class="line">265</span><span class="line">266</span><span class="line">267</span><span class="line">268</span><span class="line">269</span><span class="line">270</span><span class="line">271</span><span class="line">272</span><span class="line">273</span><span class="line">274</span><span class="line">275</span><span class="line">276</span><span class="line">277</span><span class="line">278</span><span class="line">279</span><span class="line">280</span><span class="line">281</span><span class="line">282</span><span class="line">283</span><span class="line">284</span><span class="line">285</span><span class="line">286</span><span class="line">287</span><span class="line">288</span><span class="line">289</span><span class="line">290</span><span class="line">291</span><span class="line">292</span><span class="line">293</span><span class="line">294</span><span class="line">295</span><span class="line">296</span><span class="line">297</span><span class="line">298</span><span class="line">299</span><span class="line">300</span><span class="line">301</span><span class="line">302</span><span class="line">303</span><span class="line">304</span><span class="line">305</span><span class="line">306</span><span class="line">307</span><span class="line">308</span><span class="line">309</span><span class="line">310</span><span class="line">311</span><span class="line">312</span><span class="line">313</span><span class="line">314</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ClassFileParser::parse_constant_pool_entries</span><span class="params">(<span class="keyword">int</span> length, TRAPS)</span> </span>&#123;</span><span class="line">  <span class="comment">// Use a local copy of ClassFileStream. It helps the C++ compiler to optimize</span></span><span class="line">  <span class="comment">// this function (_current can be allocated in a register, with scalar</span></span><span class="line">  <span class="comment">// replacement of aggregates). The _current pointer is copied back to</span></span><span class="line">  <span class="comment">// stream() when this function returns. DON'T call another method within</span></span><span class="line">  <span class="comment">// this method that uses stream().</span></span><span class="line">  ClassFileStream* cfs0 = stream();</span><span class="line">  ClassFileStream cfs1 = *cfs0;</span><span class="line">  ClassFileStream* cfs = &amp;cfs1;</span><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ASSERT</span></span><span class="line">  assert(cfs-&gt;allocated_on_stack(),<span class="string">"should be local"</span>);</span><span class="line">  u1* old_current = cfs0-&gt;current();</span><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><span class="line">  <span class="function">Handle <span class="title">class_loader</span><span class="params">(THREAD, _loader_data-&gt;class_loader())</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Used for batching symbol allocations.</span></span><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* names[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">int</span> lengths[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">int</span> indices[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValues[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">int</span> names_count = <span class="number">0</span>;</span><span class="line"></span><span class="line">  <span class="comment">// parsing  Index 0 is unused</span></span><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">1</span>; index &lt; length; index++) &#123;</span><span class="line">    <span class="comment">// Each of the following case guarantees one more byte in the stream</span></span><span class="line">    <span class="comment">// for the following tag or the access_flags following constant pool,</span></span><span class="line">    <span class="comment">// so we don't need bounds-check for reading tag.</span></span><span class="line">    u1 tag = cfs-&gt;get_u1_fast();</span><span class="line">    <span class="keyword">switch</span> (tag) &#123;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Class :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">3</span>, CHECK);  <span class="comment">// name_index, tag/access_flags</span></span><span class="line">          u2 name_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;klass_index_at_put(index, name_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Fieldref :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// class_index, name_and_type_index, tag/access_flags</span></span><span class="line">          u2 class_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;field_at_put(index, class_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Methodref :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// class_index, name_and_type_index, tag/access_flags</span></span><span class="line">          u2 class_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;method_at_put(index, class_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_InterfaceMethodref :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// class_index, name_and_type_index, tag/access_flags</span></span><span class="line">          u2 class_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;interface_method_at_put(index, class_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_String :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">3</span>, CHECK);  <span class="comment">// string_index, tag/access_flags</span></span><span class="line">          u2 string_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;string_index_at_put(index, string_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_MethodHandle :</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_MethodType :</span><span class="line">        <span class="keyword">if</span> (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) &#123;</span><span class="line">          classfile_parse_error(</span><span class="line">            <span class="string">"Class file version does not support constant tag %u in class file %s"</span>,</span><span class="line">            tag, CHECK);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span> (!EnableInvokeDynamic) &#123;</span><span class="line">          classfile_parse_error(</span><span class="line">            <span class="string">"This JVM does not support constant tag %u in class file %s"</span>,</span><span class="line">            tag, CHECK);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span> (tag == JVM_CONSTANT_MethodHandle) &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">4</span>, CHECK);  <span class="comment">// ref_kind, method_index, tag/access_flags</span></span><span class="line">          u1 ref_kind = cfs-&gt;get_u1_fast();</span><span class="line">          u2 method_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;method_handle_index_at_put(index, ref_kind, method_index);</span><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == JVM_CONSTANT_MethodType) &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">3</span>, CHECK);  <span class="comment">// signature_index, tag/access_flags</span></span><span class="line">          u2 signature_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;method_type_index_at_put(index, signature_index);</span><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><span class="line">          ShouldNotReachHere();</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_InvokeDynamic :</span><span class="line">        &#123;</span><span class="line">          <span class="keyword">if</span> (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) &#123;</span><span class="line">            classfile_parse_error(</span><span class="line">              <span class="string">"Class file version does not support constant tag %u in class file %s"</span>,</span><span class="line">              tag, CHECK);</span><span class="line">          &#125;</span><span class="line">          <span class="keyword">if</span> (!EnableInvokeDynamic) &#123;</span><span class="line">            classfile_parse_error(</span><span class="line">              <span class="string">"This JVM does not support constant tag %u in class file %s"</span>,</span><span class="line">              tag, CHECK);</span><span class="line">          &#125;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// bsm_index, nt, tag/access_flags</span></span><span class="line">          u2 bootstrap_specifier_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          <span class="keyword">if</span> (_max_bootstrap_specifier_index &lt; (<span class="keyword">int</span>) bootstrap_specifier_index)</span><span class="line">            _max_bootstrap_specifier_index = (<span class="keyword">int</span>) bootstrap_specifier_index;  <span class="comment">// collect for later</span></span><span class="line">          _cp-&gt;invoke_dynamic_at_put(index, bootstrap_specifier_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Integer :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u4 bytes = cfs-&gt;get_u4_fast();</span><span class="line">          _cp-&gt;int_at_put(index, (jint) bytes);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Float :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u4 bytes = cfs-&gt;get_u4_fast();</span><span class="line">          _cp-&gt;float_at_put(index, *(jfloat*)&amp;bytes);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Long :</span><span class="line">        <span class="comment">// A mangled type might cause you to overrun allocated memory</span></span><span class="line">        guarantee_property(index+<span class="number">1</span> &lt; length,</span><span class="line">                           <span class="string">"Invalid constant pool entry %u in class file %s"</span>,</span><span class="line">                           index, CHECK);</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">9</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u8 bytes = cfs-&gt;get_u8_fast();</span><span class="line">          _cp-&gt;long_at_put(index, bytes);</span><span class="line">        &#125;</span><span class="line">        index++;   <span class="comment">// Skip entry following eigth-byte constant, see JVM book p. 98</span></span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Double :</span><span class="line">        <span class="comment">// A mangled type might cause you to overrun allocated memory</span></span><span class="line">        guarantee_property(index+<span class="number">1</span> &lt; length,</span><span class="line">                           <span class="string">"Invalid constant pool entry %u in class file %s"</span>,</span><span class="line">                           index, CHECK);</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">9</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u8 bytes = cfs-&gt;get_u8_fast();</span><span class="line">          _cp-&gt;double_at_put(index, *(jdouble*)&amp;bytes);</span><span class="line">        &#125;</span><span class="line">        index++;   <span class="comment">// Skip entry following eigth-byte constant, see JVM book p. 98</span></span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_NameAndType :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// name_index, signature_index, tag/access_flags</span></span><span class="line">          u2 name_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 signature_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;name_and_type_at_put(index, name_index, signature_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Utf8 :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">2</span>, CHECK);  <span class="comment">// utf8_length</span></span><span class="line">          u2  utf8_length = cfs-&gt;get_u2_fast();</span><span class="line">          u1* utf8_buffer = cfs-&gt;get_u1_buffer();</span><span class="line">          assert(utf8_buffer != <span class="literal">NULL</span>, <span class="string">"null utf8 buffer"</span>);</span><span class="line">          <span class="comment">// Got utf8 string, guarantee utf8_length+1 bytes, set stream position forward.</span></span><span class="line">          cfs-&gt;guarantee_more(utf8_length+<span class="number">1</span>, CHECK);  <span class="comment">// utf8 string, tag/access_flags</span></span><span class="line">          cfs-&gt;skip_u1_fast(utf8_length);</span><span class="line"></span><span class="line">          <span class="comment">// Before storing the symbol, make sure it's legal</span></span><span class="line">          <span class="keyword">if</span> (_need_verify) &#123;</span><span class="line">            verify_legal_utf8((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)utf8_buffer, utf8_length, CHECK);</span><span class="line">          &#125;</span><span class="line"></span><span class="line">          <span class="keyword">if</span> (EnableInvokeDynamic &amp;&amp; has_cp_patch_at(index)) &#123;</span><span class="line">            Handle patch = clear_cp_patch_at(index);</span><span class="line">            guarantee_property(java_lang_String::is_instance(patch()),</span><span class="line">                               <span class="string">"Illegal utf8 patch at %d in class file %s"</span>,</span><span class="line">                               index, CHECK);</span><span class="line">            <span class="keyword">char</span>* str = java_lang_String::as_utf8_string(patch());</span><span class="line">            <span class="comment">// (could use java_lang_String::as_symbol instead, but might as well batch them)</span></span><span class="line">            utf8_buffer = (u1*) str;</span><span class="line">            utf8_length = (u2) <span class="built_in">strlen</span>(str);</span><span class="line">          &#125;</span><span class="line"></span><span class="line">          <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</span><span class="line">          Symbol* result = SymbolTable::lookup_only((<span class="keyword">char</span>*)utf8_buffer, utf8_length, hash);</span><span class="line">          <span class="keyword">if</span> (result == <span class="literal">NULL</span>) &#123;</span><span class="line">            names[names_count] = (<span class="keyword">char</span>*)utf8_buffer;</span><span class="line">            lengths[names_count] = utf8_length;</span><span class="line">            indices[names_count] = index;</span><span class="line">            hashValues[names_count++] = hash;</span><span class="line">            <span class="keyword">if</span> (names_count == SymbolTable::symbol_alloc_batch_size) &#123;</span><span class="line">              SymbolTable::new_symbols(_loader_data, _cp, names_count, names, lengths, indices, hashValues, CHECK);</span><span class="line">              names_count = <span class="number">0</span>;</span><span class="line">            &#125;</span><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><span class="line">            _cp-&gt;symbol_at_put(index, result);</span><span class="line">          &#125;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">default</span>:</span><span class="line">        classfile_parse_error(</span><span class="line">          <span class="string">"Unknown constant tag %u in class file %s"</span>, tag, CHECK);</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">    &#125;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Allocate the remaining symbols</span></span><span class="line">  <span class="keyword">if</span> (names_count &gt; <span class="number">0</span>) &#123;</span><span class="line">    SymbolTable::new_symbols(_loader_data, _cp, names_count, names, lengths, indices, hashValues, CHECK);</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Copy _current pointer of local copy back to stream().</span></span><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ASSERT</span></span><span class="line">  assert(cfs0-&gt;current() == old_current, <span class="string">"non-exclusive use of stream()"</span>);</span><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><span class="line">  cfs0-&gt;set_current(cfs1.current());</span><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>第<code>2807</code>行关于<code>BootstrapMethods</code>属性相关的解析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">2807</span><span class="line">2808</span><span class="line">2809</span><span class="line">2810</span><span class="line">2811</span><span class="line">2812</span><span class="line">2813</span><span class="line">2814</span><span class="line">2815</span><span class="line">2816</span><span class="line">2817</span><span class="line">2818</span><span class="line">2819</span><span class="line">2820</span><span class="line">2821</span><span class="line">2822</span><span class="line">2823</span><span class="line">2824</span><span class="line">2825</span><span class="line">2826</span><span class="line">2827</span><span class="line">2828</span><span class="line">2829</span><span class="line">2830</span><span class="line">2831</span><span class="line">2832</span><span class="line">2833</span><span class="line">2834</span><span class="line">2835</span><span class="line">2836</span><span class="line">2837</span><span class="line">2838</span><span class="line">2839</span><span class="line">2840</span><span class="line">2841</span><span class="line">2842</span><span class="line">2843</span><span class="line">2844</span><span class="line">2845</span><span class="line">2846</span><span class="line">2847</span><span class="line">2848</span><span class="line">2849</span><span class="line">2850</span><span class="line">2851</span><span class="line">2852</span><span class="line">2853</span><span class="line">2854</span><span class="line">2855</span><span class="line">2856</span><span class="line">2857</span><span class="line">2858</span><span class="line">2859</span><span class="line">2860</span><span class="line">2861</span><span class="line">2862</span><span class="line">2863</span><span class="line">2864</span><span class="line">2865</span><span class="line">2866</span><span class="line">2867</span><span class="line">2868</span><span class="line">2869</span><span class="line">2870</span><span class="line">2871</span><span class="line">2872</span><span class="line">2873</span><span class="line">2874</span><span class="line">2875</span><span class="line">2876</span><span class="line">2877</span><span class="line">2878</span><span class="line">2879</span><span class="line">2880</span><span class="line">2881</span><span class="line">2882</span><span class="line">2883</span><span class="line">2884</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ClassFileParser::parse_classfile_bootstrap_methods_attribute</span><span class="params">(u4 attribute_byte_length, TRAPS)</span> </span>&#123;</span><span class="line">  ClassFileStream* cfs = stream();</span><span class="line">  u1* current_start = cfs-&gt;current();</span><span class="line"></span><span class="line">  guarantee_property(attribute_byte_length &gt;= <span class="keyword">sizeof</span>(u2),</span><span class="line">                     <span class="string">"Invalid BootstrapMethods attribute length %u in class file %s"</span>,</span><span class="line">                     attribute_byte_length,</span><span class="line">                     CHECK);</span><span class="line"></span><span class="line">  cfs-&gt;guarantee_more(attribute_byte_length, CHECK);</span><span class="line"></span><span class="line">  <span class="keyword">int</span> attribute_array_length = cfs-&gt;get_u2_fast();</span><span class="line"></span><span class="line">  guarantee_property(_max_bootstrap_specifier_index &lt; attribute_array_length,</span><span class="line">                     <span class="string">"Short length on BootstrapMethods in class file %s"</span>,</span><span class="line">                     CHECK);</span><span class="line"></span><span class="line">  <span class="comment">// The attribute contains a counted array of counted tuples of shorts,</span></span><span class="line">  <span class="comment">// represending bootstrap specifiers:</span></span><span class="line">  <span class="comment">//    length*&#123;bootstrap_method_index, argument_count*&#123;argument_index&#125;&#125;</span></span><span class="line">  <span class="keyword">int</span> operand_count = (attribute_byte_length - <span class="keyword">sizeof</span>(u2)) / <span class="keyword">sizeof</span>(u2);</span><span class="line">  <span class="comment">// operand_count = number of shorts in attr, except for leading length</span></span><span class="line"></span><span class="line">  <span class="comment">// The attribute is copied into a short[] array.</span></span><span class="line">  <span class="comment">// The array begins with a series of short[2] pairs, one for each tuple.</span></span><span class="line">  <span class="keyword">int</span> index_size = (attribute_array_length * <span class="number">2</span>);</span><span class="line"></span><span class="line">  Array&lt;u2&gt;* operands = MetadataFactory::new_array&lt;u2&gt;(_loader_data, index_size + operand_count, CHECK);</span><span class="line"></span><span class="line">  <span class="comment">// Eagerly assign operands so they will be deallocated with the constant</span></span><span class="line">  <span class="comment">// pool if there is an error.</span></span><span class="line">  _cp-&gt;set_operands(operands);</span><span class="line"></span><span class="line">  <span class="keyword">int</span> operand_fill_index = index_size;</span><span class="line">  <span class="keyword">int</span> cp_size = _cp-&gt;length();</span><span class="line"></span><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; attribute_array_length; n++) &#123;</span><span class="line">    <span class="comment">// Store a 32-bit offset into the header of the operand array.</span></span><span class="line">    ConstantPool::operand_offset_at_put(operands, n, operand_fill_index);</span><span class="line"></span><span class="line">    <span class="comment">// Read a bootstrap specifier.</span></span><span class="line">    cfs-&gt;guarantee_more(<span class="keyword">sizeof</span>(u2) * <span class="number">2</span>, CHECK);  <span class="comment">// bsm, argc</span></span><span class="line">    u2 bootstrap_method_index = cfs-&gt;get_u2_fast();</span><span class="line">    u2 argument_count = cfs-&gt;get_u2_fast();</span><span class="line">    check_property(</span><span class="line">      valid_cp_range(bootstrap_method_index, cp_size) &amp;&amp;</span><span class="line">      _cp-&gt;tag_at(bootstrap_method_index).is_method_handle(),</span><span class="line">      <span class="string">"bootstrap_method_index %u has bad constant type in class file %s"</span>,</span><span class="line">      bootstrap_method_index,</span><span class="line">      CHECK);</span><span class="line"></span><span class="line">    guarantee_property((operand_fill_index + <span class="number">1</span> + argument_count) &lt; operands-&gt;length(),</span><span class="line">      <span class="string">"Invalid BootstrapMethods num_bootstrap_methods or num_bootstrap_arguments value in class file %s"</span>,</span><span class="line">      CHECK);</span><span class="line"></span><span class="line">    operands-&gt;at_put(operand_fill_index++, bootstrap_method_index);</span><span class="line">    operands-&gt;at_put(operand_fill_index++, argument_count);</span><span class="line"></span><span class="line">    cfs-&gt;guarantee_more(<span class="keyword">sizeof</span>(u2) * argument_count, CHECK);  <span class="comment">// argv[argc]</span></span><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; argument_count; j++) &#123;</span><span class="line">      u2 argument_index = cfs-&gt;get_u2_fast();</span><span class="line">      check_property(</span><span class="line">        valid_cp_range(argument_index, cp_size) &amp;&amp;</span><span class="line">        _cp-&gt;tag_at(argument_index).is_loadable_constant(),</span><span class="line">        <span class="string">"argument_index %u has bad constant type in class file %s"</span>,</span><span class="line">        argument_index,</span><span class="line">        CHECK);</span><span class="line">      operands-&gt;at_put(operand_fill_index++, argument_index);</span><span class="line">    &#125;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  assert(operand_fill_index == operands-&gt;length(), <span class="string">"exact fill"</span>);</span><span class="line"></span><span class="line">  u1* current_end = cfs-&gt;current();</span><span class="line">  guarantee_property(current_end == current_start + attribute_byte_length,</span><span class="line">                     <span class="string">"Bad length on BootstrapMethods in class file %s"</span>,</span><span class="line">                     CHECK);</span><span class="line">&#125;</span></pre></td></tr></table></figure>
<a id="more"></a>
<p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/f3108e56b502/src/share/vm/classfile/classFileParser.cpp" target="_blank" rel="noopener">vm/classfile/classFileParser.cpp</a>第<code>3721</code>行，查看<code>ClassFileParser::parseClassFile</code>方法，源码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">3721</span><span class="line">3722</span><span class="line">3723</span><span class="line">3724</span><span class="line">3725</span><span class="line">3726</span><span class="line">3727</span><span class="line">3728</span><span class="line">3729</span><span class="line">3730</span><span class="line">3731</span><span class="line">3732</span><span class="line">3733</span><span class="line">3734</span><span class="line">3735</span><span class="line">3736</span><span class="line">3737</span><span class="line">3738</span><span class="line">3739</span><span class="line">3740</span><span class="line">3741</span><span class="line">3742</span><span class="line">3743</span><span class="line">3744</span><span class="line">3745</span><span class="line">3746</span><span class="line">3747</span><span class="line">3748</span><span class="line">3749</span><span class="line">3750</span><span class="line">3751</span><span class="line">3752</span><span class="line">3753</span><span class="line">3754</span><span class="line">3755</span><span class="line">3756</span><span class="line">3757</span><span class="line">3758</span><span class="line">3759</span><span class="line">3760</span><span class="line">3761</span><span class="line">3762</span><span class="line">3763</span><span class="line">3764</span><span class="line">3765</span><span class="line">3766</span><span class="line">3767</span><span class="line">3768</span><span class="line">3769</span><span class="line">3770</span><span class="line">3771</span><span class="line">3772</span><span class="line">3773</span><span class="line">3774</span><span class="line">3775</span><span class="line">3776</span><span class="line">3777</span><span class="line">3778</span><span class="line">3779</span><span class="line">3780</span><span class="line">3781</span><span class="line">3782</span><span class="line">3783</span><span class="line">3784</span><span class="line">3785</span><span class="line">3786</span><span class="line">3787</span><span class="line">3788</span><span class="line">3789</span><span class="line">3790</span><span class="line">3791</span><span class="line">3792</span><span class="line">3793</span><span class="line">3794</span><span class="line">3795</span><span class="line">3796</span><span class="line">3797</span><span class="line">3798</span><span class="line">3799</span><span class="line">3800</span><span class="line">3801</span><span class="line">3802</span><span class="line">3803</span><span class="line">3804</span><span class="line">3805</span><span class="line">3806</span><span class="line">3807</span><span class="line">3808</span><span class="line">3809</span><span class="line">3810</span><span class="line">3811</span><span class="line">3812</span><span class="line">3813</span><span class="line">3814</span><span class="line">3815</span><span class="line">3816</span><span class="line">3817</span><span class="line">3818</span><span class="line">3819</span><span class="line">3820</span><span class="line">3821</span><span class="line">3822</span><span class="line">3823</span><span class="line">3824</span><span class="line">3825</span><span class="line">3826</span><span class="line">3827</span><span class="line">3828</span><span class="line">3829</span><span class="line">3830</span><span class="line">3831</span><span class="line">3832</span><span class="line">3833</span><span class="line">3834</span><span class="line">3835</span><span class="line">3836</span><span class="line">3837</span><span class="line">3838</span><span class="line">3839</span><span class="line">3840</span><span class="line">3841</span><span class="line">3842</span><span class="line">3843</span><span class="line">3844</span><span class="line">3845</span><span class="line">3846</span><span class="line">3847</span><span class="line">3848</span><span class="line">3849</span><span class="line">3850</span><span class="line">3851</span><span class="line">3852</span><span class="line">3853</span><span class="line">3854</span><span class="line">3855</span><span class="line">3856</span><span class="line">3857</span><span class="line">3858</span><span class="line">3859</span><span class="line">3860</span><span class="line">3861</span><span class="line">3862</span><span class="line">3863</span><span class="line">3864</span><span class="line">3865</span><span class="line">3866</span><span class="line">3867</span><span class="line">3868</span><span class="line">3869</span><span class="line">3870</span><span class="line">3871</span><span class="line">3872</span><span class="line">3873</span><span class="line">3874</span><span class="line">3875</span><span class="line">3876</span><span class="line">3877</span><span class="line">3878</span><span class="line">3879</span><span class="line">3880</span><span class="line">3881</span><span class="line">3882</span><span class="line">3883</span><span class="line">3884</span><span class="line">3885</span><span class="line">3886</span><span class="line">3887</span><span class="line">3888</span><span class="line">3889</span><span class="line">3890</span><span class="line">3891</span><span class="line">3892</span><span class="line">3893</span><span class="line">3894</span><span class="line">3895</span><span class="line">3896</span><span class="line">3897</span><span class="line">3898</span><span class="line">3899</span><span class="line">3900</span><span class="line">3901</span><span class="line">3902</span><span class="line">3903</span><span class="line">3904</span><span class="line">3905</span><span class="line">3906</span><span class="line">3907</span><span class="line">3908</span><span class="line">3909</span><span class="line">3910</span><span class="line">3911</span><span class="line">3912</span><span class="line">3913</span><span class="line">3914</span><span class="line">3915</span><span class="line">3916</span><span class="line">3917</span><span class="line">3918</span><span class="line">3919</span><span class="line">3920</span><span class="line">3921</span><span class="line">3922</span><span class="line">3923</span><span class="line">3924</span><span class="line">3925</span><span class="line">3926</span><span class="line">3927</span><span class="line">3928</span><span class="line">3929</span><span class="line">3930</span><span class="line">3931</span><span class="line">3932</span><span class="line">3933</span><span class="line">3934</span><span class="line">3935</span><span class="line">3936</span><span class="line">3937</span><span class="line">3938</span><span class="line">3939</span><span class="line">3940</span><span class="line">3941</span><span class="line">3942</span><span class="line">3943</span><span class="line">3944</span><span class="line">3945</span><span class="line">3946</span><span class="line">3947</span><span class="line">3948</span><span class="line">3949</span><span class="line">3950</span><span class="line">3951</span><span class="line">3952</span><span class="line">3953</span><span class="line">3954</span><span class="line">3955</span><span class="line">3956</span><span class="line">3957</span><span class="line">3958</span><span class="line">3959</span><span class="line">3960</span><span class="line">3961</span><span class="line">3962</span><span class="line">3963</span><span class="line">3964</span><span class="line">3965</span><span class="line">3966</span><span class="line">3967</span><span class="line">3968</span><span class="line">3969</span><span class="line">3970</span><span class="line">3971</span><span class="line">3972</span><span class="line">3973</span><span class="line">3974</span><span class="line">3975</span><span class="line">3976</span><span class="line">3977</span><span class="line">3978</span><span class="line">3979</span><span class="line">3980</span><span class="line">3981</span><span class="line">3982</span><span class="line">3983</span><span class="line">3984</span><span class="line">3985</span><span class="line">3986</span><span class="line">3987</span><span class="line">3988</span><span class="line">3989</span><span class="line">3990</span><span class="line">3991</span><span class="line">3992</span><span class="line">3993</span><span class="line">3994</span><span class="line">3995</span><span class="line">3996</span><span class="line">3997</span><span class="line">3998</span><span class="line">3999</span><span class="line">4000</span><span class="line">4001</span><span class="line">4002</span><span class="line">4003</span><span class="line">4004</span><span class="line">4005</span><span class="line">4006</span><span class="line">4007</span><span class="line">4008</span><span class="line">4009</span><span class="line">4010</span><span class="line">4011</span><span class="line">4012</span><span class="line">4013</span><span class="line">4014</span><span class="line">4015</span><span class="line">4016</span><span class="line">4017</span><span class="line">4018</span><span class="line">4019</span><span class="line">4020</span><span class="line">4021</span><span class="line">4022</span><span class="line">4023</span><span class="line">4024</span><span class="line">4025</span><span class="line">4026</span><span class="line">4027</span><span class="line">4028</span><span class="line">4029</span><span class="line">4030</span><span class="line">4031</span><span class="line">4032</span><span class="line">4033</span><span class="line">4034</span><span class="line">4035</span><span class="line">4036</span><span class="line">4037</span><span class="line">4038</span><span class="line">4039</span><span class="line">4040</span><span class="line">4041</span><span class="line">4042</span><span class="line">4043</span><span class="line">4044</span><span class="line">4045</span><span class="line">4046</span><span class="line">4047</span><span class="line">4048</span><span class="line">4049</span><span class="line">4050</span><span class="line">4051</span><span class="line">4052</span><span class="line">4053</span><span class="line">4054</span><span class="line">4055</span><span class="line">4056</span><span class="line">4057</span><span class="line">4058</span><span class="line">4059</span><span class="line">4060</span><span class="line">4061</span><span class="line">4062</span><span class="line">4063</span><span class="line">4064</span><span class="line">4065</span><span class="line">4066</span><span class="line">4067</span><span class="line">4068</span><span class="line">4069</span><span class="line">4070</span><span class="line">4071</span><span class="line">4072</span><span class="line">4073</span><span class="line">4074</span><span class="line">4075</span><span class="line">4076</span><span class="line">4077</span><span class="line">4078</span><span class="line">4079</span><span class="line">4080</span><span class="line">4081</span><span class="line">4082</span><span class="line">4083</span><span class="line">4084</span><span class="line">4085</span><span class="line">4086</span><span class="line">4087</span><span class="line">4088</span><span class="line">4089</span><span class="line">4090</span><span class="line">4091</span><span class="line">4092</span><span class="line">4093</span><span class="line">4094</span><span class="line">4095</span><span class="line">4096</span><span class="line">4097</span><span class="line">4098</span><span class="line">4099</span><span class="line">4100</span><span class="line">4101</span><span class="line">4102</span><span class="line">4103</span><span class="line">4104</span><span class="line">4105</span><span class="line">4106</span><span class="line">4107</span><span class="line">4108</span><span class="line">4109</span><span class="line">4110</span><span class="line">4111</span><span class="line">4112</span><span class="line">4113</span><span class="line">4114</span><span class="line">4115</span><span class="line">4116</span><span class="line">4117</span><span class="line">4118</span><span class="line">4119</span><span class="line">4120</span><span class="line">4121</span><span class="line">4122</span><span class="line">4123</span><span class="line">4124</span><span class="line">4125</span><span class="line">4126</span><span class="line">4127</span><span class="line">4128</span><span class="line">4129</span><span class="line">4130</span><span class="line">4131</span><span class="line">4132</span><span class="line">4133</span><span class="line">4134</span><span class="line">4135</span><span class="line">4136</span><span class="line">4137</span><span class="line">4138</span><span class="line">4139</span><span class="line">4140</span><span class="line">4141</span><span class="line">4142</span><span class="line">4143</span><span class="line">4144</span><span class="line">4145</span><span class="line">4146</span><span class="line">4147</span><span class="line">4148</span><span class="line">4149</span><span class="line">4150</span><span class="line">4151</span><span class="line">4152</span><span class="line">4153</span><span class="line">4154</span><span class="line">4155</span><span class="line">4156</span><span class="line">4157</span><span class="line">4158</span><span class="line">4159</span><span class="line">4160</span><span class="line">4161</span><span class="line">4162</span><span class="line">4163</span><span class="line">4164</span><span class="line">4165</span><span class="line">4166</span><span class="line">4167</span><span class="line">4168</span><span class="line">4169</span><span class="line">4170</span><span class="line">4171</span><span class="line">4172</span><span class="line">4173</span><span class="line">4174</span><span class="line">4175</span><span class="line">4176</span><span class="line">4177</span><span class="line">4178</span><span class="line">4179</span><span class="line">4180</span><span class="line">4181</span><span class="line">4182</span><span class="line">4183</span><span class="line">4184</span><span class="line">4185</span><span class="line">4186</span><span class="line">4187</span><span class="line">4188</span><span class="line">4189</span><span class="line">4190</span><span class="line">4191</span><span class="line">4192</span><span class="line">4193</span><span class="line">4194</span><span class="line">4195</span><span class="line">4196</span><span class="line">4197</span><span class="line">4198</span><span class="line">4199</span><span class="line">4200</span><span class="line">4201</span><span class="line">4202</span><span class="line">4203</span><span class="line">4204</span><span class="line">4205</span><span class="line">4206</span><span class="line">4207</span><span class="line">4208</span><span class="line">4209</span><span class="line">4210</span><span class="line">4211</span><span class="line">4212</span><span class="line">4213</span><span class="line">4214</span><span class="line">4215</span><span class="line">4216</span><span class="line">4217</span><span class="line">4218</span><span class="line">4219</span><span class="line">4220</span><span class="line">4221</span><span class="line">4222</span><span class="line">4223</span><span class="line">4224</span><span class="line">4225</span><span class="line">4226</span><span class="line">4227</span><span class="line">4228</span><span class="line">4229</span><span class="line">4230</span><span class="line">4231</span><span class="line">4232</span><span class="line">4233</span><span class="line">4234</span><span class="line">4235</span><span class="line">4236</span><span class="line">4237</span><span class="line">4238</span><span class="line">4239</span><span class="line">4240</span><span class="line">4241</span><span class="line">4242</span><span class="line">4243</span><span class="line">4244</span><span class="line">4245</span><span class="line">4246</span><span class="line">4247</span><span class="line">4248</span><span class="line">4249</span><span class="line">4250</span><span class="line">4251</span><span class="line">4252</span><span class="line">4253</span><span class="line">4254</span><span class="line">4255</span><span class="line">4256</span><span class="line">4257</span><span class="line">4258</span><span class="line">4259</span><span class="line">4260</span><span class="line">4261</span><span class="line">4262</span><span class="line">4263</span><span class="line">4264</span><span class="line">4265</span><span class="line">4266</span><span class="line">4267</span><span class="line">4268</span><span class="line">4269</span><span class="line">4270</span><span class="line">4271</span><span class="line">4272</span><span class="line">4273</span><span class="line">4274</span><span class="line">4275</span><span class="line">4276</span></pre></td><td class="code"><pre><span class="line"><span class="function">instanceKlassHandle <span class="title">ClassFileParser::parseClassFile</span><span class="params">(Symbol* name,</span></span></span><span class="line"><span class="function"><span class="params">                                                    ClassLoaderData* loader_data,</span></span></span><span class="line"><span class="function"><span class="params">                                                    Handle protection_domain,</span></span></span><span class="line"><span class="function"><span class="params">                                                    KlassHandle host_klass,</span></span></span><span class="line"><span class="function"><span class="params">                                                    GrowableArray&lt;Handle&gt;* cp_patches,</span></span></span><span class="line"><span class="function"><span class="params">                                                    TempNewSymbol&amp; parsed_name,</span></span></span><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">bool</span> verify,</span></span></span><span class="line"><span class="function"><span class="params">                                                    TRAPS)</span> </span>&#123;</span><span class="line"></span><span class="line">  <span class="comment">// When a retransformable agent is attached, JVMTI caches the</span></span><span class="line">  <span class="comment">// class bytes that existed before the first retransformation.</span></span><span class="line">  <span class="comment">// If RedefineClasses() was used before the retransformable</span></span><span class="line">  <span class="comment">// agent attached, then the cached class bytes may not be the</span></span><span class="line">  <span class="comment">// original class bytes.</span></span><span class="line">  JvmtiCachedClassFileData *cached_class_file = <span class="literal">NULL</span>;</span><span class="line">  <span class="function">Handle <span class="title">class_loader</span><span class="params">(THREAD, loader_data-&gt;class_loader())</span></span>;</span><span class="line">  <span class="keyword">bool</span> has_default_methods = <span class="literal">false</span>;</span><span class="line">  <span class="keyword">bool</span> declares_default_methods = <span class="literal">false</span>;</span><span class="line">  <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><span class="line"></span><span class="line">  ClassFileStream* cfs = stream();</span><span class="line">  <span class="comment">// Timing</span></span><span class="line">  assert(THREAD-&gt;is_Java_thread(), <span class="string">"must be a JavaThread"</span>);</span><span class="line">  JavaThread* jt = (JavaThread*) THREAD;</span><span class="line"></span><span class="line">  <span class="function">PerfClassTraceTime <span class="title">ctimer</span><span class="params">(ClassLoader::perf_class_parse_time(),</span></span></span><span class="line"><span class="function"><span class="params">                            ClassLoader::perf_class_parse_selftime(),</span></span></span><span class="line"><span class="function"><span class="params">                            <span class="literal">NULL</span>,</span></span></span><span class="line"><span class="function"><span class="params">                            jt-&gt;get_thread_stat()-&gt;perf_recursion_counts_addr(),</span></span></span><span class="line"><span class="function"><span class="params">                            jt-&gt;get_thread_stat()-&gt;perf_timers_addr(),</span></span></span><span class="line"><span class="function"><span class="params">                            PerfClassTraceTime::PARSE_CLASS)</span></span>;</span><span class="line"></span><span class="line">  init_parsed_class_attributes(loader_data);</span><span class="line"></span><span class="line">  <span class="keyword">if</span> (JvmtiExport::should_post_class_file_load_hook()) &#123;</span><span class="line">    <span class="comment">// Get the cached class file bytes (if any) from the class that</span></span><span class="line">    <span class="comment">// is being redefined or retransformed. We use jvmti_thread_state()</span></span><span class="line">    <span class="comment">// instead of JvmtiThreadState::state_for(jt) so we don't allocate</span></span><span class="line">    <span class="comment">// a JvmtiThreadState any earlier than necessary. This will help</span></span><span class="line">    <span class="comment">// avoid the bug described by 7126851.</span></span><span class="line">    JvmtiThreadState *state = jt-&gt;jvmti_thread_state();</span><span class="line">    <span class="keyword">if</span> (state != <span class="literal">NULL</span>) &#123;</span><span class="line">      KlassHandle *h_class_being_redefined =</span><span class="line">                     state-&gt;get_class_being_redefined();</span><span class="line">      <span class="keyword">if</span> (h_class_being_redefined != <span class="literal">NULL</span>) &#123;</span><span class="line">        instanceKlassHandle ikh_class_being_redefined =</span><span class="line">          instanceKlassHandle(THREAD, (*h_class_being_redefined)());</span><span class="line">        cached_class_file = ikh_class_being_redefined-&gt;get_cached_class_file();</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* ptr = cfs-&gt;buffer();</span><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* end_ptr = cfs-&gt;buffer() + cfs-&gt;length();</span><span class="line"></span><span class="line">    JvmtiExport::post_class_file_load_hook(name, class_loader(), protection_domain,</span><span class="line">                                           &amp;ptr, &amp;end_ptr, &amp;cached_class_file);</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (ptr != cfs-&gt;buffer()) &#123;</span><span class="line">      <span class="comment">// JVMTI agent has modified class file data.</span></span><span class="line">      <span class="comment">// Set new class file stream using JVMTI agent modified</span></span><span class="line">      <span class="comment">// class file data.</span></span><span class="line">      cfs = <span class="keyword">new</span> ClassFileStream(ptr, end_ptr - ptr, cfs-&gt;source());</span><span class="line">      set_stream(cfs);</span><span class="line">    &#125;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  _host_klass = host_klass;</span><span class="line">  _cp_patches = cp_patches;</span><span class="line"></span><span class="line">  instanceKlassHandle nullHandle;</span><span class="line"></span><span class="line">  <span class="comment">// Figure out whether we can skip format checking (matching classic VM behavior)</span></span><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces) &#123;</span><span class="line">    <span class="comment">// verify == true means it's a 'remote' class (i.e., non-boot class)</span></span><span class="line">    <span class="comment">// Verification decision is based on BytecodeVerificationRemote flag</span></span><span class="line">    <span class="comment">// for those classes.</span></span><span class="line">    _need_verify = (verify) ? BytecodeVerificationRemote :</span><span class="line">                              BytecodeVerificationLocal;</span><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><span class="line">    _need_verify = Verifier::should_verify_for(class_loader(), verify);</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Set the verify flag in stream</span></span><span class="line">  cfs-&gt;set_verify(_need_verify);</span><span class="line"></span><span class="line">  <span class="comment">// Save the class file name for easier error message printing.</span></span><span class="line">  _class_name = (name != <span class="literal">NULL</span>) ? name : vmSymbols::unknown_class_name();</span><span class="line"></span><span class="line">  cfs-&gt;guarantee_more(<span class="number">8</span>, CHECK_(nullHandle));  <span class="comment">// magic, major, minor</span></span><span class="line">  <span class="comment">// Magic value</span></span><span class="line">  u4 magic = cfs-&gt;get_u4_fast();</span><span class="line">  guarantee_property(magic == JAVA_CLASSFILE_MAGIC,</span><span class="line">                     <span class="string">"Incompatible magic value %u in class file %s"</span>,</span><span class="line">                     magic, CHECK_(nullHandle));</span><span class="line"></span><span class="line">  <span class="comment">// Version numbers</span></span><span class="line">  u2 minor_version = cfs-&gt;get_u2_fast();</span><span class="line">  u2 major_version = cfs-&gt;get_u2_fast();</span><span class="line"></span><span class="line">  <span class="keyword">if</span> (DumpSharedSpaces &amp;&amp; major_version &lt; JAVA_1_5_VERSION) &#123;</span><span class="line">    ResourceMark rm;</span><span class="line">    warning(<span class="string">"Pre JDK 1.5 class not supported by CDS: %u.%u %s"</span>,</span><span class="line">            major_version,  minor_version, name-&gt;as_C_string());</span><span class="line">    Exceptions::fthrow(</span><span class="line">      THREAD_AND_LOCATION,</span><span class="line">      vmSymbols::java_lang_UnsupportedClassVersionError(),</span><span class="line">      <span class="string">"Unsupported major.minor version for dump time %u.%u"</span>,</span><span class="line">      major_version,</span><span class="line">      minor_version);</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Check version numbers - we check this even with verifier off</span></span><span class="line">  <span class="keyword">if</span> (!is_supported_version(major_version, minor_version)) &#123;</span><span class="line">    <span class="keyword">if</span> (name == <span class="literal">NULL</span>) &#123;</span><span class="line">      Exceptions::fthrow(</span><span class="line">        THREAD_AND_LOCATION,</span><span class="line">        vmSymbols::java_lang_UnsupportedClassVersionError(),</span><span class="line">        <span class="string">"Unsupported class file version %u.%u, "</span></span><span class="line">        <span class="string">"this version of the Java Runtime only recognizes class file versions up to %u.%u"</span>,</span><span class="line">        major_version,</span><span class="line">        minor_version,</span><span class="line">        JAVA_MAX_SUPPORTED_VERSION,</span><span class="line">        JAVA_MAX_SUPPORTED_MINOR_VERSION);</span><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><span class="line">      ResourceMark rm(THREAD);</span><span class="line">      Exceptions::fthrow(</span><span class="line">        THREAD_AND_LOCATION,</span><span class="line">        vmSymbols::java_lang_UnsupportedClassVersionError(),</span><span class="line">        <span class="string">"%s has been compiled by a more recent version of the Java Runtime (class file version %u.%u), "</span></span><span class="line">        <span class="string">"this version of the Java Runtime only recognizes class file versions up to %u.%u"</span>,</span><span class="line">        name-&gt;as_C_string(),</span><span class="line">        major_version,</span><span class="line">        minor_version,</span><span class="line">        JAVA_MAX_SUPPORTED_VERSION,</span><span class="line">        JAVA_MAX_SUPPORTED_MINOR_VERSION);</span><span class="line">    &#125;</span><span class="line">    <span class="keyword">return</span> nullHandle;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  _major_version = major_version;</span><span class="line">  _minor_version = minor_version;</span><span class="line"></span><span class="line"></span><span class="line">  <span class="comment">// Check if verification needs to be relaxed for this class file</span></span><span class="line">  <span class="comment">// Do not restrict it to jdk1.0 or jdk1.1 to maintain backward compatibility (4982376)</span></span><span class="line">  _relax_verify = Verifier::relax_verify_for(class_loader());</span><span class="line"></span><span class="line">  <span class="comment">// Constant pool</span></span><span class="line">  constantPoolHandle cp = parse_constant_pool(CHECK_(nullHandle));</span><span class="line"></span><span class="line">  <span class="keyword">int</span> cp_size = cp-&gt;length();</span><span class="line"></span><span class="line">  cfs-&gt;guarantee_more(<span class="number">8</span>, CHECK_(nullHandle));  <span class="comment">// flags, this_class, super_class, infs_len</span></span><span class="line"></span><span class="line">  <span class="comment">// Access flags</span></span><span class="line">  AccessFlags access_flags;</span><span class="line">  jint flags = cfs-&gt;get_u2_fast() &amp; JVM_RECOGNIZED_CLASS_MODIFIERS;</span><span class="line"></span><span class="line">  <span class="keyword">if</span> ((flags &amp; JVM_ACC_INTERFACE) &amp;&amp; _major_version &lt; JAVA_6_VERSION) &#123;</span><span class="line">    <span class="comment">// Set abstract bit for old class files for backward compatibility</span></span><span class="line">    flags |= JVM_ACC_ABSTRACT;</span><span class="line">  &#125;</span><span class="line">  verify_legal_class_modifiers(flags, CHECK_(nullHandle));</span><span class="line">  access_flags.set_flags(flags);</span><span class="line"></span><span class="line">  <span class="comment">// This class and superclass</span></span><span class="line">  u2 this_class_index = cfs-&gt;get_u2_fast();</span><span class="line">  check_property(</span><span class="line">    valid_cp_range(this_class_index, cp_size) &amp;&amp;</span><span class="line">      cp-&gt;tag_at(this_class_index).is_unresolved_klass(),</span><span class="line">    <span class="string">"Invalid this class index %u in constant pool in class file %s"</span>,</span><span class="line">    this_class_index, CHECK_(nullHandle));</span><span class="line"></span><span class="line">  Symbol*  class_name  = cp-&gt;unresolved_klass_at(this_class_index);</span><span class="line">  assert(class_name != <span class="literal">NULL</span>, <span class="string">"class_name can't be null"</span>);</span><span class="line"></span><span class="line">  <span class="comment">// It's important to set parsed_name *before* resolving the super class.</span></span><span class="line">  <span class="comment">// (it's used for cleanup by the caller if parsing fails)</span></span><span class="line">  parsed_name = class_name;</span><span class="line">  <span class="comment">// parsed_name is returned and can be used if there's an error, so add to</span></span><span class="line">  <span class="comment">// its reference count.  Caller will decrement the refcount.</span></span><span class="line">  parsed_name-&gt;increment_refcount();</span><span class="line"></span><span class="line">  <span class="comment">// Update _class_name which could be null previously to be class_name</span></span><span class="line">  _class_name = class_name;</span><span class="line"></span><span class="line">  <span class="comment">// Don't need to check whether this class name is legal or not.</span></span><span class="line">  <span class="comment">// It has been checked when constant pool is parsed.</span></span><span class="line">  <span class="comment">// However, make sure it is not an array type.</span></span><span class="line">  <span class="keyword">if</span> (_need_verify) &#123;</span><span class="line">    guarantee_property(class_name-&gt;byte_at(<span class="number">0</span>) != JVM_SIGNATURE_ARRAY,</span><span class="line">                       <span class="string">"Bad class name in class file %s"</span>,</span><span class="line">                       CHECK_(nullHandle));</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  Klass* preserve_this_klass;   <span class="comment">// for storing result across HandleMark</span></span><span class="line"></span><span class="line">  <span class="comment">// release all handles when parsing is done</span></span><span class="line">  &#123; <span class="function">HandleMark <span class="title">hm</span><span class="params">(THREAD)</span></span>;</span><span class="line"></span><span class="line">    <span class="comment">// Checks if name in class file matches requested name</span></span><span class="line">    <span class="keyword">if</span> (name != <span class="literal">NULL</span> &amp;&amp; class_name != name) &#123;</span><span class="line">      <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><span class="line">      Exceptions::fthrow(</span><span class="line">        THREAD_AND_LOCATION,</span><span class="line">        vmSymbols::java_lang_NoClassDefFoundError(),</span><span class="line">        <span class="string">"%s (wrong name: %s)"</span>,</span><span class="line">        name-&gt;as_C_string(),</span><span class="line">        class_name-&gt;as_C_string()</span><span class="line">      );</span><span class="line">      <span class="keyword">return</span> nullHandle;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (TraceClassLoadingPreorder) &#123;</span><span class="line">      tty-&gt;print(<span class="string">"[Loading %s"</span>, (name != <span class="literal">NULL</span>) ? name-&gt;as_klass_external_name() : <span class="string">"NoName"</span>);</span><span class="line">      <span class="keyword">if</span> (cfs-&gt;source() != <span class="literal">NULL</span>) tty-&gt;print(<span class="string">" from %s"</span>, cfs-&gt;source());</span><span class="line">      tty-&gt;print_cr(<span class="string">"]"</span>);</span><span class="line">    &#125;</span><span class="line"><span class="meta">#<span class="meta-keyword">if</span> INCLUDE_CDS</span></span><span class="line">    <span class="keyword">if</span> (DumpLoadedClassList != <span class="literal">NULL</span> &amp;&amp; cfs-&gt;source() != <span class="literal">NULL</span> &amp;&amp; classlist_file-&gt;is_open()) &#123;</span><span class="line">      <span class="comment">// Only dump the classes that can be stored into CDS archive</span></span><span class="line">      <span class="keyword">if</span> (SystemDictionaryShared::is_sharing_possible(loader_data)) &#123;</span><span class="line">        <span class="keyword">if</span> (name != <span class="literal">NULL</span>) &#123;</span><span class="line">          <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><span class="line">          classlist_file-&gt;print_cr(<span class="string">"%s"</span>, name-&gt;as_C_string());</span><span class="line">          classlist_file-&gt;flush();</span><span class="line">        &#125;</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><span class="line"></span><span class="line">    u2 super_class_index = cfs-&gt;get_u2_fast();</span><span class="line">    instanceKlassHandle super_klass = parse_super_class(super_class_index,</span><span class="line">                                                        CHECK_NULL);</span><span class="line"></span><span class="line">    <span class="comment">// Interfaces</span></span><span class="line">    u2 itfs_len = cfs-&gt;get_u2_fast();</span><span class="line">    Array&lt;Klass*&gt;* local_interfaces =</span><span class="line">      parse_interfaces(itfs_len, protection_domain, _class_name,</span><span class="line">                       &amp;has_default_methods, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    u2 java_fields_count = <span class="number">0</span>;</span><span class="line">    <span class="comment">// Fields (offsets are filled in later)</span></span><span class="line">    FieldAllocationCount fac;</span><span class="line">    Array&lt;u2&gt;* fields = parse_fields(class_name,</span><span class="line">                                     access_flags.is_interface(),</span><span class="line">                                     &amp;fac, &amp;java_fields_count,</span><span class="line">                                     CHECK_(nullHandle));</span><span class="line">    <span class="comment">// Methods</span></span><span class="line">    <span class="keyword">bool</span> has_final_method = <span class="literal">false</span>;</span><span class="line">    AccessFlags promoted_flags;</span><span class="line">    promoted_flags.set_flags(<span class="number">0</span>);</span><span class="line">    Array&lt;Method*&gt;* methods = parse_methods(access_flags.is_interface(),</span><span class="line">                                            &amp;promoted_flags,</span><span class="line">                                            &amp;has_final_method,</span><span class="line">                                            &amp;declares_default_methods,</span><span class="line">                                            CHECK_(nullHandle));</span><span class="line">    <span class="keyword">if</span> (declares_default_methods) &#123;</span><span class="line">      has_default_methods = <span class="literal">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// Additional attributes</span></span><span class="line">    ClassAnnotationCollector parsed_annotations;</span><span class="line">    parse_classfile_attributes(&amp;parsed_annotations, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// Finalize the Annotations metadata object,</span></span><span class="line">    <span class="comment">// now that all annotation arrays have been created.</span></span><span class="line">    create_combined_annotations(CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// Make sure this is the end of class file stream</span></span><span class="line">    guarantee_property(cfs-&gt;at_eos(), <span class="string">"Extra bytes at the end of class file %s"</span>, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (_class_name == vmSymbols::java_lang_Object()) &#123;</span><span class="line">      check_property(_local_interfaces == Universe::the_empty_klass_array(),</span><span class="line">                     <span class="string">"java.lang.Object cannot implement an interface in class file %s"</span>,</span><span class="line">                     CHECK_(nullHandle));</span><span class="line">    &#125;</span><span class="line">    <span class="comment">// We check super class after class file is parsed and format is checked</span></span><span class="line">    <span class="keyword">if</span> (super_class_index &gt; <span class="number">0</span> &amp;&amp; super_klass.is_null()) &#123;</span><span class="line">      Symbol*  sk  = cp-&gt;klass_name_at(super_class_index);</span><span class="line">      <span class="keyword">if</span> (access_flags.is_interface()) &#123;</span><span class="line">        <span class="comment">// Before attempting to resolve the superclass, check for class format</span></span><span class="line">        <span class="comment">// errors not checked yet.</span></span><span class="line">        guarantee_property(sk == vmSymbols::java_lang_Object(),</span><span class="line">                           <span class="string">"Interfaces must have java.lang.Object as superclass in class file %s"</span>,</span><span class="line">                           CHECK_(nullHandle));</span><span class="line">      &#125;</span><span class="line">      Klass* k = SystemDictionary::resolve_super_or_fail(class_name, sk,</span><span class="line">                                                         class_loader,</span><span class="line">                                                         protection_domain,</span><span class="line">                                                         <span class="literal">true</span>,</span><span class="line">                                                         CHECK_(nullHandle));</span><span class="line"></span><span class="line">      <span class="function">KlassHandle <span class="title">kh</span> <span class="params">(THREAD, k)</span></span>;</span><span class="line">      super_klass = instanceKlassHandle(THREAD, kh());</span><span class="line">    &#125;</span><span class="line">    <span class="keyword">if</span> (super_klass.not_null()) &#123;</span><span class="line"></span><span class="line">      <span class="keyword">if</span> (super_klass-&gt;has_default_methods()) &#123;</span><span class="line">        has_default_methods = <span class="literal">true</span>;</span><span class="line">      &#125;</span><span class="line"></span><span class="line">      <span class="keyword">if</span> (super_klass-&gt;is_interface()) &#123;</span><span class="line">        <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><span class="line">        Exceptions::fthrow(</span><span class="line">          THREAD_AND_LOCATION,</span><span class="line">          vmSymbols::java_lang_IncompatibleClassChangeError(),</span><span class="line">          <span class="string">"class %s has interface %s as super class"</span>,</span><span class="line">          class_name-&gt;as_klass_external_name(),</span><span class="line">          super_klass-&gt;external_name()</span><span class="line">        );</span><span class="line">        <span class="keyword">return</span> nullHandle;</span><span class="line">      &#125;</span><span class="line">      <span class="comment">// Make sure super class is not final</span></span><span class="line">      <span class="keyword">if</span> (super_klass-&gt;is_final()) &#123;</span><span class="line">        THROW_MSG_(vmSymbols::java_lang_VerifyError(), <span class="string">"Cannot inherit from final class"</span>, nullHandle);</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// save super klass for error handling.</span></span><span class="line">    _super_klass = super_klass;</span><span class="line"></span><span class="line">    <span class="comment">// Compute the transitive list of all unique interfaces implemented by this class</span></span><span class="line">    _transitive_interfaces =</span><span class="line">          compute_transitive_interfaces(super_klass, local_interfaces, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// sort methods</span></span><span class="line">    intArray* method_ordering = sort_methods(methods);</span><span class="line"></span><span class="line">    <span class="comment">// promote flags from parse_methods() to the klass' flags</span></span><span class="line">    access_flags.add_promoted_flags(promoted_flags.as_int());</span><span class="line"></span><span class="line">    <span class="comment">// Size of Java vtable (in words)</span></span><span class="line">    <span class="keyword">int</span> vtable_size = <span class="number">0</span>;</span><span class="line">    <span class="keyword">int</span> itable_size = <span class="number">0</span>;</span><span class="line">    <span class="keyword">int</span> num_miranda_methods = <span class="number">0</span>;</span><span class="line"></span><span class="line">    <span class="function">GrowableArray&lt;Method*&gt; <span class="title">all_mirandas</span><span class="params">(<span class="number">20</span>)</span></span>;</span><span class="line"></span><span class="line">    klassVtable::compute_vtable_size_and_num_mirandas(</span><span class="line">        &amp;vtable_size, &amp;num_miranda_methods, &amp;all_mirandas, super_klass(), methods,</span><span class="line">        access_flags, class_loader, class_name, local_interfaces,</span><span class="line">                                                      CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// Size of Java itable (in words)</span></span><span class="line">    itable_size = access_flags.is_interface() ? <span class="number">0</span> : klassItable::compute_itable_size(_transitive_interfaces);</span><span class="line"></span><span class="line">    FieldLayoutInfo info;</span><span class="line">    layout_fields(class_loader, &amp;fac, &amp;parsed_annotations, &amp;info, CHECK_NULL);</span><span class="line"></span><span class="line">    <span class="keyword">int</span> total_oop_map_size2 =</span><span class="line">          InstanceKlass::nonstatic_oop_map_size(info.total_oop_map_count);</span><span class="line"></span><span class="line">    <span class="comment">// Compute reference type</span></span><span class="line">    ReferenceType rt;</span><span class="line">    <span class="keyword">if</span> (super_klass() == <span class="literal">NULL</span>) &#123;</span><span class="line">      rt = REF_NONE;</span><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><span class="line">      rt = super_klass-&gt;reference_type();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// We can now create the basic Klass* for this klass</span></span><span class="line">    _klass = InstanceKlass::allocate_instance_klass(loader_data,</span><span class="line">                                                    vtable_size,</span><span class="line">                                                    itable_size,</span><span class="line">                                                    info.static_field_size,</span><span class="line">                                                    total_oop_map_size2,</span><span class="line">                                                    rt,</span><span class="line">                                                    access_flags,</span><span class="line">                                                    name,</span><span class="line">                                                    super_klass(),</span><span class="line">                                                    !host_klass.is_null(),</span><span class="line">                                                    CHECK_(nullHandle));</span><span class="line">    <span class="function">instanceKlassHandle <span class="title">this_klass</span> <span class="params">(THREAD, _klass)</span></span>;</span><span class="line"></span><span class="line">    assert(this_klass-&gt;static_field_size() == info.static_field_size, <span class="string">"sanity"</span>);</span><span class="line">    assert(this_klass-&gt;nonstatic_oop_map_count() == info.total_oop_map_count,</span><span class="line">           <span class="string">"sanity"</span>);</span><span class="line"></span><span class="line">    <span class="comment">// Fill in information already parsed</span></span><span class="line">    this_klass-&gt;set_should_verify_class(verify);</span><span class="line">    jint lh = Klass::instance_layout_helper(info.instance_size, <span class="literal">false</span>);</span><span class="line">    this_klass-&gt;set_layout_helper(lh);</span><span class="line">    assert(this_klass-&gt;oop_is_instance(), <span class="string">"layout is correct"</span>);</span><span class="line">    assert(this_klass-&gt;size_helper() == info.instance_size, <span class="string">"correct size_helper"</span>);</span><span class="line">    <span class="comment">// Not yet: supers are done below to support the new subtype-checking fields</span></span><span class="line">    <span class="comment">//this_klass-&gt;set_super(super_klass());</span></span><span class="line">    this_klass-&gt;set_class_loader_data(loader_data);</span><span class="line">    this_klass-&gt;set_nonstatic_field_size(info.nonstatic_field_size);</span><span class="line">    this_klass-&gt;set_has_nonstatic_fields(info.has_nonstatic_fields);</span><span class="line">    this_klass-&gt;set_static_oop_field_count(fac.count[STATIC_OOP]);</span><span class="line"></span><span class="line">    apply_parsed_class_metadata(this_klass, java_fields_count, CHECK_NULL);</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (has_final_method) &#123;</span><span class="line">      this_klass-&gt;set_has_final_method();</span><span class="line">    &#125;</span><span class="line">    this_klass-&gt;copy_method_ordering(method_ordering, CHECK_NULL);</span><span class="line">    <span class="comment">// The InstanceKlass::_methods_jmethod_ids cache</span></span><span class="line">    <span class="comment">// is managed on the assumption that the initial cache</span></span><span class="line">    <span class="comment">// size is equal to the number of methods in the class. If</span></span><span class="line">    <span class="comment">// that changes, then InstanceKlass::idnum_can_increment()</span></span><span class="line">    <span class="comment">// has to be changed accordingly.</span></span><span class="line">    this_klass-&gt;set_initial_method_idnum(methods-&gt;length());</span><span class="line">    this_klass-&gt;set_name(cp-&gt;klass_name_at(this_class_index));</span><span class="line">    <span class="keyword">if</span> (is_anonymous())  <span class="comment">// I am well known to myself</span></span><span class="line">      cp-&gt;klass_at_put(this_class_index, this_klass()); <span class="comment">// eagerly resolve</span></span><span class="line"></span><span class="line">    this_klass-&gt;set_minor_version(minor_version);</span><span class="line">    this_klass-&gt;set_major_version(major_version);</span><span class="line">    this_klass-&gt;set_has_default_methods(has_default_methods);</span><span class="line">    this_klass-&gt;set_declares_default_methods(declares_default_methods);</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (!host_klass.is_null()) &#123;</span><span class="line">      assert (this_klass-&gt;is_anonymous(), <span class="string">"should be the same"</span>);</span><span class="line">      this_klass-&gt;set_host_klass(host_klass());</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// Set up Method*::intrinsic_id as soon as we know the names of methods.</span></span><span class="line">    <span class="comment">// (We used to do this lazily, but now we query it in Rewriter,</span></span><span class="line">    <span class="comment">// which is eagerly done for every method, so we might as well do it now,</span></span><span class="line">    <span class="comment">// when everything is fresh in memory.)</span></span><span class="line">    <span class="keyword">if</span> (Method::klass_id_for_intrinsics(this_klass()) != vmSymbols::NO_SID) &#123;</span><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; methods-&gt;length(); j++) &#123;</span><span class="line">        methods-&gt;at(j)-&gt;init_intrinsic_id();</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (cached_class_file != <span class="literal">NULL</span>) &#123;</span><span class="line">      <span class="comment">// JVMTI: we have an InstanceKlass now, tell it about the cached bytes</span></span><span class="line">      this_klass-&gt;set_cached_class_file(cached_class_file);</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// Fill in field values obtained by parse_classfile_attributes</span></span><span class="line">    <span class="keyword">if</span> (parsed_annotations.has_any_annotations())</span><span class="line">      parsed_annotations.apply_to(this_klass);</span><span class="line">    apply_parsed_class_attributes(this_klass);</span><span class="line"></span><span class="line">    <span class="comment">// Miranda methods</span></span><span class="line">    <span class="keyword">if</span> ((num_miranda_methods &gt; <span class="number">0</span>) ||</span><span class="line">        <span class="comment">// if this class introduced new miranda methods or</span></span><span class="line">        (super_klass.not_null() &amp;&amp; (super_klass-&gt;has_miranda_methods()))</span><span class="line">        <span class="comment">// super class exists and this class inherited miranda methods</span></span><span class="line">        ) &#123;</span><span class="line">      this_klass-&gt;set_has_miranda_methods(); <span class="comment">// then set a flag</span></span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// Fill in information needed to compute superclasses.</span></span><span class="line">    this_klass-&gt;initialize_supers(super_klass(), CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// Initialize itable offset tables</span></span><span class="line">    klassItable::setup_itable_offset_table(this_klass);</span><span class="line"></span><span class="line">    <span class="comment">// Compute transitive closure of interfaces this class implements</span></span><span class="line">    <span class="comment">// Do final class setup</span></span><span class="line">    fill_oop_maps(this_klass, info.nonstatic_oop_map_count, info.nonstatic_oop_offsets, info.nonstatic_oop_counts);</span><span class="line"></span><span class="line">    <span class="comment">// Fill in has_finalizer, has_vanilla_constructor, and layout_helper</span></span><span class="line">    set_precomputed_flags(this_klass);</span><span class="line"></span><span class="line">    <span class="comment">// reinitialize modifiers, using the InnerClasses attribute</span></span><span class="line">    <span class="keyword">int</span> computed_modifiers = this_klass-&gt;compute_modifier_flags(CHECK_(nullHandle));</span><span class="line">    this_klass-&gt;set_modifier_flags(computed_modifiers);</span><span class="line"></span><span class="line">    <span class="comment">// check if this class can access its super class</span></span><span class="line">    check_super_class_access(this_klass, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// check if this class can access its superinterfaces</span></span><span class="line">    check_super_interface_access(this_klass, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// check if this class overrides any final method</span></span><span class="line">    check_final_method_override(this_klass, CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// check that if this class is an interface then it doesn't have static methods</span></span><span class="line">    <span class="keyword">if</span> (this_klass-&gt;is_interface()) &#123;</span><span class="line">      <span class="comment">/* An interface in a JAVA 8 classfile can be static */</span></span><span class="line">      <span class="keyword">if</span> (_major_version &lt; JAVA_8_VERSION) &#123;</span><span class="line">        check_illegal_static_method(this_klass, CHECK_(nullHandle));</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// Allocate mirror and initialize static fields</span></span><span class="line">    java_lang_Class::create_mirror(this_klass, class_loader, protection_domain,</span><span class="line">                                   CHECK_(nullHandle));</span><span class="line"></span><span class="line">    <span class="comment">// Generate any default methods - default methods are interface methods</span></span><span class="line">    <span class="comment">// that have a default implementation.  This is new with Lambda project.</span></span><span class="line">    <span class="keyword">if</span> (has_default_methods ) &#123;</span><span class="line">      DefaultMethods::generate_default_methods(</span><span class="line">          this_klass(), &amp;all_mirandas, CHECK_(nullHandle));</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// Update the loader_data graph.</span></span><span class="line">    record_defined_class_dependencies(this_klass, CHECK_NULL);</span><span class="line"></span><span class="line">    ClassLoadingService::notify_class_loaded(InstanceKlass::cast(this_klass()),</span><span class="line">                                             <span class="literal">false</span> <span class="comment">/* not shared class */</span>);</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (TraceClassLoading) &#123;</span><span class="line">      ResourceMark rm;</span><span class="line">      <span class="comment">// print in a single call to reduce interleaving of output</span></span><span class="line">      <span class="keyword">if</span> (cfs-&gt;source() != <span class="literal">NULL</span>) &#123;</span><span class="line">        tty-&gt;print(<span class="string">"[Loaded %s from %s]\n"</span>, this_klass-&gt;external_name(),</span><span class="line">                   cfs-&gt;source());</span><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (class_loader.is_null()) &#123;</span><span class="line">        Klass* caller =</span><span class="line">            THREAD-&gt;is_Java_thread()</span><span class="line">                ? ((JavaThread*)THREAD)-&gt;security_get_caller_class(<span class="number">1</span>)</span><span class="line">                : <span class="literal">NULL</span>;</span><span class="line">        <span class="comment">// caller can be NULL, for example, during a JVMTI VM_Init hook</span></span><span class="line">        <span class="keyword">if</span> (caller != <span class="literal">NULL</span>) &#123;</span><span class="line">          tty-&gt;print(<span class="string">"[Loaded %s by instance of %s]\n"</span>,</span><span class="line">                     this_klass-&gt;external_name(),</span><span class="line">                     InstanceKlass::cast(caller)-&gt;external_name());</span><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><span class="line">          tty-&gt;print(<span class="string">"[Loaded %s]\n"</span>, this_klass-&gt;external_name());</span><span class="line">        &#125;</span><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><span class="line">        tty-&gt;print(<span class="string">"[Loaded %s from %s]\n"</span>, this_klass-&gt;external_name(),</span><span class="line">                   InstanceKlass::cast(class_loader-&gt;klass())-&gt;external_name());</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="keyword">if</span> (TraceClassResolution) &#123;</span><span class="line">      ResourceMark rm;</span><span class="line">      <span class="comment">// print out the superclass.</span></span><span class="line">      <span class="keyword">const</span> <span class="keyword">char</span> * from = this_klass()-&gt;external_name();</span><span class="line">      <span class="keyword">if</span> (this_klass-&gt;java_super() != <span class="literal">NULL</span>) &#123;</span><span class="line">        tty-&gt;print(<span class="string">"RESOLVE %s %s (super)\n"</span>, from, InstanceKlass::cast(this_klass-&gt;java_super())-&gt;external_name());</span><span class="line">      &#125;</span><span class="line">      <span class="comment">// print out each of the interface classes referred to by this class.</span></span><span class="line">      Array&lt;Klass*&gt;* local_interfaces = this_klass-&gt;local_interfaces();</span><span class="line">      <span class="keyword">if</span> (local_interfaces != <span class="literal">NULL</span>) &#123;</span><span class="line">        <span class="keyword">int</span> length = local_interfaces-&gt;length();</span><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><span class="line">          Klass* k = local_interfaces-&gt;at(i);</span><span class="line">          InstanceKlass* to_class = InstanceKlass::cast(k);</span><span class="line">          <span class="keyword">const</span> <span class="keyword">char</span> * to = to_class-&gt;external_name();</span><span class="line">          tty-&gt;print(<span class="string">"RESOLVE %s %s (interface)\n"</span>, from, to);</span><span class="line">        &#125;</span><span class="line">      &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">// preserve result across HandleMark</span></span><span class="line">    preserve_this_klass = this_klass();</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Create new handle outside HandleMark (might be needed for</span></span><span class="line">  <span class="comment">// Extended Class Redefinition)</span></span><span class="line">  <span class="function">instanceKlassHandle <span class="title">this_klass</span> <span class="params">(THREAD, preserve_this_klass)</span></span>;</span><span class="line">  debug_only(this_klass-&gt;verify();)</span><span class="line"></span><span class="line">  <span class="comment">// Clear class if no error has occurred so destructor doesn't deallocate it</span></span><span class="line">  _klass = <span class="literal">NULL</span>;</span><span class="line">  <span class="keyword">return</span> this_klass;</span><span class="line">&#125;</span></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/f3108e56b502/src/share/vm/classfile/classFileParser.cpp" target="_blank" rel="noopener">vm/classfile/classFileParser.cpp</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/java/2018/08/04/hotspot-source-code-call-java-main-method.html" rel="next" title="hotspot source code - call java main method">
                <i class="fa fa-chevron-left"></i>
                hotspot source code - call java main method
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/java/2018/08/04/hotspot-source-code-klass-and-oop.html" rel="prev" title="hotspot source code - klass and oop">
                <i class="fa fa-chevron-right"></i>
                hotspot source code - klass and oop
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/blog/images/avatar.jpg" alt="yuweijun">
          <p class="site-author-name" itemprop="name">yuweijun</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">492</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yuweijun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/yuweijun" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">1.</span> <span class="nav-text">References</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-github"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuweijun</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist.KISS
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.ui.min.js"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
