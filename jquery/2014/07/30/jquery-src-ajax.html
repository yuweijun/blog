<!doctype html>




<html class="theme-next mist">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">


















  

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">






  <link rel="alternate" href="/blog/atom.xml" title="一" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1">






<meta name="description" content="jQuery.ajax在官方有非常详细的文档说明。其真正的核心方法是jQuery.ajax()方法，一般并不需要用此方法进行ajax操作，而使用更高级的方法，如jQuery.get()/jQuery.fn.load()/jQuery.post()/jQuery.getScript()等。">
<meta property="og:type" content="article">
<meta property="og:title" content="jquery-1.4.2 ajax部分源码分析">
<meta property="og:url" content="http://www.4e00.com/jquery/2014/07/30/jquery-src-ajax.html">
<meta property="og:site_name" content="一">
<meta property="og:description" content="jQuery.ajax在官方有非常详细的文档说明。其真正的核心方法是jQuery.ajax()方法，一般并不需要用此方法进行ajax操作，而使用更高级的方法，如jQuery.get()/jQuery.fn.load()/jQuery.post()/jQuery.getScript()等。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-03-06T01:24:26.091Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="jquery-1.4.2 ajax部分源码分析">
<meta name="twitter:description" content="jQuery.ajax在官方有非常详细的文档说明。其真正的核心方法是jQuery.ajax()方法，一般并不需要用此方法进行ajax操作，而使用更高级的方法，如jQuery.get()/jQuery.fn.load()/jQuery.post()/jQuery.getScript()等。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide"},
    fancybox: false,
    motion: false,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://www.4e00.com/blog/jquery/2014/07/30/jquery-src-ajax.html">

  <title> jquery-1.4.2 ajax部分源码分析 | 一 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/" class="brand" rel="start">
      <span class="site-title">一</span>
    </a>
  </div>
  <p class="site-subtitle">{"type":"编程笔记"}</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      <li class="menu-item menu-item-search">
        <a href="https://www.google.com.hk/search?q=site%3Ahttp://www.4e00.com/blog/" class="popup-trigger">
          <i class="menu-item-icon fa fa-search fa-fw"></i>Search
        </a>
      </li>
    </ul>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                jquery-1.4.2 ajax部分源码分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2014-07-30T20:58:36+08:00" content="2014-07-30">
              2014-07-30
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/jquery/" itemprop="url" rel="index">
                    <span itemprop="name">jquery</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>jQuery.ajax在官方有非常详细的<a href="http://api.jquery.com/jQuery.ajax/" target="_blank" rel="noopener">文档说明</a>。其真正的核心方法是jQuery.ajax()方法，一般并不需要用此方法进行ajax操作，而使用更高级的方法，如jQuery.get()/jQuery.fn.load()/jQuery.post()/jQuery.getScript()等。</p>
<a id="more"></a>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">jQuery.extend(&#123;</span><span class="line">    <span class="comment">// 关于 Last-Modified 和 ETag 请查阅以下二个链接</span></span><span class="line">    <span class="comment">// http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.29</span></span><span class="line">    <span class="comment">// http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19</span></span><span class="line">    <span class="comment">// jQuery.lastModified和jQuery.etag用于缓存ajax请求，以ajax请求的url为key存储</span></span><span class="line">    <span class="comment">// Last-Modified header cache for next request</span></span><span class="line">    lastModified: &#123;&#125;,</span><span class="line">    etag: &#123;&#125;,</span><span class="line"></span><span class="line">    <span class="comment">// Perform an asynchronous HTTP (Ajax) request.</span></span><span class="line">    <span class="comment">// jQuery.ajax 核心方法</span></span><span class="line">    ajax: <span class="function"><span class="keyword">function</span>(<span class="params"> origSettings </span>) </span>&#123;</span><span class="line">        <span class="comment">// 不改变jQuery.ajaxSettings和origSettings，并对这个二个对象进行深复制后，生成新对象s</span></span><span class="line">        <span class="keyword">var</span> s = jQuery.extend(<span class="literal">true</span>, &#123;&#125;, jQuery.ajaxSettings, origSettings);</span><span class="line"></span><span class="line">        <span class="keyword">var</span> jsonp, status, data,</span><span class="line">            callbackContext = origSettings &amp;&amp; origSettings.context || s,</span><span class="line">            type = s.type.toUpperCase();</span><span class="line"></span><span class="line">        <span class="comment">// 如果data不是字符串，就将其转换为查询字符串格式，用于ajax的post请求的body，或者将其接到get请求的URL参数里</span></span><span class="line">        <span class="comment">// convert data if not already a string</span></span><span class="line">        <span class="keyword">if</span> ( s.data &amp;&amp; s.processData &amp;&amp; <span class="keyword">typeof</span> s.data !== <span class="string">"string"</span> ) &#123;</span><span class="line">            s.data = jQuery.param( s.data, s.traditional );</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 如果是使用jsonp协议的ajax请求，返回的文本Content-Type为script类型</span></span><span class="line">        <span class="comment">// 构建jsonp请求字符集串。jsonp是跨域请求，要加上callback=?后面将会加函数名</span></span><span class="line">        <span class="comment">// Handle JSONP Parameter Callbacks</span></span><span class="line">        <span class="keyword">if</span> ( s.dataType === <span class="string">"jsonp"</span> ) &#123;</span><span class="line">            <span class="comment">// 使get的url包含 callback=? 后面将会进行加函数名</span></span><span class="line">            <span class="keyword">if</span> ( type === <span class="string">"GET"</span> ) &#123;</span><span class="line">                <span class="keyword">if</span> ( !jsre.test( s.url ) ) &#123;</span><span class="line">                    s.url += (rquery.test( s.url ) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span>) + (s.jsonp || <span class="string">"callback"</span>) + <span class="string">"=?"</span>;</span><span class="line">                &#125;</span><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( !s.data || !jsre.test(s.data) ) &#123;</span><span class="line">                s.data = (s.data ? s.data + <span class="string">"&amp;"</span> : <span class="string">""</span>) + (s.jsonp || <span class="string">"callback"</span>) + <span class="string">"=?"</span>;</span><span class="line">            &#125;</span><span class="line">            <span class="comment">// 对于jsonp类型的ajax请求，先转化dataType为json类型</span></span><span class="line">            s.dataType = <span class="string">"json"</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Build temporary JSONP function</span></span><span class="line">        <span class="keyword">if</span> ( s.dataType === <span class="string">"json"</span> &amp;&amp; (s.data &amp;&amp; jsre.test(s.data) || jsre.test(s.url)) ) &#123;</span><span class="line">            <span class="comment">// 生成回调方法名称并赋值给jsonp，后面还会以此变量是否赋值作为条件判断是否为jsonp请求</span></span><span class="line">            jsonp = s.jsonpCallback || (<span class="string">"jsonp"</span> + jsc++);</span><span class="line"></span><span class="line">            <span class="comment">// 生成一个临时的jsonp方法名，并以此名字替换s.data和s.url中的?占位符(jsre = /=\?(&amp;|$)/)</span></span><span class="line">            <span class="comment">// Replace the =? sequence both in the query string and the data</span></span><span class="line">            <span class="keyword">if</span> ( s.data ) &#123;</span><span class="line">                s.data = (s.data + <span class="string">""</span>).replace(jsre, <span class="string">"="</span> + jsonp + <span class="string">"$1"</span>);</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            s.url = s.url.replace(jsre, <span class="string">"="</span> + jsonp + <span class="string">"$1"</span>);</span><span class="line"></span><span class="line">            <span class="comment">// 我们需要保证jsonp类型响应能正确地执行</span></span><span class="line">            <span class="comment">// 将dataType为json的类型转变为script</span></span><span class="line">            <span class="comment">// We need to make sure that a JSONP style response is executed properly</span></span><span class="line">            s.dataType = <span class="string">"script"</span>;</span><span class="line"></span><span class="line">            <span class="comment">// window下注册一个jsonp回调函数，让ajax请求返回的代码调用执行它</span></span><span class="line">            <span class="comment">// 在服务器端我们生成的代码以callback(data);形式传入data，当代码以script形式插入到head内后，会自动调用下面的window[jonsp]方法</span></span><span class="line">            <span class="comment">// Handle JSONP-style loading</span></span><span class="line">            <span class="built_in">window</span>[ jsonp ] = <span class="built_in">window</span>[ jsonp ] || <span class="function"><span class="keyword">function</span>(<span class="params"> tmp </span>) </span>&#123;</span><span class="line">                data = tmp;</span><span class="line">                <span class="comment">// jsonp类型的ajax请求完成后会自行调用success()和complete()这二个回调方法</span></span><span class="line">                success();</span><span class="line">                complete();</span><span class="line">                <span class="comment">// Garbage collect</span></span><span class="line">                <span class="comment">// 垃圾回收,释放联变量，删除jsonp的对象，除去head中添加的script元素</span></span><span class="line">                <span class="built_in">window</span>[ jsonp ] = <span class="literal">undefined</span>;</span><span class="line"></span><span class="line">                <span class="keyword">try</span> &#123;</span><span class="line">                    <span class="keyword">delete</span> <span class="built_in">window</span>[ jsonp ];</span><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><span class="line"></span><span class="line">                <span class="comment">// 此方法因为被window的对象引用，所以方法定义时所有变量都被保存在词法作用域链上，包括后面才定义的head:</span></span><span class="line">                <span class="comment">// var head = document.getElementsByTagName("head")[0] || document.documentElement</span></span><span class="line">                <span class="keyword">if</span> ( head ) &#123;</span><span class="line">                    <span class="comment">// 服务器端返回的是callback(data)形式的文本，将其添加到head中的一个新插入的script中，从而运行callback(data)方法</span></span><span class="line">                    <span class="comment">// 此处在定义window[ jsonp ]方法，这个script是在后面定义的：var script = document.createElement("script")</span></span><span class="line">                    head.removeChild( script );</span><span class="line">                &#125;</span><span class="line">            &#125;;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 前面的代码已经将jsonp和json这二个dataType类型转化为script类型</span></span><span class="line">        <span class="keyword">if</span> ( s.dataType === <span class="string">"script"</span> &amp;&amp; s.cache === <span class="literal">null</span> ) &#123;</span><span class="line">            s.cache = <span class="literal">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 如果ajax请求不需要缓存，则每次GET请求的url中替换或者多传一个"_"的参数，并传入当前的时间戳</span></span><span class="line">        <span class="keyword">if</span> ( s.cache === <span class="literal">false</span> &amp;&amp; type === <span class="string">"GET"</span> ) &#123;</span><span class="line">            <span class="keyword">var</span> ts = now();</span><span class="line"></span><span class="line">            <span class="comment">// try replacing _= if it is there(rts = /(\?|&amp;)_=.*?(&amp;|$)/)</span></span><span class="line">            <span class="keyword">var</span> ret = s.url.replace(rts, <span class="string">"$1_="</span> + ts + <span class="string">"$2"</span>);</span><span class="line"></span><span class="line">            <span class="comment">// if nothing was replaced, add timestamp to the end</span></span><span class="line">            s.url = ret + ((ret === s.url) ? (rquery.test(s.url) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span>) + <span class="string">"_="</span> + ts : <span class="string">""</span>);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 如果ajax为GET请求，并且传入的options中有s.data，将s.data追加到s.url后面</span></span><span class="line">        <span class="comment">// If data is available, append data to url for get requests</span></span><span class="line">        <span class="keyword">if</span> ( s.data &amp;&amp; type === <span class="string">"GET"</span> ) &#123;</span><span class="line">            s.url += (rquery.test(s.url) ? <span class="string">"&amp;"</span> : <span class="string">"?"</span>) + s.data;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 采用jQuery.event.trigger("ajaxStart");来触发全局的ajaxStart事件。</span></span><span class="line">        <span class="comment">// 这也是说只要注册了这个事件的元素，在任何的ajax的请求时ajaxStart都会执行元素注册的事件处理函数。</span></span><span class="line">        <span class="comment">// jQuery.each("ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend".split(","), function(i, o) &#123;</span></span><span class="line">        <span class="comment">//    jQuery.fn[o] = function(f) &#123; // f:function</span></span><span class="line">        <span class="comment">//        return this.bind(o, f);</span></span><span class="line">        <span class="comment">//    &#125;;</span></span><span class="line">        <span class="comment">// &#125;</span></span><span class="line">        <span class="comment">// 上面的代码是为jquery对象注册了 ajaxStart,ajaxStop,ajaxComplete,ajaxError,ajaxSuccess,ajaxSend这几种ajax的事件方法，在jquery.ajax中不同的时刻都会触发这些事件。</span></span><span class="line">        <span class="comment">// 当然我们也可以采用s.global=false来设定不触发这些事件。</span></span><span class="line">        <span class="comment">// 因为这是全局的，其设计的目的就是为了在这些时候能以某种形式来告诉用户ajax的进行的状态。</span></span><span class="line">        <span class="comment">// 如在ajaxStart的时候，我们可能通过一个topest的div层（加上遮罩的效果）的元素注册一个ajaxstart事件的处理方法。</span></span><span class="line">        <span class="comment">// 该方法就是显示这个层和显示“你的数据正在提交。。。”这个的提示。</span></span><span class="line">        <span class="comment">// Watch for a new set of requests</span></span><span class="line">        <span class="keyword">if</span> ( s.global &amp;&amp; ! jQuery.active++ ) &#123;</span><span class="line">            <span class="comment">// 发起一个ajax请求，全局的ajax计数器jQuery.active加1，表示当前激活的ajax请求数量，完成一个ajax请求就会将jQuery.active减1</span></span><span class="line">            jQuery.event.trigger( <span class="string">"ajaxStart"</span> );</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 当http协议或者是host不同时，作为跨域远程ajax调用</span></span><span class="line">        <span class="comment">// Matches an absolute URL, and saves the domain</span></span><span class="line">        <span class="comment">// rurl = /^(\w+:)?\/\/([^\/?#]+)/</span></span><span class="line">        <span class="keyword">var</span> parts = rurl.exec( s.url ),</span><span class="line">            remote = parts &amp;&amp; (parts[<span class="number">1</span>] &amp;&amp; parts[<span class="number">1</span>] !== location.protocol || parts[<span class="number">2</span>] !== location.host);</span><span class="line"></span><span class="line">        <span class="comment">// If we're requesting a remote document</span></span><span class="line">        <span class="comment">// and trying to load JSON or Script with a GET</span></span><span class="line">        <span class="keyword">if</span> ( s.dataType === <span class="string">"script"</span> &amp;&amp; type === <span class="string">"GET"</span> &amp;&amp; remote ) &#123;</span><span class="line">            <span class="comment">// ajax是不能跨域的，所以使用</span></span><span class="line">            <span class="keyword">var</span> head = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"head"</span>)[<span class="number">0</span>] || <span class="built_in">document</span>.documentElement;</span><span class="line">            <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span><span class="line">            script.src = s.url;</span><span class="line">            <span class="keyword">if</span> ( s.scriptCharset ) &#123;</span><span class="line">                script.charset = s.scriptCharset;</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 如果datatype不是jsonp，但是url却是跨域的，采用scriptr的onload或onreadystatechange事件来触发回调函数。</span></span><span class="line">            <span class="comment">// 对于jsonp类型的ajax请求，会在window[jsonp]方法中调用success()和complete()这二个回调方法</span></span><span class="line">            <span class="comment">// 如果是jsonp，插入的head也需要置为null，清理内存</span></span><span class="line">            <span class="comment">// Handle Script loading</span></span><span class="line">            <span class="keyword">if</span> ( !jsonp ) &#123;</span><span class="line">                <span class="keyword">var</span> done = <span class="literal">false</span>;</span><span class="line"></span><span class="line">                <span class="comment">// Attach handlers for all browsers</span></span><span class="line">                script.onload = script.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">                    <span class="keyword">if</span> ( !done &amp;&amp; (!<span class="keyword">this</span>.readyState ||</span><span class="line">                            <span class="keyword">this</span>.readyState === <span class="string">"loaded"</span> || <span class="keyword">this</span>.readyState === <span class="string">"complete"</span>) ) &#123;</span><span class="line">                        done = <span class="literal">true</span>;</span><span class="line">                        success();</span><span class="line">                        complete();</span><span class="line"></span><span class="line">                        <span class="comment">// 处理IE中内存泄漏问题</span></span><span class="line">                        <span class="comment">// Handle memory leak in IE</span></span><span class="line">                        script.onload = script.onreadystatechange = <span class="literal">null</span>;</span><span class="line">                        <span class="keyword">if</span> ( head &amp;&amp; script.parentNode ) &#123;</span><span class="line">                            head.removeChild( script );</span><span class="line">                        &#125;</span><span class="line">                    &#125;</span><span class="line">                &#125;;</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 将head插入到head头最前面</span></span><span class="line">            <span class="comment">// Use insertBefore instead of appendChild  to circumvent an IE6 bug.</span></span><span class="line">            <span class="comment">// This arises when a base node is used (#2709 and #4378).</span></span><span class="line">            head.insertBefore( script, head.firstChild );</span><span class="line"></span><span class="line">            <span class="comment">// 在此处理完所有dataType为script/json/jsonp跨域的ajax请求，非跨域的请求在后面继续处理</span></span><span class="line">            <span class="comment">// We handle everything using the script element injection</span></span><span class="line">            <span class="keyword">return</span> <span class="literal">undefined</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">var</span> requestDone = <span class="literal">false</span>;</span><span class="line"></span><span class="line">        <span class="comment">// xhr()方法可查看ajaxSettings.xhr()方法中的说明</span></span><span class="line">        <span class="comment">// Create the request object</span></span><span class="line">        <span class="keyword">var</span> xhr = s.xhr();</span><span class="line"></span><span class="line">        <span class="keyword">if</span> ( !xhr ) &#123;</span><span class="line">            <span class="keyword">return</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 创建一个请求的连接，在opera中如果用户名为null会弹出login窗口中。</span></span><span class="line">        <span class="comment">// Open the socket</span></span><span class="line">        <span class="comment">// Passing null username, generates a login popup on Opera (#2865)</span></span><span class="line">        <span class="keyword">if</span> ( s.username ) &#123;</span><span class="line">            xhr.open(type, s.url, s.async, s.username, s.password);</span><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><span class="line">            xhr.open(type, s.url, s.async);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// firefox3中支持跨域ajax请求，不过需要第三域下配置一个XML说明文件，允许当前域的ajax请求</span></span><span class="line">        <span class="comment">// Need an extra try/catch for cross domain requests in Firefox 3</span></span><span class="line">        <span class="keyword">try</span> &#123;</span><span class="line">            <span class="comment">// Set the correct header, if data is being sent</span></span><span class="line">            <span class="keyword">if</span> ( s.data || origSettings &amp;&amp; origSettings.contentType ) &#123;</span><span class="line">                xhr.setRequestHeader(<span class="string">"Content-Type"</span>, s.contentType);</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 设定If-Modified-Since(Last-Modified)和If-None-Match(Etag)</span></span><span class="line">            <span class="comment">// Set the If-Modified-Since and/or If-None-Match header, if in ifModified mode.</span></span><span class="line">            <span class="keyword">if</span> ( s.ifModified ) &#123;</span><span class="line">                <span class="keyword">if</span> ( jQuery.lastModified[s.url] ) &#123;</span><span class="line">                    xhr.setRequestHeader(<span class="string">"If-Modified-Since"</span>, jQuery.lastModified[s.url]);</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                <span class="keyword">if</span> ( jQuery.etag[s.url] ) &#123;</span><span class="line">                    xhr.setRequestHeader(<span class="string">"If-None-Match"</span>, jQuery.etag[s.url]);</span><span class="line">                &#125;</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 这里是为了让服务器能判断这个请求是XMLHttpRequest</span></span><span class="line">            <span class="comment">// Set header so the called script knows that it's an XMLHttpRequest</span></span><span class="line">            <span class="comment">// Only send the header if it's not a remote XHR</span></span><span class="line">            <span class="keyword">if</span> ( !remote ) &#123;</span><span class="line">                xhr.setRequestHeader(<span class="string">"X-Requested-With"</span>, <span class="string">"XMLHttpRequest"</span>);</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 为服务器端设定Accepts header，指能接收的Content-Type，告诉服务器当前请求所能接收的内容类型</span></span><span class="line">            <span class="comment">// Set the Accepts header for the server, depending on the dataType</span></span><span class="line">            xhr.setRequestHeader(<span class="string">"Accept"</span>, s.dataType &amp;&amp; s.accepts[ s.dataType ] ?</span><span class="line">                s.accepts[ s.dataType ] + <span class="string">", */*"</span> :</span><span class="line">                s.accepts._default );</span><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><span class="line"></span><span class="line">        <span class="comment">// 拦截方法beforeSend(xhr, s)，我们可以在send之前进行拦截。返回false就不send</span></span><span class="line">        <span class="comment">// Allow custom headers/mimetypes and early abort</span></span><span class="line">        <span class="keyword">if</span> ( s.beforeSend &amp;&amp; s.beforeSend.call(callbackContext, xhr, s) === <span class="literal">false</span> ) &#123;</span><span class="line">            <span class="comment">// Handle the global AJAX counter</span></span><span class="line">            <span class="comment">// 减少ajax请求的计数器</span></span><span class="line">            <span class="comment">// 触发全局的ajaxStop事件</span></span><span class="line">            <span class="keyword">if</span> ( s.global &amp;&amp; ! --jQuery.active ) &#123;</span><span class="line">                jQuery.event.trigger( <span class="string">"ajaxStop"</span> );</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 此处ajaxSend事件还没有触发，xhr.abort()方法还没有被重定义，并且不会调用complete()方法</span></span><span class="line">            <span class="comment">// 后面xhr.abort()方法被重新定义，最后会调用complete()方法</span></span><span class="line">            <span class="comment">// close opended socket</span></span><span class="line">            xhr.abort();</span><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 触发全局的或者是s.context环境下的ajaxSend事件</span></span><span class="line">        <span class="comment">// 当ajaxSend之后，发生xhr.abort()时，仍会调用complete()方法</span></span><span class="line">        <span class="keyword">if</span> ( s.global ) &#123;</span><span class="line">            trigger(<span class="string">"ajaxSend"</span>, [xhr, s]);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 处理ajax请求的状态，并且利用后面的setTimeout和s.timeout来控制请求是否超时</span></span><span class="line">        <span class="comment">// 参数isTimeout可能传入的参数为：abort/timeout</span></span><span class="line">        <span class="comment">// Wait for a response to come back</span></span><span class="line">        <span class="keyword">var</span> onreadystatechange = xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"> isTimeout </span>) </span>&#123;</span><span class="line">            <span class="comment">// The request was aborted</span></span><span class="line">            <span class="keyword">if</span> ( !xhr || xhr.readyState === <span class="number">0</span> || isTimeout === <span class="string">"abort"</span> ) &#123;</span><span class="line">                <span class="comment">// Opera doesn't call onreadystatechange before this point</span></span><span class="line">                <span class="comment">// 后面为了使opera执行xhr.abort之后，能执行complete()回调方法，传入了一个参数，并且在后面调用了方法： onreadystatechange( "abort" );</span></span><span class="line">                <span class="comment">// so we simulate the call</span></span><span class="line">                <span class="keyword">if</span> ( !requestDone ) &#123;</span><span class="line">                    complete();</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                requestDone = <span class="literal">true</span>;</span><span class="line">                <span class="keyword">if</span> ( xhr ) &#123;</span><span class="line">                    <span class="comment">// 重置xhr.onreadystatechange为空方法，但onreadystatechange()这个方法还在，可以被后面代码直接调用</span></span><span class="line">                    xhr.onreadystatechange = jQuery.noop;</span><span class="line">                &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 请求正常完成并返回可用response，或者是请求超时</span></span><span class="line">            <span class="comment">// 分析status: tiemout/error/notmodified/success</span></span><span class="line">            <span class="comment">// The transfer is complete and the data is available, or the request timed out</span></span><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( !requestDone &amp;&amp; xhr &amp;&amp; (xhr.readyState === <span class="number">4</span> || isTimeout === <span class="string">"timeout"</span>) ) &#123;</span><span class="line">                requestDone = <span class="literal">true</span>;</span><span class="line">                xhr.onreadystatechange = jQuery.noop;</span><span class="line"></span><span class="line">                status = isTimeout === <span class="string">"timeout"</span> ?</span><span class="line">                    <span class="string">"timeout"</span> :</span><span class="line">                    <span class="comment">// 如果jQuery.httpSuccess( xhr )方法返回false，则表示ajax请求发生错误</span></span><span class="line">                    !jQuery.httpSuccess( xhr ) ?</span><span class="line">                        <span class="string">"error"</span> :</span><span class="line">                        s.ifModified &amp;&amp; jQuery.httpNotModified( xhr, s.url ) ?</span><span class="line">                            <span class="string">"notmodified"</span> :</span><span class="line">                            <span class="string">"success"</span>;</span><span class="line"></span><span class="line">                <span class="keyword">var</span> errMsg;</span><span class="line"></span><span class="line">                <span class="comment">// 如果success且返回了数据，那么分析这些数据</span></span><span class="line">                <span class="keyword">if</span> ( status === <span class="string">"success"</span> ) &#123;</span><span class="line">                    <span class="comment">// Watch for, and catch, XML document parse errors</span></span><span class="line">                    <span class="keyword">try</span> &#123;</span><span class="line">                        <span class="comment">// 分析ajax返回的response body，XML文档解析可能会抛异常</span></span><span class="line">                        <span class="comment">// process the data (runs the xml through httpData regardless of callback)</span></span><span class="line">                        data = jQuery.httpData( xhr, s.dataType, s );</span><span class="line">                    &#125; <span class="keyword">catch</span>(err) &#123;</span><span class="line">                        status = <span class="string">"parsererror"</span>;</span><span class="line">                        errMsg = err;</span><span class="line">                    &#125;</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                <span class="comment">// 分析数据成功之后,进行last-modified和success的处理。</span></span><span class="line">                <span class="comment">// Make sure that the request was successful or notmodified</span></span><span class="line">                <span class="keyword">if</span> ( status === <span class="string">"success"</span> || status === <span class="string">"notmodified"</span> ) &#123;</span><span class="line">                    <span class="comment">// JSONP handles its own success callback</span></span><span class="line">                    <span class="keyword">if</span> ( !jsonp ) &#123;</span><span class="line">                        success();</span><span class="line">                    &#125;</span><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><span class="line">                    <span class="comment">// 调用jQuery.handleError处理ajax请求发生错误的情况，可以在ajax请求的options中传入error方法，并由handleError方法来调用</span></span><span class="line">                    jQuery.handleError(s, xhr, status, errMsg);</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                <span class="comment">// 除了在beforeSend()方法返回false不触发complete()回调方法，ajax请求不论成功失败都会触发ajax请求options中的complete()回调方法</span></span><span class="line">                <span class="comment">// Fire the complete handlers</span></span><span class="line">                complete();</span><span class="line"></span><span class="line">                <span class="comment">// ajax请求超时处理，调用xhr.abort()方法，此处xhr.abort()方法已经被重写，执行之后会调用complete()方法</span></span><span class="line">                <span class="keyword">if</span> ( isTimeout === <span class="string">"timeout"</span> ) &#123;</span><span class="line">                    xhr.abort();</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                <span class="comment">// Stop memory leaks</span></span><span class="line">                <span class="keyword">if</span> ( s.async ) &#123;</span><span class="line">                    xhr = <span class="literal">null</span>;</span><span class="line">                &#125;</span><span class="line">            &#125;</span><span class="line">        &#125;;</span><span class="line">        <span class="comment">// 结束ajax回调方法xhr.onreadystatechange()的定义</span></span><span class="line"></span><span class="line">        <span class="comment">// 在ajaxSend事件之后，重定义xhr.abort()方法，并且通过调用onreadystatechange("abort")方法，调用complete()方法</span></span><span class="line">        <span class="comment">// Override the abort handler, if we can (IE doesn't allow it, but that's OK)</span></span><span class="line">        <span class="comment">// Opera doesn't fire onreadystatechange at all on abort</span></span><span class="line">        <span class="keyword">try</span> &#123;</span><span class="line">            <span class="keyword">var</span> oldAbort = xhr.abort;</span><span class="line">            xhr.abort = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">                <span class="keyword">if</span> ( xhr ) &#123;</span><span class="line">                    oldAbort.call( xhr );</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                <span class="comment">// 直接调用前面定义的onreadystatechange()方法，并传入参数"abort"，使之调用complete()方法</span></span><span class="line">                onreadystatechange( <span class="string">"abort"</span> );</span><span class="line">            &#125;;</span><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123; &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Timeout checker</span></span><span class="line">        <span class="keyword">if</span> ( s.async &amp;&amp; s.timeout &gt; <span class="number">0</span> ) &#123;</span><span class="line">            setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">                <span class="comment">// Check to see if the request is still happening</span></span><span class="line">                <span class="keyword">if</span> ( xhr &amp;&amp; !requestDone ) &#123;</span><span class="line">                    <span class="comment">// 当指定的s.timeout时间内，ajax请求仍然没有完成时，调用onreadystatechange("timeout")方法，执行被重写过的xhr.abort()方法</span></span><span class="line">                    onreadystatechange( <span class="string">"timeout"</span> );</span><span class="line">                &#125;</span><span class="line">            &#125;, s.timeout);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 在此处真正发起ajax请求</span></span><span class="line">        <span class="comment">// Send the data</span></span><span class="line">        <span class="keyword">try</span> &#123;</span><span class="line">            xhr.send( type === <span class="string">"POST"</span> || type === <span class="string">"PUT"</span> || type === <span class="string">"DELETE"</span> ? s.data : <span class="literal">null</span> );</span><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;</span><span class="line">            jQuery.handleError(s, xhr, <span class="literal">null</span>, e);</span><span class="line">            <span class="comment">// 如果发生异常，而没有通过onreadystatechange()方法调用complete()方法，在这里保证complete()方法被正确执行</span></span><span class="line">            <span class="comment">// Fire the complete handlers</span></span><span class="line">            complete();</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// firefox 1.5 doesn't fire statechange for sync requests</span></span><span class="line">        <span class="keyword">if</span> ( !s.async ) &#123;</span><span class="line">            onreadystatechange();</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 下面的success()/complete()/trigger()方法，会在进入jQuery.ajax()方法体后先被解析</span></span><span class="line">        <span class="comment">// 触发ajax请求时，参数中传入的success回调方法和全局(或者是指定运行环境)的ajaxSuccess事件</span></span><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params"></span>) </span>&#123;</span><span class="line">            <span class="comment">// If a local callback was specified, fire it and pass it the data</span></span><span class="line">            <span class="keyword">if</span> ( s.success ) &#123;</span><span class="line">                s.success.call( callbackContext, data, status, xhr );</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// Fire the global callback</span></span><span class="line">            <span class="keyword">if</span> ( s.global ) &#123;</span><span class="line">                trigger( <span class="string">"ajaxSuccess"</span>, [xhr, s] );</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 触发complete回调和全局(或者是指定运行环境)的ajaxComplete事件</span></span><span class="line">        <span class="comment">// 触发全局的ajaxStop事件，并减少一个ajax计数器值</span></span><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">complete</span>(<span class="params"></span>) </span>&#123;</span><span class="line">            <span class="comment">// Process result</span></span><span class="line">            <span class="keyword">if</span> ( s.complete ) &#123;</span><span class="line">                s.complete.call( callbackContext, xhr, status);</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 在完成ajax请求options中的complete()回调方法之后，触发全局的ajaxComplete事件</span></span><span class="line">            <span class="comment">// The request was completed</span></span><span class="line">            <span class="keyword">if</span> ( s.global ) &#123;</span><span class="line">                trigger( <span class="string">"ajaxComplete"</span>, [xhr, s] );</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="comment">// 这里要注意 "! --jQuery.active" 这句代码，只有当激活的ajax请求全部执行完成之后，jQuery.active == 0时才会触发全局的ajaxStop事件</span></span><span class="line">            <span class="comment">// Handle the global AJAX counter</span></span><span class="line">            <span class="keyword">if</span> ( s.global &amp;&amp; ! --jQuery.active ) &#123;</span><span class="line">                jQuery.event.trigger( <span class="string">"ajaxStop"</span> );</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 触发type类型的全局ajax事件</span></span><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">type, args</span>) </span>&#123;</span><span class="line">            (s.context ? jQuery(s.context) : jQuery.event).trigger(type, args);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 返回xhr，方便后续对这个对象进一步操作</span></span><span class="line">        <span class="comment">// return XMLHttpRequest to allow aborting the request etc.</span></span><span class="line">        <span class="keyword">return</span> xhr;</span><span class="line">    &#125;</span><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>一些jQuery.ajax相关的变量和正则表达式定义：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> jsc = now(),</span><span class="line">    <span class="comment">// rscript二个尖括号被我转义过，注意</span></span><span class="line">    rscript = <span class="regexp">/&lt;script(.|\s)*?\/script&gt;/gi</span>,</span><span class="line">    rselectTextarea = <span class="regexp">/select|textarea/i</span>,</span><span class="line">    rinput = <span class="regexp">/color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week/i</span>,</span><span class="line">    jsre = <span class="regexp">/=\?(&amp;|$)/</span>,</span><span class="line">    rquery = <span class="regexp">/\?/</span>,</span><span class="line">    rts = <span class="regexp">/(\?|&amp;)_=.*?(&amp;|$)/</span>,</span><span class="line">    rurl = <span class="regexp">/^(\w+:)?\/\/([^\/?#]+)/</span>,</span><span class="line">    r20 = <span class="regexp">/%20/g</span>;</span></pre></td></tr></table></figure></p>
<p>jQuery.fn.load方法定义：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Keep a copy of the old load method</span></span><span class="line"><span class="keyword">var</span> _load = jQuery.fn.load;</span><span class="line">jQuery.fn.extend(&#123;</span><span class="line">    <span class="comment">// .load( url, [ data ], [ callback(responseText, textStatus, XMLHttpRequest) ] )</span></span><span class="line">    <span class="comment">// url: A string containing the URL to which the request is sent.</span></span><span class="line">    <span class="comment">// data: A map or string that is sent to the server with the request.</span></span><span class="line">    <span class="comment">// callback(responseText, textStatus, XMLHttpRequest): A callback function that is executed when the request completes.</span></span><span class="line">    <span class="comment">// .load()方法已经有一个默认的complete回调方法，将服务器加载的内容插入当前jquery对象匹配的DOM对象中，是最简单的一个ajax方法</span></span><span class="line">    <span class="comment">// This method is the simplest way to fetch data from the server. It is roughly equivalent to $.get(url, data, success) except that it is a method rather than global function and it has an implicit callback function. When a successful response is detected (i.e. when textStatus is "success" or "notmodified"), .load() sets the HTML contents of the matched element to the returned data.</span></span><span class="line">    load: <span class="function"><span class="keyword">function</span>(<span class="params"> url, params, callback </span>) </span>&#123;</span><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> url !== <span class="string">"string"</span> ) &#123;</span><span class="line">            <span class="keyword">return</span> _load.call( <span class="keyword">this</span>, url );</span><span class="line"></span><span class="line">        <span class="comment">// 如果jquery对象没有匹配到任何DOM对象，则不会发起Ajax请求</span></span><span class="line">        <span class="comment">// Don't do a request if no elements are being requested</span></span><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="keyword">this</span>.length ) &#123;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Loading Page Fragments</span></span><span class="line">        <span class="comment">// The .load() method, unlike $.get(), allows us to specify a portion of the remote document to be inserted. This is achieved with a special syntax for the url parameter. If one or more space characters are included in the string, the portion of the string following the first space is assumed to be a jQuery selector that determines the content to be loaded.</span></span><span class="line">        <span class="comment">// We could modify the example above to use only part of the document that is fetched:</span></span><span class="line">        <span class="comment">// $('#result').load('ajax/test.html #container');</span></span><span class="line">        <span class="comment">// When this method executes, it retrieves the content of ajax/test.html, but then jQuery parses the returned document to find the element with an ID of container. This element, along with its contents, is inserted into the element with an ID of result, and the rest of the retrieved document is discarded.</span></span><span class="line">        <span class="comment">// Note that the document retrieved cannot be a full HTML document; that is, it cannot include (for example) &lt;html&gt;, &lt;title&gt;, or &lt;head&gt; elements. jQuery uses the browser's innerHTML property on a &lt;div&gt; element to parse the document, and most browsers will not allow non-body elements to be parsed in this way.</span></span><span class="line">        <span class="comment">// .load()方法中传入的url字符串中可以用空格做为分隔符，空格前面的为url，后面的则作为url返回页面的selector</span></span><span class="line">        <span class="comment">// 将load得到的response body根据这些selector匹配后，再将匹配的元素插入当前jquery对象匹配的元素中</span></span><span class="line">        <span class="keyword">var</span> off = url.indexOf(<span class="string">" "</span>);</span><span class="line">        <span class="keyword">if</span> ( off &gt;= <span class="number">0</span> ) &#123;</span><span class="line">            <span class="keyword">var</span> selector = url.slice(off, url.length);</span><span class="line">            url = url.slice(<span class="number">0</span>, off);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Default to a GET request</span></span><span class="line">        <span class="keyword">var</span> type = <span class="string">"GET"</span>;</span><span class="line"></span><span class="line">        <span class="comment">// If the second parameter was provided</span></span><span class="line">        <span class="keyword">if</span> ( params ) &#123;</span><span class="line">            <span class="comment">// If it's a function</span></span><span class="line">            <span class="keyword">if</span> ( jQuery.isFunction( params ) ) &#123;</span><span class="line">                <span class="comment">// We assume that it's the callback</span></span><span class="line">                callback = params;</span><span class="line">                params = <span class="literal">null</span>;</span><span class="line"></span><span class="line">            <span class="comment">// Otherwise, build a param string</span></span><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( <span class="keyword">typeof</span> params === <span class="string">"object"</span> ) &#123;</span><span class="line">                <span class="comment">// 如果传入的params为一个object，则将之序列化为post的body体，并且.load()的ajax请求以POST方式提交</span></span><span class="line">                params = jQuery.param( params, jQuery.ajaxSettings.traditional );</span><span class="line">                type = <span class="string">"POST"</span>;</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><span class="line"></span><span class="line">        <span class="comment">// Request the remote document</span></span><span class="line">        jQuery.ajax(&#123;</span><span class="line">            url: url,</span><span class="line">            type: type,</span><span class="line">            dataType: <span class="string">"html"</span>,</span><span class="line">            data: params,</span><span class="line">            complete: <span class="function"><span class="keyword">function</span>(<span class="params"> res, status </span>) </span>&#123;</span><span class="line">                <span class="comment">// If successful, inject the HTML into all the matched elements</span></span><span class="line">                <span class="keyword">if</span> ( status === <span class="string">"success"</span> || status === <span class="string">"notmodified"</span> ) &#123;</span><span class="line">                    <span class="comment">// See if a selector was specified</span></span><span class="line">                    <span class="comment">// 是否从第一个字符串参数中提取到selector</span></span><span class="line">                    self.html( selector ?</span><span class="line">                        <span class="comment">// Create a dummy div to hold the results</span></span><span class="line">                        jQuery(<span class="string">"&lt; div /&gt;"</span>)</span><span class="line">                            <span class="comment">// inject the contents of the document in, removing the scripts</span></span><span class="line">                            <span class="comment">// to avoid any 'Permission Denied' errors in IE</span></span><span class="line">                            <span class="comment">// rscript = /&lt;script(.|\s)*?\/script&gt;/gi，过滤掉返回文本中的脚本内容</span></span><span class="line">                            .append(res.responseText.replace(rscript, <span class="string">""</span>))</span><span class="line"></span><span class="line">                            <span class="comment">// 从ajax返回的文本中，找到匹配空格后面的selector部分的元素，并将这些元素添加到当前jquery对象匹配的元素中</span></span><span class="line">                            <span class="comment">// Locate the specified elements</span></span><span class="line">                            .find(selector)</span><span class="line">                        :</span><span class="line">                        <span class="comment">// If not, just inject the full result</span></span><span class="line">                        res.responseText );</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                <span class="comment">// 执行load完成之后的回调方法</span></span><span class="line">                <span class="keyword">if</span> ( callback ) &#123;</span><span class="line">                    self.each( callback, [res.responseText, status, res] );</span><span class="line">                &#125;</span><span class="line">            &#125;</span><span class="line">        &#125;);</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// .serialize() Returns: String</span></span><span class="line">    <span class="comment">// Description: Encode a set of form elements as a string for submission.</span></span><span class="line">    <span class="comment">// For a form element's value to be included in the serialized string, the element must have a name attribute.</span></span><span class="line">    <span class="comment">// Data from file select elements is not serialized.</span></span><span class="line">    <span class="comment">// 将form表单中的元素name/value值拼成一个字符串(类似a=1&amp;b=2&amp;c=3&amp;d=4&amp;e=5&amp;e=6)，用于ajax表单提交时使用</span></span><span class="line">    serialize: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">        <span class="keyword">return</span> jQuery.param(<span class="keyword">this</span>.serializeArray());</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// .serializeArray() Returns: Array</span></span><span class="line">    <span class="comment">// Description: Encode a set of form elements as an array of names and values.</span></span><span class="line">    <span class="comment">// This method creates a JavaScript array of objects, ready to be encoded as a JSON string.</span></span><span class="line">    <span class="comment">// It operates on a jQuery object representing a set of form elements.</span></span><span class="line">    <span class="comment">// 将form表单中的元素键值对放在一个数组中，其中e因为是多选select，所以有二个值，如:</span></span><span class="line">    <span class="comment">// [ &#123; name: "a", value: 1 &#125;, &#123; name: "b", value: 2 &#125;, &#123; name: "c", value: 3 &#125;, &#123; name: "d", value: 4 &#125;, &#123; name: "e", value: 5 &#125;, &#123; name: "e", value: 6 &#125; ]</span></span><span class="line">    serializeArray: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.elements ? jQuery.makeArray(<span class="keyword">this</span>.elements) : <span class="keyword">this</span>;</span><span class="line">        &#125;)</span><span class="line">        .filter(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">            <span class="comment">// 过滤掉form表单中被disabled，unchecked的元素的键值对，file控件也会被过滤掉，ajax不能进行文件上传操作，文件上传需要借助iframe</span></span><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.name &amp;&amp; !<span class="keyword">this</span>.disabled &amp;&amp;</span><span class="line">                <span class="comment">// rselectTextarea = /select|textarea/i,</span></span><span class="line">                (<span class="keyword">this</span>.checked || rselectTextarea.test(<span class="keyword">this</span>.nodeName) ||</span><span class="line">                    <span class="comment">// rinput = /color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week/i,</span></span><span class="line">                    rinput.test(<span class="keyword">this</span>.type));</span><span class="line">        &#125;)</span><span class="line">        .map(<span class="function"><span class="keyword">function</span>(<span class="params"> i, elem </span>) </span>&#123;</span><span class="line">            <span class="keyword">var</span> val = jQuery(<span class="keyword">this</span>).val();</span><span class="line"></span><span class="line">            <span class="keyword">return</span> val == <span class="literal">null</span> ?</span><span class="line">                <span class="literal">null</span> :</span><span class="line">                <span class="comment">// 如果表单元素的值是一个数组，如multi-select和checkbox多选</span></span><span class="line">                jQuery.isArray(val) ?</span><span class="line">                    jQuery.map( val, <span class="function"><span class="keyword">function</span>(<span class="params"> val, i </span>) </span>&#123;</span><span class="line">                        <span class="keyword">return</span> &#123; <span class="attr">name</span>: elem.name, <span class="attr">value</span>: val &#125;;</span><span class="line">                    &#125;) :</span><span class="line">                    <span class="comment">// 返回元素的键值对</span></span><span class="line">                    &#123; <span class="attr">name</span>: elem.name, <span class="attr">value</span>: val &#125;;</span><span class="line">        &#125;).get();</span><span class="line">    &#125;</span><span class="line">&#125;);</span></pre></td></tr></table></figure></p>
<p>ajax相关的全局回调方法和事件的定义：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 定义jQuery.fn.ajaxStart()方法，并同时增加ajaxStart事件</span></span><span class="line"><span class="comment">// Attach a bunch of functions for handling common AJAX events</span></span><span class="line">jQuery.each( <span class="string">"ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend"</span>.split(<span class="string">" "</span>), <span class="function"><span class="keyword">function</span>(<span class="params"> i, o </span>) </span>&#123;</span><span class="line">    jQuery.fn[o] = <span class="function"><span class="keyword">function</span>(<span class="params"> f </span>) </span>&#123;</span><span class="line">        <span class="comment">// 将ajaxStart事件绑定到当前jquery对象上，当trigger ajaxStart事件时，会执行回调方法: f</span></span><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.bind(o, f);</span><span class="line">    &#125;;</span><span class="line">&#125;);</span></pre></td></tr></table></figure></p>
<p>jQuery.get()/jQuery.post()/jQuery.getScript()/jQuery.getJSON()等高级ajax方法定义：<br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">jQuery.extend(&#123;</span><span class="line"></span><span class="line">    <span class="comment">// Load data from the server using a HTTP GET request.</span></span><span class="line">    <span class="comment">// jQuery.get( url, [ data ], [ callback(data, textStatus, XMLHttpRequest) ], [ dataType ] )</span></span><span class="line">    <span class="comment">// url: A string containing the URL to which the request is sent.</span></span><span class="line">    <span class="comment">// data: A map or string that is sent to the server with the request.</span></span><span class="line">    <span class="comment">// callback(data, textStatus, XMLHttpRequest): A callback function that is executed if the request succeeds.</span></span><span class="line">    <span class="comment">// dataType: The type of data expected from the server.</span></span><span class="line">    <span class="keyword">get</span>: function( url, data, callback, type ) &#123;</span><span class="line">        <span class="comment">// 如果没有提供data参数，则将后面二个参数位置前移</span></span><span class="line">        <span class="comment">// shift arguments if data argument was omited</span></span><span class="line">        <span class="keyword">if</span> ( jQuery.isFunction( data ) ) &#123;</span><span class="line">            type = type || callback;</span><span class="line">            callback = data;</span><span class="line">            data = <span class="literal">null</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> jQuery.ajax(&#123;</span><span class="line">            type: <span class="string">"GET"</span>,</span><span class="line">            url: url,</span><span class="line">            data: data,</span><span class="line">            success: callback,</span><span class="line">            dataType: type</span><span class="line">        &#125;);</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// Load a JavaScript file from the server using a GET HTTP request, then execute it.</span></span><span class="line">    <span class="comment">// jQuery.getScript( url, [ success(data, textStatus) ] )</span></span><span class="line">    <span class="comment">// url: A string containing the URL to which the request is sent.</span></span><span class="line">    <span class="comment">// success(data, textStatus): A callback function that is executed if the request succeeds.</span></span><span class="line">    getScript: <span class="function"><span class="keyword">function</span>(<span class="params"> url, callback </span>) </span>&#123;</span><span class="line">        <span class="keyword">return</span> jQuery.get(url, <span class="literal">null</span>, callback, <span class="string">"script"</span>);</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    getJSON: <span class="function"><span class="keyword">function</span>(<span class="params"> url, data, callback </span>) </span>&#123;</span><span class="line">        <span class="keyword">return</span> jQuery.get(url, data, callback, <span class="string">"json"</span>);</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// jQuery.post( url, [ data ], [ success(data, textStatus, XMLHttpRequest) ], [ dataType ] )</span></span><span class="line">    <span class="comment">// url: A string containing the URL to which the request is sent.</span></span><span class="line">    <span class="comment">// data: A map or string that is sent to the server with the request.</span></span><span class="line">    <span class="comment">// success(data, textStatus, XMLHttpRequest): A callback function that is executed if the request succeeds.</span></span><span class="line">    <span class="comment">// dataType: The type of data expected from the server.</span></span><span class="line">    post: <span class="function"><span class="keyword">function</span>(<span class="params"> url, data, callback, type </span>) </span>&#123;</span><span class="line">        <span class="comment">// 如果没有提供data参数，则将后面二个参数位置前移</span></span><span class="line">        <span class="comment">// shift arguments if data argument was omited</span></span><span class="line">        <span class="keyword">if</span> ( jQuery.isFunction( data ) ) &#123;</span><span class="line">            type = type || callback;</span><span class="line">            callback = data;</span><span class="line">            data = &#123;&#125;;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> jQuery.ajax(&#123;</span><span class="line">            type: <span class="string">"POST"</span>,</span><span class="line">            url: url,</span><span class="line">            data: data,</span><span class="line">            success: callback,</span><span class="line">            dataType: type</span><span class="line">        &#125;);</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// 通过此方法覆写全局的ajax请求的默认参数</span></span><span class="line">    <span class="comment">// Description: Set default values for future Ajax requests.</span></span><span class="line">    <span class="comment">// jQuery.ajaxSetup( options )</span></span><span class="line">    <span class="comment">// options: A set of key/value pairs that configure the default Ajax request. All options are optional.</span></span><span class="line">    ajaxSetup: <span class="function"><span class="keyword">function</span>(<span class="params"> settings </span>) </span>&#123;</span><span class="line">        jQuery.extend( jQuery.ajaxSettings, settings );</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// jQuery.ajaxSettings默认值</span></span><span class="line">    <span class="comment">// 可以通过jQuery.ajaxSetup(settings)方法覆写全局的设置，使之对所有ajax请求都生效</span></span><span class="line">    ajaxSettings: &#123;</span><span class="line">        url: location.href,</span><span class="line">        global: <span class="literal">true</span>,</span><span class="line">        type: <span class="string">"GET"</span>,</span><span class="line">        contentType: <span class="string">"application/x-www-form-urlencoded"</span>,</span><span class="line">        processData: <span class="literal">true</span>,</span><span class="line">        <span class="keyword">async</span>: <span class="literal">true</span>,</span><span class="line">        <span class="comment">// timeout: 0,</span></span><span class="line">        <span class="comment">// data: null,</span></span><span class="line">        <span class="comment">// username: null,</span></span><span class="line">        <span class="comment">// password: null,</span></span><span class="line">        <span class="comment">// traditional: false,</span></span><span class="line"></span><span class="line">        <span class="comment">// Create the request object; Microsoft failed to properly</span></span><span class="line">        <span class="comment">// implement the XMLHttpRequest in IE7 (can't request local files),</span></span><span class="line">        <span class="comment">// so we use the ActiveXObject when it is available</span></span><span class="line">        <span class="comment">// This function can be overriden by calling jQuery.ajaxSetup</span></span><span class="line">        <span class="comment">// 因为IE7中的window.XMLHttpRequest对象实现，对本地file协议的请求不支持，在window.ActiveXObject可用时，就用window.ActiveXObject</span></span><span class="line">        xhr: <span class="built_in">window</span>.XMLHttpRequest &amp;&amp; (<span class="built_in">window</span>.location.protocol !== <span class="string">"file:"</span> || !<span class="built_in">window</span>.ActiveXObject) ?</span><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">window</span>.XMLHttpRequest();</span><span class="line">            &#125; :</span><span class="line">            <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">                <span class="keyword">try</span> &#123;</span><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">window</span>.ActiveXObject(<span class="string">"Microsoft.XMLHTTP"</span>);</span><span class="line">                &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><span class="line">            &#125;,</span><span class="line">        <span class="comment">// 客户端ajax接受服务器返回的Content-Type的类型</span></span><span class="line">        accepts: &#123;</span><span class="line">            xml: <span class="string">"application/xml, text/xml"</span>,</span><span class="line">            html: <span class="string">"text/html"</span>,</span><span class="line">            script: <span class="string">"text/javascript, application/javascript"</span>,</span><span class="line">            json: <span class="string">"application/json, text/javascript"</span>,</span><span class="line">            text: <span class="string">"text/plain"</span>,</span><span class="line">            _default: <span class="string">"*/*"</span></span><span class="line">        &#125;</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// 可以在ajax请求的options里传进来一个error方法，在ajax请求发生错误之后运行此方法</span></span><span class="line">    handleError: <span class="function"><span class="keyword">function</span>(<span class="params"> s, xhr, status, e </span>) </span>&#123;</span><span class="line">        <span class="comment">// If a local callback was specified, fire it</span></span><span class="line">        <span class="keyword">if</span> ( s.error ) &#123;</span><span class="line">            <span class="comment">// 为当前的ajax请求指定一个error回调方法，并在ajax发生错误之后调用之</span></span><span class="line">            s.error.call( s.context || s, xhr, status, e );</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 同时触发全局设置的ajaxError事件</span></span><span class="line">        <span class="comment">// Fire the global callback</span></span><span class="line">        <span class="keyword">if</span> ( s.global ) &#123;</span><span class="line">            (s.context ? jQuery(s.context) : jQuery.event).trigger( <span class="string">"ajaxError"</span>, [xhr, s, e] );</span><span class="line">        &#125;</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// 当前激活的ajax请求数量</span></span><span class="line">    <span class="comment">// 这个计数器是用于控制全局的ajaxStop事件: if ( s.global &amp;&amp; ! --jQuery.active )</span></span><span class="line">    <span class="comment">// Counter for holding the number of active queries</span></span><span class="line">    active: <span class="number">0</span>,</span><span class="line"></span><span class="line">    <span class="comment">// 根据返回状态status，判断ajax请求是否成功</span></span><span class="line">    <span class="comment">// 对IE和Opera返回的状态做了特殊处理</span></span><span class="line">    <span class="comment">// Determines if an XMLHttpRequest was successful or not</span></span><span class="line">    httpSuccess: <span class="function"><span class="keyword">function</span>(<span class="params"> xhr </span>) </span>&#123;</span><span class="line">        <span class="keyword">try</span> &#123;</span><span class="line">            <span class="comment">// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450</span></span><span class="line">            <span class="keyword">return</span> !xhr.status &amp;&amp; location.protocol === <span class="string">"file:"</span> ||</span><span class="line">                <span class="comment">// Opera returns 0 when status is 304</span></span><span class="line">                ( xhr.status &gt;= <span class="number">200</span> &amp;&amp; xhr.status &lt; <span class="number">300</span> ) ||</span><span class="line">                xhr.status === <span class="number">304</span> || xhr.status === <span class="number">1223</span> || xhr.status === <span class="number">0</span>;</span><span class="line">        &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// httpNotModified()方法获取ajax请求的response headers中的Etag/Last-Modified，并设置到jQuery.etag/jQuery.lastModified这二个缓存对象中</span></span><span class="line">    <span class="comment">// Determines if an XMLHttpRequest returns NotModified</span></span><span class="line">    httpNotModified: <span class="function"><span class="keyword">function</span>(<span class="params"> xhr, url </span>) </span>&#123;</span><span class="line">        <span class="keyword">var</span> lastModified = xhr.getResponseHeader(<span class="string">"Last-Modified"</span>),</span><span class="line">            etag = xhr.getResponseHeader(<span class="string">"Etag"</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span> ( lastModified ) &#123;</span><span class="line">            jQuery.lastModified[url] = lastModified;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span> ( etag ) &#123;</span><span class="line">            jQuery.etag[url] = etag;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 当服务器端返回status为304(Opera为0)时，表示当前请求的内容没有被修改，浏览器直接从缓存里获取页面内容</span></span><span class="line">        <span class="comment">// Opera returns 0 when status is 304</span></span><span class="line">        <span class="keyword">return</span> xhr.status === <span class="number">304</span> || xhr.status === <span class="number">0</span>;</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// ajax请求的options中，可以设置一个.dataFilter( data, type )方法，用于处理ajax的response body</span></span><span class="line">    <span class="comment">// httpData()第二个参数type即s.dataType，后面第三个参数又传了整个s对象进来，所以第二个参数其实无必要放在方法参数中</span></span><span class="line">    httpData: <span class="function"><span class="keyword">function</span>(<span class="params"> xhr, type, s </span>) </span>&#123;</span><span class="line">        <span class="keyword">var</span> ct = xhr.getResponseHeader(<span class="string">"content-type"</span>) || <span class="string">""</span>,</span><span class="line">            xml = type === <span class="string">"xml"</span> || !type &amp;&amp; ct.indexOf(<span class="string">"xml"</span>) &gt;= <span class="number">0</span>,</span><span class="line">            <span class="comment">// 如果response headers中的Content-Type为xml，或者ajax请求的options中dataType为xml时，返回xhr.responseXML，其他返回xhr.responseText</span></span><span class="line">            data = xml ? xhr.responseXML : xhr.responseText;</span><span class="line"></span><span class="line">        <span class="keyword">if</span> ( xml &amp;&amp; data.documentElement.nodeName === <span class="string">"parsererror"</span> ) &#123;</span><span class="line">            jQuery.error( <span class="string">"parsererror"</span> );</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Allow a pre-filtering function to sanitize the response</span></span><span class="line">        <span class="comment">// s is checked to keep backwards compatibility</span></span><span class="line">        <span class="keyword">if</span> ( s &amp;&amp; s.dataFilter ) &#123;</span><span class="line">            <span class="comment">// 利用.dataFilter( data, type )方法对response body进行预处理</span></span><span class="line">            data = s.dataFilter( data, type );</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// The filter can actually parse the response</span></span><span class="line">        <span class="keyword">if</span> ( <span class="keyword">typeof</span> data === <span class="string">"string"</span> ) &#123;</span><span class="line">            <span class="comment">// Get the JavaScript object, if JSON is used.</span></span><span class="line">            <span class="keyword">if</span> ( type === <span class="string">"json"</span> || !type &amp;&amp; ct.indexOf(<span class="string">"json"</span>) &gt;= <span class="number">0</span> ) &#123;</span><span class="line">                <span class="comment">// 如果ajax请求返回的是json的返回类型，调用jQuery.parseJSON( data )方法处理data</span></span><span class="line">                data = jQuery.parseJSON( data );</span><span class="line"></span><span class="line">            <span class="comment">// If the type is "script", eval it in global context</span></span><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( type === <span class="string">"script"</span> || !type &amp;&amp; ct.indexOf(<span class="string">"javascript"</span>) &gt;= <span class="number">0</span> ) &#123;</span><span class="line">                <span class="comment">// 如果s.dataType设置为script，或者是ajax请求返回的response headers中指明Content-Type为javascript类型时，使用jQuery.globalEval( data )方法运行返回的data</span></span><span class="line">                jQuery.globalEval( data );</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> data;</span><span class="line">    &#125;,</span><span class="line"></span><span class="line">    <span class="comment">// Create a serialized representation of an array or object, suitable for use in a URL query string or Ajax request.</span></span><span class="line">    <span class="comment">// jQuery.param( obj, traditional )</span></span><span class="line">    <span class="comment">// obj: An array or object to serialize.</span></span><span class="line">    <span class="comment">// traditional: A Boolean indicating whether to perform a traditional "shallow" serialization.</span></span><span class="line"></span><span class="line">    <span class="comment">// Serialize an array of form elements or a set of</span></span><span class="line">    <span class="comment">// key/values into a query string</span></span><span class="line">    param: <span class="function"><span class="keyword">function</span>(<span class="params"> a, traditional </span>) </span>&#123;</span><span class="line">        <span class="keyword">var</span> s = [];</span><span class="line"></span><span class="line">        <span class="comment">// Set traditional to true for jQuery &gt;= 1.3.2 behavior.</span></span><span class="line">        <span class="keyword">if</span> ( traditional === <span class="literal">undefined</span> ) &#123;</span><span class="line">            traditional = jQuery.ajaxSettings.traditional;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// 如果参数a传入的是一个form elements的数组，或者是form element的jquery对象</span></span><span class="line">        <span class="comment">// 将其键值对拼成一个"="号连接的字符串，放到s数组中，最后合并字符串后用于ajax请求时的post body或者跟在get请求的URL后面</span></span><span class="line">        <span class="comment">// If an array was passed in, assume that it is an array of form elements.</span></span><span class="line">        <span class="keyword">if</span> ( jQuery.isArray(a) || a.jquery ) &#123;</span><span class="line">            <span class="comment">// Serialize the form elements</span></span><span class="line">            jQuery.each( a, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><span class="line">                add( <span class="keyword">this</span>.name, <span class="keyword">this</span>.value );</span><span class="line">            &#125;);</span><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><span class="line">            <span class="comment">// 如果传入的参数a是一个object直接量，调用buildParams()方法构造字符串，并放到s数组中</span></span><span class="line">            <span class="comment">// If traditional, encode the "old" way (the way 1.3.2 or older</span></span><span class="line">            <span class="comment">// did it), otherwise encode params recursively.</span></span><span class="line">            <span class="keyword">for</span> ( <span class="keyword">var</span> prefix <span class="keyword">in</span> a ) &#123;</span><span class="line">                buildParams( prefix, a[prefix] );</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Return the resulting serialization</span></span><span class="line">        <span class="keyword">return</span> s.join(<span class="string">"&amp;"</span>).replace(r20, <span class="string">"+"</span>);</span><span class="line"></span><span class="line">        <span class="comment">// 用于构造key=value结构的字符串，对于traditional为true与false的区别，可以查看后面myObject的测试例子(即官网上的例子)</span></span><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">buildParams</span>(<span class="params"> prefix, obj </span>) </span>&#123;</span><span class="line">            <span class="keyword">if</span> ( jQuery.isArray(obj) ) &#123;</span><span class="line">                <span class="comment">// Serialize array item.</span></span><span class="line">                jQuery.each( obj, <span class="function"><span class="keyword">function</span>(<span class="params"> i, v </span>) </span>&#123;</span><span class="line">                    <span class="keyword">if</span> ( traditional || <span class="regexp">/\[\]$/</span>.test( prefix ) ) &#123;</span><span class="line">                        <span class="comment">// Treat each array item as a scalar.</span></span><span class="line">                        <span class="comment">// 当traditional为true时，将数组作为一个直接量构建key=value字符串</span></span><span class="line">                        add( prefix, v );</span><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><span class="line">                        <span class="comment">// If array item is non-scalar (array or object), encode its</span></span><span class="line">                        <span class="comment">// numeric index to resolve deserialization ambiguity issues.</span></span><span class="line">                        <span class="comment">// Note that rack (as of 1.0.0) can't currently deserialize</span></span><span class="line">                        <span class="comment">// nested arrays properly, and attempting to do so may cause</span></span><span class="line">                        <span class="comment">// a server error. Possible fixes are to modify rack's</span></span><span class="line">                        <span class="comment">// deserialization algorithm or to provide an option or flag</span></span><span class="line">                        <span class="comment">// to force array serialization to be shallow.</span></span><span class="line">                        <span class="comment">// obj是数组时，如果数组中value是object/array时，生成的key会以方括号加上index值形式作为key</span></span><span class="line">                        <span class="comment">// 并且继续迭代调用buildParams()方法构建key，直到value为非object/array的直接量为止。</span></span><span class="line">                        <span class="comment">// 如果value不是object/value，则以"prefix+[]"形式作为key，如"b[]"这种形式</span></span><span class="line">                        buildParams( prefix + <span class="string">"["</span> + ( <span class="keyword">typeof</span> v === <span class="string">"object"</span> || jQuery.isArray(v) ? i : <span class="string">""</span> ) + <span class="string">"]"</span>, v );</span><span class="line">                    &#125;</span><span class="line">                &#125;);</span><span class="line"></span><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( !traditional &amp;&amp; obj != <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> obj === <span class="string">"object"</span> ) &#123;</span><span class="line">                <span class="comment">// Serialize object item.</span></span><span class="line">                <span class="comment">// 当obj是&#123;&#125;形式的object直接量，则以"prefix[k]"形式作为key，如果value为object/array，迭代调用buildParams()方法</span></span><span class="line">                jQuery.each( obj, <span class="function"><span class="keyword">function</span>(<span class="params"> k, v </span>) </span>&#123;</span><span class="line">                    buildParams( prefix + <span class="string">"["</span> + k + <span class="string">"]"</span>, v );</span><span class="line">                &#125;);</span><span class="line"></span><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><span class="line">                <span class="comment">// Serialize scalar item.</span></span><span class="line">                <span class="comment">// 当obj不再是object/array，调用add方法构建key=value字符串</span></span><span class="line">                <span class="comment">// 或者当obj不是array，并且traditional为true时，也直接调用add方法构建key=value字符串，其中当value为object直接量时，用encodeURIComponent()方法返回"%5Bobject%20Object%5D"，用decodeURIComponent("%5Bobject%20Object%5D")可得到"[object Object]"，因为jQuery.param()方法最后返回值中将"%20"替换为"+"了，所以jQuery.param()方法返回值中表现为"%5Bobject+Object%5D"</span></span><span class="line">                add( prefix, obj );</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"> key, value </span>) </span>&#123;</span><span class="line">            <span class="comment">// If value is a function, invoke it and return its value</span></span><span class="line">            value = jQuery.isFunction(value) ? value() : value;</span><span class="line">            <span class="comment">// key/value都使用encodeURIComponent()方法转义，转义后的"%20"空格会被替换为"+"</span></span><span class="line">            s[ s.length ] = <span class="built_in">encodeURIComponent</span>(key) + <span class="string">"="</span> + <span class="built_in">encodeURIComponent</span>(value);</span><span class="line">        &#125;</span><span class="line">    &#125;</span><span class="line">&#125;);</span></pre></td></tr></table></figure></p>
<p>jQuery中ajax请求的options参数，关于beforeSend, error, dataFilter, success, complete这些ajax回调方法的说明</p>
<p>在ajax请求的options中可以设置这5个回调方法： beforeSend, error, dataFilter, success and complete<br>分别会在ajax请求的不同阶段中调用，如下说明：</p>
<blockquote>
<ul>
<li>beforeSend(xhr, options): 在ajax请求发出前被调用，如果返回false，可以取消ajax请求，并触发全局ajaxStop事件。</li>
<li>error(xhr, status, errMsg): 在ajax请求失败的时候被调用，并触发全局的ajaxError事件。</li>
<li>dataFilter(data, dataType): 在ajax请求返回success之后，用此方法对ajax请求返回的response body作预处理，并且必须返回一个新的data作为ajax请求的返回结果。</li>
<li>success(data, status, xhr): 在ajsx请求成功后调用此回调方法。</li>
<li>complete(xhr, status): 在ajax请求完成之后运行，注意此方法除了在beforeSend()回调返回false，取消ajax请求之后不触发，其他无论ajax请求成功失败都会调用。</li>
</ul>
</blockquote>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/linux/2014/07/30/howto-manage-git-branch.html" rel="next" title="git分支管理">
                <i class="fa fa-chevron-left"></i>
                git分支管理
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/jquery/2014/07/30/jquery-src-attribute.html" rel="prev" title="jquery-1.4.2 attribute部分源码分析">
                <i class="fa fa-chevron-right"></i>
                jquery-1.4.2 attribute部分源码分析
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/blog/images/avatar.jpg" alt="yuweijun">
          <p class="site-author-name" itemprop="name">yuweijun</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">492</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yuweijun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/yuweijun" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <p class="post-toc-empty">This post does not have a Table of Contents</p>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-github"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuweijun</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist.KISS
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.ui.min.js"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
