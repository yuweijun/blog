<!doctype html>




<html class="theme-next mist">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">


















  

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">






  <link rel="alternate" href="/blog/atom.xml" title="一" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1">






<meta property="og:type" content="website">
<meta property="og:title" content="一">
<meta property="og:url" content="http://www.4e00.com/page/6/index.html">
<meta property="og:site_name" content="一">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide"},
    fancybox: false,
    motion: false,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://www.4e00.com/blog/page/6/">

  <title> 一 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/" class="brand" rel="start">
      <span class="site-title">一</span>
    </a>
  </div>
  <p class="site-subtitle">{"type":"编程笔记"}</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      <li class="menu-item menu-item-search">
        <a href="https://www.google.com.hk/search?q=site%3Ahttp://www.4e00.com/blog/" class="popup-trigger">
          <i class="menu-item-icon fa fa-search fa-fw"></i>Search
        </a>
      </li>
    </ul>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/java/2018/08/04/hotspot-source-code-mark-word.html" itemprop="url">
                  hotspot source code - mark word
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-08-04T22:46:49+08:00" content="2018-08-04">
              2018-08-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/f3108e56b502/src/share/vm/oops/markOop.hpp#30" target="_blank" rel="noopener">vm/oops/markOop.hpp</a> 第<code>30</code>行，关于<code>markOopDesc</code>数据结构的说明，<code>markOop</code>是指向<code>class markOopDesc</code>类型对象的指针，源码如下：</p>
<figure class="highlight hpp"><table><tr><td class="gutter"><pre><span class="line">30</span><span class="line">31</span><span class="line">32</span><span class="line">33</span><span class="line">34</span><span class="line">35</span><span class="line">36</span><span class="line">37</span><span class="line">38</span><span class="line">39</span><span class="line">40</span><span class="line">41</span><span class="line">42</span><span class="line">43</span><span class="line">44</span><span class="line">45</span><span class="line">46</span><span class="line">47</span><span class="line">48</span><span class="line">49</span><span class="line">50</span><span class="line">51</span><span class="line">52</span><span class="line">53</span><span class="line">54</span><span class="line">55</span><span class="line">56</span><span class="line">57</span><span class="line">58</span><span class="line">59</span><span class="line">60</span><span class="line">61</span><span class="line">62</span><span class="line">63</span><span class="line">64</span><span class="line">65</span><span class="line">66</span><span class="line">67</span><span class="line">68</span><span class="line">69</span><span class="line">70</span><span class="line">71</span><span class="line">72</span><span class="line">73</span><span class="line">74</span><span class="line">75</span><span class="line">76</span><span class="line">77</span><span class="line">78</span><span class="line">79</span><span class="line">80</span><span class="line">81</span><span class="line">82</span><span class="line">83</span><span class="line">84</span><span class="line">85</span><span class="line">86</span><span class="line">87</span><span class="line">88</span><span class="line">89</span><span class="line">90</span><span class="line">91</span><span class="line">92</span><span class="line">93</span><span class="line">94</span><span class="line">95</span><span class="line">96</span><span class="line">97</span><span class="line">98</span><span class="line">99</span><span class="line">100</span><span class="line">101</span><span class="line">102</span><span class="line">103</span><span class="line">104</span><span class="line">105</span><span class="line">106</span><span class="line">107</span><span class="line">108</span><span class="line">109</span><span class="line">110</span><span class="line">111</span><span class="line">112</span><span class="line">113</span><span class="line">114</span><span class="line">115</span><span class="line">116</span><span class="line">117</span><span class="line">118</span><span class="line">119</span><span class="line">120</span><span class="line">121</span><span class="line">122</span><span class="line">123</span><span class="line">124</span><span class="line">125</span><span class="line">126</span><span class="line">127</span><span class="line">128</span><span class="line">129</span><span class="line">130</span><span class="line">131</span><span class="line">132</span><span class="line">133</span><span class="line">134</span><span class="line">135</span><span class="line">136</span><span class="line">137</span><span class="line">138</span><span class="line">139</span><span class="line">140</span><span class="line">141</span><span class="line">142</span><span class="line">143</span><span class="line">144</span><span class="line">145</span><span class="line">146</span><span class="line">147</span><span class="line">148</span><span class="line">149</span><span class="line">150</span><span class="line">151</span><span class="line">152</span><span class="line">153</span><span class="line">154</span><span class="line">155</span><span class="line">156</span><span class="line">157</span><span class="line">158</span><span class="line">159</span><span class="line">160</span><span class="line">161</span><span class="line">162</span><span class="line">163</span><span class="line">164</span><span class="line">165</span><span class="line">166</span><span class="line">167</span><span class="line">168</span><span class="line">169</span><span class="line">170</span><span class="line">171</span><span class="line">172</span><span class="line">173</span><span class="line">174</span><span class="line">175</span><span class="line">176</span><span class="line">177</span><span class="line">178</span><span class="line">179</span><span class="line">180</span><span class="line">181</span><span class="line">182</span><span class="line">183</span><span class="line">184</span><span class="line">185</span><span class="line">186</span><span class="line">187</span><span class="line">188</span><span class="line">189</span><span class="line">190</span><span class="line">191</span><span class="line">192</span><span class="line">193</span><span class="line">194</span><span class="line">195</span><span class="line">196</span><span class="line">197</span><span class="line">198</span><span class="line">199</span><span class="line">200</span><span class="line">201</span><span class="line">202</span><span class="line">203</span><span class="line">204</span><span class="line">205</span><span class="line">206</span><span class="line">207</span><span class="line">208</span><span class="line">209</span><span class="line">210</span><span class="line">211</span><span class="line">212</span><span class="line">213</span><span class="line">214</span><span class="line">215</span><span class="line">216</span><span class="line">217</span><span class="line">218</span><span class="line">219</span><span class="line">220</span><span class="line">221</span><span class="line">222</span><span class="line">223</span><span class="line">224</span><span class="line">225</span><span class="line">226</span><span class="line">227</span><span class="line">228</span><span class="line">229</span><span class="line">230</span><span class="line">231</span><span class="line">232</span><span class="line">233</span><span class="line">234</span><span class="line">235</span><span class="line">236</span><span class="line">237</span><span class="line">238</span><span class="line">239</span><span class="line">240</span><span class="line">241</span><span class="line">242</span><span class="line">243</span><span class="line">244</span><span class="line">245</span><span class="line">246</span><span class="line">247</span><span class="line">248</span><span class="line">249</span><span class="line">250</span><span class="line">251</span><span class="line">252</span><span class="line">253</span><span class="line">254</span><span class="line">255</span><span class="line">256</span><span class="line">257</span><span class="line">258</span><span class="line">259</span><span class="line">260</span><span class="line">261</span><span class="line">262</span><span class="line">263</span><span class="line">264</span><span class="line">265</span><span class="line">266</span><span class="line">267</span><span class="line">268</span><span class="line">269</span><span class="line">270</span><span class="line">271</span><span class="line">272</span><span class="line">273</span><span class="line">274</span><span class="line">275</span><span class="line">276</span><span class="line">277</span><span class="line">278</span><span class="line">279</span><span class="line">280</span><span class="line">281</span><span class="line">282</span><span class="line">283</span><span class="line">284</span><span class="line">285</span><span class="line">286</span><span class="line">287</span><span class="line">288</span><span class="line">289</span><span class="line">290</span><span class="line">291</span><span class="line">292</span><span class="line">293</span><span class="line">294</span><span class="line">295</span><span class="line">296</span><span class="line">297</span><span class="line">298</span><span class="line">299</span><span class="line">300</span><span class="line">301</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// The markOop describes the header of an object.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Note that the mark is not a real oop but just a word.</span></span><span class="line"><span class="comment">// It is placed in the oop hierarchy for historical reasons.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Bit-format of an object header (most significant first, big endian layout below):</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//  32 bits:</span></span><span class="line"><span class="comment">//  --------</span></span><span class="line"><span class="comment">//             hash:25 ------------&gt;| age:4    biased_lock:1 lock:2 (normal object)</span></span><span class="line"><span class="comment">//             JavaThread*:23 epoch:2 age:4    biased_lock:1 lock:2 (biased object)</span></span><span class="line"><span class="comment">//             size:32 ------------------------------------------&gt;| (CMS free block)</span></span><span class="line"><span class="comment">//             PromotedObject*:29 ----------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//  64 bits:</span></span><span class="line"><span class="comment">//  --------</span></span><span class="line"><span class="comment">//  unused:25 hash:31 --&gt;| unused:1   age:4    biased_lock:1 lock:2 (normal object)</span></span><span class="line"><span class="comment">//  JavaThread*:54 epoch:2 unused:1   age:4    biased_lock:1 lock:2 (biased object)</span></span><span class="line"><span class="comment">//  PromotedObject*:61 ---------------------&gt;| promo_bits:3 -----&gt;| (CMS promoted object)</span></span><span class="line"><span class="comment">//  size:64 -----------------------------------------------------&gt;| (CMS free block)</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//  unused:25 hash:31 --&gt;| cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; normal object)</span></span><span class="line"><span class="comment">//  JavaThread*:54 epoch:2 cms_free:1 age:4    biased_lock:1 lock:2 (COOPs &amp;&amp; biased object)</span></span><span class="line"><span class="comment">//  narrowOop:32 unused:24 cms_free:1 unused:4 promo_bits:3 -----&gt;| (COOPs &amp;&amp; CMS promoted object)</span></span><span class="line"><span class="comment">//  unused:21 size:35 --&gt;| cms_free:1 unused:7 ------------------&gt;| (COOPs &amp;&amp; CMS free block)</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//  - hash contains the identity hash value: largest value is</span></span><span class="line"><span class="comment">//    31 bits, see os::random().  Also, 64-bit vm's require</span></span><span class="line"><span class="comment">//    a hash value no bigger than 32 bits because they will not</span></span><span class="line"><span class="comment">//    properly generate a mask larger than that: see library_call.cpp</span></span><span class="line"><span class="comment">//    and c1_CodePatterns_sparc.cpp.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//  - the biased lock pattern is used to bias a lock toward a given</span></span><span class="line"><span class="comment">//    thread. When this pattern is set in the low three bits, the lock</span></span><span class="line"><span class="comment">//    is either biased toward a given thread or "anonymously" biased,</span></span><span class="line"><span class="comment">//    indicating that it is possible for it to be biased. When the</span></span><span class="line"><span class="comment">//    lock is biased toward a given thread, locking and unlocking can</span></span><span class="line"><span class="comment">//    be performed by that thread without using atomic operations.</span></span><span class="line"><span class="comment">//    When a lock's bias is revoked, it reverts back to the normal</span></span><span class="line"><span class="comment">//    locking scheme described below.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//    Note that we are overloading the meaning of the "unlocked" state</span></span><span class="line"><span class="comment">//    of the header. Because we steal a bit from the age we can</span></span><span class="line"><span class="comment">//    guarantee that the bias pattern will never be seen for a truly</span></span><span class="line"><span class="comment">//    unlocked object.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//    Note also that the biased state contains the age bits normally</span></span><span class="line"><span class="comment">//    contained in the object header. Large increases in scavenge</span></span><span class="line"><span class="comment">//    times were seen when these bits were absent and an arbitrary age</span></span><span class="line"><span class="comment">//    assigned to all biased objects, because they tended to consume a</span></span><span class="line"><span class="comment">//    significant fraction of the eden semispaces and were not</span></span><span class="line"><span class="comment">//    promoted promptly, causing an increase in the amount of copying</span></span><span class="line"><span class="comment">//    performed. The runtime system aligns all JavaThread* pointers to</span></span><span class="line"><span class="comment">//    a very large value (currently 128 bytes (32bVM) or 256 bytes (64bVM))</span></span><span class="line"><span class="comment">//    to make room for the age bits &amp; the epoch bits (used in support of</span></span><span class="line"><span class="comment">//    biased locking), and for the CMS "freeness" bit in the 64bVM (+COOPs).</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//    [JavaThread* | epoch | age | 1 | 01]       lock is biased toward given thread</span></span><span class="line"><span class="comment">//    [0           | epoch | age | 1 | 01]       lock is anonymously biased</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//  - the two lock bits are used to describe three states: locked/unlocked and monitor.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//    [ptr             | 00]  locked             ptr points to real header on stack</span></span><span class="line"><span class="comment">//    [header      | 0 | 01]  unlocked           regular object header</span></span><span class="line"><span class="comment">//    [ptr             | 10]  monitor            inflated lock (header is wapped out)</span></span><span class="line"><span class="comment">//    [ptr             | 11]  marked             used by markSweep to mark an object</span></span><span class="line"><span class="comment">//                                               not valid at any other time</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">//    We assume that stack/thread pointers have the lowest two bits cleared.</span></span><span class="line"></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BasicLock</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectMonitor</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaThread</span>;</span></span><span class="line"></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">markOopDesc</span>:</span> <span class="keyword">public</span> oopDesc &#123;</span><span class="line"> <span class="keyword">private</span>:</span><span class="line">  <span class="comment">// Conversion</span></span><span class="line">  <span class="function"><span class="keyword">uintptr_t</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> (<span class="keyword">uintptr_t</span>) <span class="keyword">this</span>; &#125;</span><span class="line"></span><span class="line"> <span class="keyword">public</span>:</span><span class="line">  <span class="comment">// Constants</span></span><span class="line">  <span class="keyword">enum</span> &#123; age_bits                 = <span class="number">4</span>,</span><span class="line">         lock_bits                = <span class="number">2</span>,</span><span class="line">         biased_lock_bits         = <span class="number">1</span>,</span><span class="line">         max_hash_bits            = BitsPerWord - age_bits - lock_bits - biased_lock_bits,</span><span class="line">         hash_bits                = max_hash_bits &gt; <span class="number">31</span> ? <span class="number">31</span> : max_hash_bits,</span><span class="line">         cms_bits                 = LP64_ONLY(<span class="number">1</span>) NOT_LP64(<span class="number">0</span>),</span><span class="line">         epoch_bits               = <span class="number">2</span></span><span class="line">  &#125;;</span><span class="line"></span><span class="line">  <span class="comment">// The biased locking code currently requires that the age bits be</span></span><span class="line">  <span class="comment">// contiguous to the lock bits.</span></span><span class="line">  <span class="keyword">enum</span> &#123; lock_shift               = <span class="number">0</span>,</span><span class="line">         biased_lock_shift        = lock_bits,</span><span class="line">         age_shift                = lock_bits + biased_lock_bits,</span><span class="line">         cms_shift                = age_shift + age_bits,</span><span class="line">         hash_shift               = cms_shift + cms_bits,</span><span class="line">         epoch_shift              = hash_shift</span><span class="line">  &#125;;</span><span class="line"></span><span class="line">  <span class="keyword">enum</span> &#123; lock_mask                = right_n_bits(lock_bits),</span><span class="line">         lock_mask_in_place       = lock_mask &lt;&lt; lock_shift,</span><span class="line">         biased_lock_mask         = right_n_bits(lock_bits + biased_lock_bits),</span><span class="line">         biased_lock_mask_in_place= biased_lock_mask &lt;&lt; lock_shift,</span><span class="line">         biased_lock_bit_in_place = <span class="number">1</span> &lt;&lt; biased_lock_shift,</span><span class="line">         age_mask                 = right_n_bits(age_bits),</span><span class="line">         age_mask_in_place        = age_mask &lt;&lt; age_shift,</span><span class="line">         epoch_mask               = right_n_bits(epoch_bits),</span><span class="line">         epoch_mask_in_place      = epoch_mask &lt;&lt; epoch_shift,</span><span class="line">         cms_mask                 = right_n_bits(cms_bits),</span><span class="line">         cms_mask_in_place        = cms_mask &lt;&lt; cms_shift</span><span class="line">#ifndef _WIN64</span><span class="line">         ,hash_mask               = right_n_bits(hash_bits),</span><span class="line">         hash_mask_in_place       = (address_word)hash_mask &lt;&lt; hash_shift</span><span class="line">#endif</span><span class="line">  &#125;;</span><span class="line"></span><span class="line">  <span class="comment">// Alignment of JavaThread pointers encoded in object header required by biased locking</span></span><span class="line">  <span class="keyword">enum</span> &#123; biased_lock_alignment    = <span class="number">2</span> &lt;&lt; (epoch_shift + epoch_bits)</span><span class="line">  &#125;;</span><span class="line"></span><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN64</span></span><span class="line">    <span class="comment">// These values are too big for Win64</span></span><span class="line">    <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">uintptr_t</span> hash_mask = right_n_bits(hash_bits);</span><span class="line">    <span class="keyword">const</span> <span class="keyword">static</span> <span class="keyword">uintptr_t</span> hash_mask_in_place  =</span><span class="line">                            (address_word)hash_mask &lt;&lt; hash_shift;</span><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><span class="line"></span><span class="line">  <span class="keyword">enum</span> &#123; locked_value             = <span class="number">0</span>,</span><span class="line">         unlocked_value           = <span class="number">1</span>,</span><span class="line">         monitor_value            = <span class="number">2</span>,</span><span class="line">         marked_value             = <span class="number">3</span>,</span><span class="line">         biased_lock_pattern      = <span class="number">5</span></span><span class="line">  &#125;;</span><span class="line"></span><span class="line">  <span class="keyword">enum</span> &#123; no_hash                  = <span class="number">0</span> &#125;;  <span class="comment">// no hash value assigned</span></span><span class="line"></span><span class="line">  <span class="keyword">enum</span> &#123; no_hash_in_place         = (address_word)no_hash &lt;&lt; hash_shift,</span><span class="line">         no_lock_in_place         = unlocked_value</span><span class="line">  &#125;;</span><span class="line"></span><span class="line">  <span class="keyword">enum</span> &#123; max_age                  = age_mask &#125;;</span><span class="line"></span><span class="line">  <span class="keyword">enum</span> &#123; max_bias_epoch           = epoch_mask &#125;;</span><span class="line"></span><span class="line">  <span class="comment">// Biased Locking accessors.</span></span><span class="line">  <span class="comment">// These must be checked by all code which calls into the</span></span><span class="line">  <span class="comment">// ObjectSynchronizer and other code. The biasing is not understood</span></span><span class="line">  <span class="comment">// by the lower-level CAS-based locking code, although the runtime</span></span><span class="line">  <span class="comment">// fixes up biased locks to be compatible with it when a bias is</span></span><span class="line">  <span class="comment">// revoked.</span></span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">has_bias_pattern</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> (mask_bits(value(), biased_lock_mask_in_place) == biased_lock_pattern);</span><span class="line">  &#125;</span><span class="line">  <span class="function">JavaThread* <span class="title">biased_locker</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    assert(has_bias_pattern(), <span class="string">"should not call this otherwise"</span>);</span><span class="line">    <span class="keyword">return</span> (JavaThread*) ((<span class="keyword">intptr_t</span>) (mask_bits(value(), ~(biased_lock_mask_in_place | age_mask_in_place | epoch_mask_in_place))));</span><span class="line">  &#125;</span><span class="line">  <span class="comment">// Indicates that the mark has the bias bit set but that it has not</span></span><span class="line">  <span class="comment">// yet been biased toward a particular thread</span></span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_biased_anonymously</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> (has_bias_pattern() &amp;&amp; (biased_locker() == <span class="literal">NULL</span>));</span><span class="line">  &#125;</span><span class="line">  <span class="comment">// Indicates epoch in which this bias was acquired. If the epoch</span></span><span class="line">  <span class="comment">// changes due to too many bias revocations occurring, the biases</span></span><span class="line">  <span class="comment">// from the previous epochs are all considered invalid.</span></span><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">bias_epoch</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    assert(has_bias_pattern(), <span class="string">"should not call this otherwise"</span>);</span><span class="line">    <span class="keyword">return</span> (mask_bits(value(), epoch_mask_in_place) &gt;&gt; epoch_shift);</span><span class="line">  &#125;</span><span class="line">  <span class="function">markOop <span class="title">set_bias_epoch</span><span class="params">(<span class="keyword">int</span> epoch)</span> </span>&#123;</span><span class="line">    assert(has_bias_pattern(), <span class="string">"should not call this otherwise"</span>);</span><span class="line">    assert((epoch &amp; (~epoch_mask)) == <span class="number">0</span>, <span class="string">"epoch overflow"</span>);</span><span class="line">    <span class="keyword">return</span> markOop(mask_bits(value(), ~epoch_mask_in_place) | (epoch &lt;&lt; epoch_shift));</span><span class="line">  &#125;</span><span class="line">  <span class="function">markOop <span class="title">incr_bias_epoch</span><span class="params">()</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> set_bias_epoch((<span class="number">1</span> + bias_epoch()) &amp; epoch_mask);</span><span class="line">  &#125;</span><span class="line">  <span class="comment">// Prototype mark for initialization</span></span><span class="line">  <span class="function"><span class="keyword">static</span> markOop <span class="title">biased_locking_prototype</span><span class="params">()</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> markOop( biased_lock_pattern );</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// lock accessors (note that these assume lock_shift == 0)</span></span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_locked</span><span class="params">()</span>   <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> (mask_bits(value(), lock_mask_in_place) != unlocked_value);</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_unlocked</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> (mask_bits(value(), biased_lock_mask_in_place) == unlocked_value);</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_marked</span><span class="params">()</span>   <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> (mask_bits(value(), lock_mask_in_place) == marked_value);</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_neutral</span><span class="params">()</span>  <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> (mask_bits(value(), biased_lock_mask_in_place) == unlocked_value); &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Special temporary state of the markOop while being inflated.</span></span><span class="line">  <span class="comment">// Code that looks at mark outside a lock need to take this into account.</span></span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_being_inflated</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> (value() == <span class="number">0</span>); &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Distinguished markword value - used when inflating over</span></span><span class="line">  <span class="comment">// an existing stacklock.  0 indicates the markword is "BUSY".</span></span><span class="line">  <span class="comment">// Lockword mutators that use a LD...CAS idiom should always</span></span><span class="line">  <span class="comment">// check for and avoid overwriting a 0 value installed by some</span></span><span class="line">  <span class="comment">// other thread.  (They should spin or block instead.  The 0 value</span></span><span class="line">  <span class="comment">// is transient and *should* be short-lived).</span></span><span class="line">  <span class="function"><span class="keyword">static</span> markOop <span class="title">INFLATING</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> (markOop) <span class="number">0</span>; &#125;    <span class="comment">// inflate-in-progress</span></span><span class="line"></span><span class="line">  <span class="comment">// Should this header be preserved during GC?</span></span><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">must_be_preserved</span><span class="params">(oop obj_containing_mark)</span> <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">must_be_preserved_with_bias</span><span class="params">(oop obj_containing_mark)</span> <span class="keyword">const</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Should this header (including its age bits) be preserved in the</span></span><span class="line">  <span class="comment">// case of a promotion failure during scavenge?</span></span><span class="line">  <span class="comment">// Note that we special case this situation. We want to avoid</span></span><span class="line">  <span class="comment">// calling BiasedLocking::preserve_marks()/restore_marks() (which</span></span><span class="line">  <span class="comment">// decrease the number of mark words that need to be preserved</span></span><span class="line">  <span class="comment">// during GC) during each scavenge. During scavenges in which there</span></span><span class="line">  <span class="comment">// is no promotion failure, we actually don't need to call the above</span></span><span class="line">  <span class="comment">// routines at all, since we don't mutate and re-initialize the</span></span><span class="line">  <span class="comment">// marks of promoted objects using init_mark(). However, during</span></span><span class="line">  <span class="comment">// scavenges which result in promotion failure, we do re-initialize</span></span><span class="line">  <span class="comment">// the mark words of objects, meaning that we should have called</span></span><span class="line">  <span class="comment">// these mark word preservation routines. Currently there's no good</span></span><span class="line">  <span class="comment">// place in which to call them in any of the scavengers (although</span></span><span class="line">  <span class="comment">// guarded by appropriate locks we could make one), but the</span></span><span class="line">  <span class="comment">// observation is that promotion failures are quite rare and</span></span><span class="line">  <span class="comment">// reducing the number of mark words preserved during them isn't a</span></span><span class="line">  <span class="comment">// high priority.</span></span><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">must_be_preserved_for_promotion_failure</span><span class="params">(oop obj_containing_mark)</span> <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">must_be_preserved_with_bias_for_promotion_failure</span><span class="params">(oop obj_containing_mark)</span> <span class="keyword">const</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Should this header be preserved during a scavenge where CMS is</span></span><span class="line">  <span class="comment">// the old generation?</span></span><span class="line">  <span class="comment">// (This is basically the same body as must_be_preserved_for_promotion_failure(),</span></span><span class="line">  <span class="comment">// but takes the Klass* as argument instead)</span></span><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">must_be_preserved_for_cms_scavenge</span><span class="params">(Klass* klass_of_obj_containing_mark)</span> <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">must_be_preserved_with_bias_for_cms_scavenge</span><span class="params">(Klass* klass_of_obj_containing_mark)</span> <span class="keyword">const</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// WARNING: The following routines are used EXCLUSIVELY by</span></span><span class="line">  <span class="comment">// synchronization functions. They are not really gc safe.</span></span><span class="line">  <span class="comment">// They must get updated if markOop layout get changed.</span></span><span class="line">  <span class="function">markOop <span class="title">set_unlocked</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> markOop(value() | unlocked_value);</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">has_locker</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> ((value() &amp; lock_mask_in_place) == locked_value);</span><span class="line">  &#125;</span><span class="line">  <span class="function">BasicLock* <span class="title">locker</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    assert(has_locker(), <span class="string">"check"</span>);</span><span class="line">    <span class="keyword">return</span> (BasicLock*) value();</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">has_monitor</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> ((value() &amp; monitor_value) != <span class="number">0</span>);</span><span class="line">  &#125;</span><span class="line">  <span class="function">ObjectMonitor* <span class="title">monitor</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    assert(has_monitor(), <span class="string">"check"</span>);</span><span class="line">    <span class="comment">// Use xor instead of &amp;~ to provide one extra tag-bit check.</span></span><span class="line">    <span class="keyword">return</span> (ObjectMonitor*) (value() ^ monitor_value);</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">has_displaced_mark_helper</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    <span class="keyword">return</span> ((value() &amp; unlocked_value) == <span class="number">0</span>);</span><span class="line">  &#125;</span><span class="line">  <span class="function">markOop <span class="title">displaced_mark_helper</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    assert(has_displaced_mark_helper(), <span class="string">"check"</span>);</span><span class="line">    <span class="keyword">intptr_t</span> ptr = (value() &amp; ~monitor_value);</span><span class="line">    <span class="keyword">return</span> *(markOop*)ptr;</span><span class="line">  &#125;</span><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_displaced_mark_helper</span><span class="params">(markOop m)</span> <span class="keyword">const</span> </span>&#123;</span><span class="line">    assert(has_displaced_mark_helper(), <span class="string">"check"</span>);</span><span class="line">    <span class="keyword">intptr_t</span> ptr = (value() &amp; ~monitor_value);</span><span class="line">    *(markOop*)ptr = m;</span><span class="line">  &#125;</span></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/blog/java/2018/08/04/hotspot-source-code-mark-word.html#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/java/2018/08/04/hotspot-source-code-klass-and-oop.html" itemprop="url">
                  hotspot source code - klass and oop
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-08-04T22:43:41+08:00" content="2018-08-04">
              2018-08-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="OOP-Klass-二分模型"><a href="#OOP-Klass-二分模型" class="headerlink" title="OOP-Klass 二分模型"></a>OOP-Klass 二分模型</h2><ol>
<li><code>OOP</code>是指<code>ordinary object pointer</code>，普通对象指针，用来描述 JVM 中的实例对象的实例信息。</li>
<li><code>Klass</code>是 Java 类在 C++ 中的对等体，用来描述 Java 类，在其中包括了类的相关信息。</li>
</ol>
<p>这个模型也体现了编程设计的最根本的一个设计原则：分离变化的与不变化的部分。其中 Java 实例信息相对 Java 类而言，是包含了变化的部分数据，Java 类描述了类的行为和类信息，为所有实例所共享。这个二分模型中的 Klass 向 JVM 提供了二个功能：</p>
<ol>
<li>实现语言层面的 Java 类</li>
<li>实现 Java 对象的方法分发(dispatch)功能</li>
</ol>
<h3 id="oop-基类"><a href="#oop-基类" class="headerlink" title="oop 基类"></a>oop 基类</h3><p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/f3108e56b502/src/share/vm/oops/oop.hpp#35" target="_blank" rel="noopener">vm/oops/oop.hpp</a> 第<code>35</code>行，<code>**OopDesc</code>类型都继承自<code>class oopDesc</code>，源码如下：</p>
<figure class="highlight hpp"><table><tr><td class="gutter"><pre><span class="line">30</span><span class="line">31</span><span class="line">32</span><span class="line">33</span><span class="line">34</span><span class="line">35</span><span class="line">36</span><span class="line">37</span><span class="line">38</span><span class="line">39</span><span class="line">40</span><span class="line">41</span><span class="line">42</span><span class="line">43</span><span class="line">44</span><span class="line">45</span><span class="line">46</span><span class="line">47</span><span class="line">48</span><span class="line">49</span><span class="line">50</span><span class="line">51</span><span class="line">52</span><span class="line">53</span><span class="line">54</span><span class="line">55</span><span class="line">56</span><span class="line">57</span><span class="line">58</span><span class="line">59</span><span class="line">60</span><span class="line">61</span><span class="line">62</span><span class="line">63</span><span class="line">64</span><span class="line">65</span><span class="line">66</span><span class="line">67</span><span class="line">68</span><span class="line">69</span><span class="line">70</span><span class="line">71</span><span class="line">72</span><span class="line">73</span><span class="line">74</span><span class="line">75</span><span class="line">76</span><span class="line">77</span><span class="line">78</span><span class="line">79</span><span class="line">80</span><span class="line">81</span><span class="line">82</span><span class="line">83</span><span class="line">84</span><span class="line">85</span><span class="line">86</span><span class="line">87</span><span class="line">88</span><span class="line">89</span><span class="line">90</span><span class="line">91</span><span class="line">92</span><span class="line">93</span><span class="line">94</span><span class="line">95</span><span class="line">96</span><span class="line">97</span><span class="line">98</span><span class="line">99</span><span class="line">100</span><span class="line">101</span><span class="line">102</span><span class="line">103</span><span class="line">104</span><span class="line">105</span><span class="line">106</span><span class="line">107</span><span class="line">108</span><span class="line">109</span><span class="line">110</span><span class="line">111</span><span class="line">112</span><span class="line">113</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// oopDesc is the top baseclass for objects classes.  The &#123;name&#125;Desc classes describe</span></span><span class="line"><span class="comment">// the format of Java objects so the fields can be accessed from C++.</span></span><span class="line"><span class="comment">// oopDesc is abstract.</span></span><span class="line"><span class="comment">// (see oopHierarchy for complete oop class hierarchy)</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// no virtual functions allowed</span></span><span class="line"></span><span class="line"><span class="comment">// store into oop with store check</span></span><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">void</span> <span class="title">oop_store</span>(<span class="title">T</span>* <span class="title">p</span>, <span class="title">oop</span> <span class="title">v</span>);</span></span><span class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">void</span> <span class="title">oop_store</span>(<span class="title">volatile</span> <span class="title">T</span>* <span class="title">p</span>, <span class="title">oop</span> <span class="title">v</span>);</span></span><span class="line"></span><span class="line"><span class="keyword">extern</span> <span class="keyword">bool</span> always_do_update_barrier;</span><span class="line"></span><span class="line"><span class="comment">// Forward declarations.</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OopClosure</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScanClosure</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastScanClosure</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilteringClosure</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BarrierSet</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CMSIsAliveClosure</span>;</span></span><span class="line"></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PSPromotionManager</span>;</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParCompactionManager</span>;</span></span><span class="line"></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">oopDesc</span> &#123;</span></span><span class="line">  <span class="keyword">friend</span> <span class="class"><span class="keyword">class</span> <span class="title">VMStructs</span>;</span></span><span class="line"> <span class="keyword">private</span>:</span><span class="line">  <span class="keyword">volatile</span> markOop  _mark;</span><span class="line">  <span class="keyword">union</span> _metadata &#123;</span><span class="line">    Klass*      _klass;</span><span class="line">    narrowKlass _compressed_klass;</span><span class="line">  &#125; _metadata;</span><span class="line"></span><span class="line">  <span class="comment">// Fast access to barrier set.  Must be initialized.</span></span><span class="line">  <span class="keyword">static</span> BarrierSet* _bs;</span><span class="line"></span><span class="line"> <span class="keyword">public</span>:</span><span class="line">  <span class="function">markOop  <span class="title">mark</span><span class="params">()</span> <span class="keyword">const</span>         </span>&#123; <span class="keyword">return</span> _mark; &#125;</span><span class="line">  <span class="function">markOop* <span class="title">mark_addr</span><span class="params">()</span> <span class="keyword">const</span>    </span>&#123; <span class="keyword">return</span> (markOop*) &amp;_mark; &#125;</span><span class="line"></span><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_mark</span><span class="params">(<span class="keyword">volatile</span> markOop m)</span>      </span>&#123; _mark = m;   &#125;</span><span class="line"></span><span class="line">  <span class="function"><span class="keyword">void</span>    <span class="title">release_set_mark</span><span class="params">(markOop m)</span></span>;</span><span class="line">  <span class="function">markOop <span class="title">cas_set_mark</span><span class="params">(markOop new_mark, markOop old_mark)</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Used only to re-initialize the mark word (e.g., of promoted</span></span><span class="line">  <span class="comment">// objects during a GC) -- requires a valid klass pointer</span></span><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">init_mark</span><span class="params">()</span></span>;</span><span class="line"></span><span class="line">  <span class="function">Klass* <span class="title">klass</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><span class="line">  <span class="function">Klass* <span class="title">klass_or_null</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">volatile</span></span>;</span><span class="line">  <span class="function">Klass** <span class="title">klass_addr</span><span class="params">()</span></span>;</span><span class="line">  <span class="function">narrowKlass* <span class="title">compressed_klass_addr</span><span class="params">()</span></span>;</span><span class="line"></span><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_klass</span><span class="params">(Klass* k)</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// For klass field compression</span></span><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">klass_gap</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_klass_gap</span><span class="params">(<span class="keyword">int</span> z)</span></span>;</span><span class="line">  <span class="comment">// For when the klass pointer is being used as a linked list "next" field.</span></span><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">set_klass_to_list_ptr</span><span class="params">(oop k)</span></span>;</span><span class="line">  <span class="function">oop <span class="title">list_ptr_from_klass</span><span class="params">()</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// size of object header, aligned to platform wordSize</span></span><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">header_size</span><span class="params">()</span>          </span>&#123; <span class="keyword">return</span> <span class="keyword">sizeof</span>(oopDesc)/HeapWordSize; &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Returns whether this is an instance of k or an instance of a subclass of k</span></span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_a</span><span class="params">(Klass* k)</span>  <span class="keyword">const</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Returns the actual oop size of the object</span></span><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Sometimes (for complicated concurrency-related reasons), it is useful</span></span><span class="line">  <span class="comment">// to be able to figure out the size of an object knowing its klass.</span></span><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">size_given_klass</span><span class="params">(Klass* klass)</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// type test operations (inlined in oop.inline.h)</span></span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_instance</span><span class="params">()</span>            <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_instanceMirror</span><span class="params">()</span>      <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_instanceClassLoader</span><span class="params">()</span> <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_instanceRef</span><span class="params">()</span>         <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_array</span><span class="params">()</span>               <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_objArray</span><span class="params">()</span>            <span class="keyword">const</span></span>;</span><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">is_typeArray</span><span class="params">()</span>           <span class="keyword">const</span></span>;</span></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/blog/java/2018/08/04/hotspot-source-code-klass-and-oop.html#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/java/2018/08/04/hotspot-source-code-class-file-parse.html" itemprop="url">
                  hotspot source code - class file parse
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-08-04T22:01:46+08:00" content="2018-08-04">
              2018-08-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>Java 的版本号定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">80</span><span class="line">81</span><span class="line">82</span><span class="line">83</span><span class="line">84</span><span class="line">85</span><span class="line">86</span><span class="line">87</span><span class="line">88</span><span class="line">89</span><span class="line">90</span><span class="line">91</span><span class="line">92</span><span class="line">93</span><span class="line">94</span><span class="line">95</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Used for two backward compatibility reasons:</span></span><span class="line"><span class="comment">// - to check for new additions to the class file format in JDK1.5</span></span><span class="line"><span class="comment">// - to check for bug fixes in the format checker in JDK1.5</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_1_5_VERSION                  49</span></span><span class="line"></span><span class="line"><span class="comment">// Used for backward compatibility reasons:</span></span><span class="line"><span class="comment">// - to check for javac bug fixes that happened after 1.5</span></span><span class="line"><span class="comment">// - also used as the max version when running in jdk6</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_6_VERSION                    50</span></span><span class="line"></span><span class="line"><span class="comment">// Used for backward compatibility reasons:</span></span><span class="line"><span class="comment">// - to check NameAndType_info signatures more aggressively</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_7_VERSION                    51</span></span><span class="line"></span><span class="line"><span class="comment">// Extension method support.</span></span><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JAVA_8_VERSION                    52</span></span></pre></td></tr></table></figure>
<p>Java7 常量池中新增加了3个常量类型，如<code>InvokeDynamic</code>，<code>MethodHandle</code>和<code>MethodType</code>，Java7 发布时 JVM 中新增加了一个指令<code>invokedynamic</code>，在常量池解析时就会碰到与这个指令直接相关的新增加的3个常量类型和新增加的属性<code>BootstrapMethods</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">97</span><span class="line">98</span><span class="line">99</span><span class="line">100</span><span class="line">101</span><span class="line">102</span><span class="line">103</span><span class="line">104</span><span class="line">105</span><span class="line">106</span><span class="line">107</span><span class="line">108</span><span class="line">109</span><span class="line">110</span><span class="line">111</span><span class="line">112</span><span class="line">113</span><span class="line">114</span><span class="line">115</span><span class="line">116</span><span class="line">117</span><span class="line">118</span><span class="line">119</span><span class="line">120</span><span class="line">121</span><span class="line">122</span><span class="line">123</span><span class="line">124</span><span class="line">125</span><span class="line">126</span><span class="line">127</span><span class="line">128</span><span class="line">129</span><span class="line">130</span><span class="line">131</span><span class="line">132</span><span class="line">133</span><span class="line">134</span><span class="line">135</span><span class="line">136</span><span class="line">137</span><span class="line">138</span><span class="line">139</span><span class="line">140</span><span class="line">141</span><span class="line">142</span><span class="line">143</span><span class="line">144</span><span class="line">145</span><span class="line">146</span><span class="line">147</span><span class="line">148</span><span class="line">149</span><span class="line">150</span><span class="line">151</span><span class="line">152</span><span class="line">153</span><span class="line">154</span><span class="line">155</span><span class="line">156</span><span class="line">157</span><span class="line">158</span><span class="line">159</span><span class="line">160</span><span class="line">161</span><span class="line">162</span><span class="line">163</span><span class="line">164</span><span class="line">165</span><span class="line">166</span><span class="line">167</span><span class="line">168</span><span class="line">169</span><span class="line">170</span><span class="line">171</span><span class="line">172</span><span class="line">173</span><span class="line">174</span><span class="line">175</span><span class="line">176</span><span class="line">177</span><span class="line">178</span><span class="line">179</span><span class="line">180</span><span class="line">181</span><span class="line">182</span><span class="line">183</span><span class="line">184</span><span class="line">185</span><span class="line">186</span><span class="line">187</span><span class="line">188</span><span class="line">189</span><span class="line">190</span><span class="line">191</span><span class="line">192</span><span class="line">193</span><span class="line">194</span><span class="line">195</span><span class="line">196</span><span class="line">197</span><span class="line">198</span><span class="line">199</span><span class="line">200</span><span class="line">201</span><span class="line">202</span><span class="line">203</span><span class="line">204</span><span class="line">205</span><span class="line">206</span><span class="line">207</span><span class="line">208</span><span class="line">209</span><span class="line">210</span><span class="line">211</span><span class="line">212</span><span class="line">213</span><span class="line">214</span><span class="line">215</span><span class="line">216</span><span class="line">217</span><span class="line">218</span><span class="line">219</span><span class="line">220</span><span class="line">221</span><span class="line">222</span><span class="line">223</span><span class="line">224</span><span class="line">225</span><span class="line">226</span><span class="line">227</span><span class="line">228</span><span class="line">229</span><span class="line">230</span><span class="line">231</span><span class="line">232</span><span class="line">233</span><span class="line">234</span><span class="line">235</span><span class="line">236</span><span class="line">237</span><span class="line">238</span><span class="line">239</span><span class="line">240</span><span class="line">241</span><span class="line">242</span><span class="line">243</span><span class="line">244</span><span class="line">245</span><span class="line">246</span><span class="line">247</span><span class="line">248</span><span class="line">249</span><span class="line">250</span><span class="line">251</span><span class="line">252</span><span class="line">253</span><span class="line">254</span><span class="line">255</span><span class="line">256</span><span class="line">257</span><span class="line">258</span><span class="line">259</span><span class="line">260</span><span class="line">261</span><span class="line">262</span><span class="line">263</span><span class="line">264</span><span class="line">265</span><span class="line">266</span><span class="line">267</span><span class="line">268</span><span class="line">269</span><span class="line">270</span><span class="line">271</span><span class="line">272</span><span class="line">273</span><span class="line">274</span><span class="line">275</span><span class="line">276</span><span class="line">277</span><span class="line">278</span><span class="line">279</span><span class="line">280</span><span class="line">281</span><span class="line">282</span><span class="line">283</span><span class="line">284</span><span class="line">285</span><span class="line">286</span><span class="line">287</span><span class="line">288</span><span class="line">289</span><span class="line">290</span><span class="line">291</span><span class="line">292</span><span class="line">293</span><span class="line">294</span><span class="line">295</span><span class="line">296</span><span class="line">297</span><span class="line">298</span><span class="line">299</span><span class="line">300</span><span class="line">301</span><span class="line">302</span><span class="line">303</span><span class="line">304</span><span class="line">305</span><span class="line">306</span><span class="line">307</span><span class="line">308</span><span class="line">309</span><span class="line">310</span><span class="line">311</span><span class="line">312</span><span class="line">313</span><span class="line">314</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ClassFileParser::parse_constant_pool_entries</span><span class="params">(<span class="keyword">int</span> length, TRAPS)</span> </span>&#123;</span><span class="line">  <span class="comment">// Use a local copy of ClassFileStream. It helps the C++ compiler to optimize</span></span><span class="line">  <span class="comment">// this function (_current can be allocated in a register, with scalar</span></span><span class="line">  <span class="comment">// replacement of aggregates). The _current pointer is copied back to</span></span><span class="line">  <span class="comment">// stream() when this function returns. DON'T call another method within</span></span><span class="line">  <span class="comment">// this method that uses stream().</span></span><span class="line">  ClassFileStream* cfs0 = stream();</span><span class="line">  ClassFileStream cfs1 = *cfs0;</span><span class="line">  ClassFileStream* cfs = &amp;cfs1;</span><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ASSERT</span></span><span class="line">  assert(cfs-&gt;allocated_on_stack(),<span class="string">"should be local"</span>);</span><span class="line">  u1* old_current = cfs0-&gt;current();</span><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><span class="line">  <span class="function">Handle <span class="title">class_loader</span><span class="params">(THREAD, _loader_data-&gt;class_loader())</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Used for batching symbol allocations.</span></span><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* names[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">int</span> lengths[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">int</span> indices[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> hashValues[SymbolTable::symbol_alloc_batch_size];</span><span class="line">  <span class="keyword">int</span> names_count = <span class="number">0</span>;</span><span class="line"></span><span class="line">  <span class="comment">// parsing  Index 0 is unused</span></span><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">1</span>; index &lt; length; index++) &#123;</span><span class="line">    <span class="comment">// Each of the following case guarantees one more byte in the stream</span></span><span class="line">    <span class="comment">// for the following tag or the access_flags following constant pool,</span></span><span class="line">    <span class="comment">// so we don't need bounds-check for reading tag.</span></span><span class="line">    u1 tag = cfs-&gt;get_u1_fast();</span><span class="line">    <span class="keyword">switch</span> (tag) &#123;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Class :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">3</span>, CHECK);  <span class="comment">// name_index, tag/access_flags</span></span><span class="line">          u2 name_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;klass_index_at_put(index, name_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Fieldref :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// class_index, name_and_type_index, tag/access_flags</span></span><span class="line">          u2 class_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;field_at_put(index, class_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Methodref :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// class_index, name_and_type_index, tag/access_flags</span></span><span class="line">          u2 class_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;method_at_put(index, class_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_InterfaceMethodref :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// class_index, name_and_type_index, tag/access_flags</span></span><span class="line">          u2 class_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;interface_method_at_put(index, class_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_String :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">3</span>, CHECK);  <span class="comment">// string_index, tag/access_flags</span></span><span class="line">          u2 string_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;string_index_at_put(index, string_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_MethodHandle :</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_MethodType :</span><span class="line">        <span class="keyword">if</span> (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) &#123;</span><span class="line">          classfile_parse_error(</span><span class="line">            <span class="string">"Class file version does not support constant tag %u in class file %s"</span>,</span><span class="line">            tag, CHECK);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span> (!EnableInvokeDynamic) &#123;</span><span class="line">          classfile_parse_error(</span><span class="line">            <span class="string">"This JVM does not support constant tag %u in class file %s"</span>,</span><span class="line">            tag, CHECK);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span> (tag == JVM_CONSTANT_MethodHandle) &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">4</span>, CHECK);  <span class="comment">// ref_kind, method_index, tag/access_flags</span></span><span class="line">          u1 ref_kind = cfs-&gt;get_u1_fast();</span><span class="line">          u2 method_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;method_handle_index_at_put(index, ref_kind, method_index);</span><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag == JVM_CONSTANT_MethodType) &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">3</span>, CHECK);  <span class="comment">// signature_index, tag/access_flags</span></span><span class="line">          u2 signature_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;method_type_index_at_put(index, signature_index);</span><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><span class="line">          ShouldNotReachHere();</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_InvokeDynamic :</span><span class="line">        &#123;</span><span class="line">          <span class="keyword">if</span> (_major_version &lt; Verifier::INVOKEDYNAMIC_MAJOR_VERSION) &#123;</span><span class="line">            classfile_parse_error(</span><span class="line">              <span class="string">"Class file version does not support constant tag %u in class file %s"</span>,</span><span class="line">              tag, CHECK);</span><span class="line">          &#125;</span><span class="line">          <span class="keyword">if</span> (!EnableInvokeDynamic) &#123;</span><span class="line">            classfile_parse_error(</span><span class="line">              <span class="string">"This JVM does not support constant tag %u in class file %s"</span>,</span><span class="line">              tag, CHECK);</span><span class="line">          &#125;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// bsm_index, nt, tag/access_flags</span></span><span class="line">          u2 bootstrap_specifier_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 name_and_type_index = cfs-&gt;get_u2_fast();</span><span class="line">          <span class="keyword">if</span> (_max_bootstrap_specifier_index &lt; (<span class="keyword">int</span>) bootstrap_specifier_index)</span><span class="line">            _max_bootstrap_specifier_index = (<span class="keyword">int</span>) bootstrap_specifier_index;  <span class="comment">// collect for later</span></span><span class="line">          _cp-&gt;invoke_dynamic_at_put(index, bootstrap_specifier_index, name_and_type_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Integer :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u4 bytes = cfs-&gt;get_u4_fast();</span><span class="line">          _cp-&gt;int_at_put(index, (jint) bytes);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Float :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u4 bytes = cfs-&gt;get_u4_fast();</span><span class="line">          _cp-&gt;float_at_put(index, *(jfloat*)&amp;bytes);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Long :</span><span class="line">        <span class="comment">// A mangled type might cause you to overrun allocated memory</span></span><span class="line">        guarantee_property(index+<span class="number">1</span> &lt; length,</span><span class="line">                           <span class="string">"Invalid constant pool entry %u in class file %s"</span>,</span><span class="line">                           index, CHECK);</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">9</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u8 bytes = cfs-&gt;get_u8_fast();</span><span class="line">          _cp-&gt;long_at_put(index, bytes);</span><span class="line">        &#125;</span><span class="line">        index++;   <span class="comment">// Skip entry following eigth-byte constant, see JVM book p. 98</span></span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Double :</span><span class="line">        <span class="comment">// A mangled type might cause you to overrun allocated memory</span></span><span class="line">        guarantee_property(index+<span class="number">1</span> &lt; length,</span><span class="line">                           <span class="string">"Invalid constant pool entry %u in class file %s"</span>,</span><span class="line">                           index, CHECK);</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">9</span>, CHECK);  <span class="comment">// bytes, tag/access_flags</span></span><span class="line">          u8 bytes = cfs-&gt;get_u8_fast();</span><span class="line">          _cp-&gt;double_at_put(index, *(jdouble*)&amp;bytes);</span><span class="line">        &#125;</span><span class="line">        index++;   <span class="comment">// Skip entry following eigth-byte constant, see JVM book p. 98</span></span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_NameAndType :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">5</span>, CHECK);  <span class="comment">// name_index, signature_index, tag/access_flags</span></span><span class="line">          u2 name_index = cfs-&gt;get_u2_fast();</span><span class="line">          u2 signature_index = cfs-&gt;get_u2_fast();</span><span class="line">          _cp-&gt;name_and_type_at_put(index, name_index, signature_index);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">case</span> JVM_CONSTANT_Utf8 :</span><span class="line">        &#123;</span><span class="line">          cfs-&gt;guarantee_more(<span class="number">2</span>, CHECK);  <span class="comment">// utf8_length</span></span><span class="line">          u2  utf8_length = cfs-&gt;get_u2_fast();</span><span class="line">          u1* utf8_buffer = cfs-&gt;get_u1_buffer();</span><span class="line">          assert(utf8_buffer != <span class="literal">NULL</span>, <span class="string">"null utf8 buffer"</span>);</span><span class="line">          <span class="comment">// Got utf8 string, guarantee utf8_length+1 bytes, set stream position forward.</span></span><span class="line">          cfs-&gt;guarantee_more(utf8_length+<span class="number">1</span>, CHECK);  <span class="comment">// utf8 string, tag/access_flags</span></span><span class="line">          cfs-&gt;skip_u1_fast(utf8_length);</span><span class="line"></span><span class="line">          <span class="comment">// Before storing the symbol, make sure it's legal</span></span><span class="line">          <span class="keyword">if</span> (_need_verify) &#123;</span><span class="line">            verify_legal_utf8((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)utf8_buffer, utf8_length, CHECK);</span><span class="line">          &#125;</span><span class="line"></span><span class="line">          <span class="keyword">if</span> (EnableInvokeDynamic &amp;&amp; has_cp_patch_at(index)) &#123;</span><span class="line">            Handle patch = clear_cp_patch_at(index);</span><span class="line">            guarantee_property(java_lang_String::is_instance(patch()),</span><span class="line">                               <span class="string">"Illegal utf8 patch at %d in class file %s"</span>,</span><span class="line">                               index, CHECK);</span><span class="line">            <span class="keyword">char</span>* str = java_lang_String::as_utf8_string(patch());</span><span class="line">            <span class="comment">// (could use java_lang_String::as_symbol instead, but might as well batch them)</span></span><span class="line">            utf8_buffer = (u1*) str;</span><span class="line">            utf8_length = (u2) <span class="built_in">strlen</span>(str);</span><span class="line">          &#125;</span><span class="line"></span><span class="line">          <span class="keyword">unsigned</span> <span class="keyword">int</span> hash;</span><span class="line">          Symbol* result = SymbolTable::lookup_only((<span class="keyword">char</span>*)utf8_buffer, utf8_length, hash);</span><span class="line">          <span class="keyword">if</span> (result == <span class="literal">NULL</span>) &#123;</span><span class="line">            names[names_count] = (<span class="keyword">char</span>*)utf8_buffer;</span><span class="line">            lengths[names_count] = utf8_length;</span><span class="line">            indices[names_count] = index;</span><span class="line">            hashValues[names_count++] = hash;</span><span class="line">            <span class="keyword">if</span> (names_count == SymbolTable::symbol_alloc_batch_size) &#123;</span><span class="line">              SymbolTable::new_symbols(_loader_data, _cp, names_count, names, lengths, indices, hashValues, CHECK);</span><span class="line">              names_count = <span class="number">0</span>;</span><span class="line">            &#125;</span><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><span class="line">            _cp-&gt;symbol_at_put(index, result);</span><span class="line">          &#125;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">      <span class="keyword">default</span>:</span><span class="line">        classfile_parse_error(</span><span class="line">          <span class="string">"Unknown constant tag %u in class file %s"</span>, tag, CHECK);</span><span class="line">        <span class="keyword">break</span>;</span><span class="line">    &#125;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Allocate the remaining symbols</span></span><span class="line">  <span class="keyword">if</span> (names_count &gt; <span class="number">0</span>) &#123;</span><span class="line">    SymbolTable::new_symbols(_loader_data, _cp, names_count, names, lengths, indices, hashValues, CHECK);</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  <span class="comment">// Copy _current pointer of local copy back to stream().</span></span><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ASSERT</span></span><span class="line">  assert(cfs0-&gt;current() == old_current, <span class="string">"non-exclusive use of stream()"</span>);</span><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><span class="line">  cfs0-&gt;set_current(cfs1.current());</span><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>第<code>2807</code>行关于<code>BootstrapMethods</code>属性相关的解析：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">2807</span><span class="line">2808</span><span class="line">2809</span><span class="line">2810</span><span class="line">2811</span><span class="line">2812</span><span class="line">2813</span><span class="line">2814</span><span class="line">2815</span><span class="line">2816</span><span class="line">2817</span><span class="line">2818</span><span class="line">2819</span><span class="line">2820</span><span class="line">2821</span><span class="line">2822</span><span class="line">2823</span><span class="line">2824</span><span class="line">2825</span><span class="line">2826</span><span class="line">2827</span><span class="line">2828</span><span class="line">2829</span><span class="line">2830</span><span class="line">2831</span><span class="line">2832</span><span class="line">2833</span><span class="line">2834</span><span class="line">2835</span><span class="line">2836</span><span class="line">2837</span><span class="line">2838</span><span class="line">2839</span><span class="line">2840</span><span class="line">2841</span><span class="line">2842</span><span class="line">2843</span><span class="line">2844</span><span class="line">2845</span><span class="line">2846</span><span class="line">2847</span><span class="line">2848</span><span class="line">2849</span><span class="line">2850</span><span class="line">2851</span><span class="line">2852</span><span class="line">2853</span><span class="line">2854</span><span class="line">2855</span><span class="line">2856</span><span class="line">2857</span><span class="line">2858</span><span class="line">2859</span><span class="line">2860</span><span class="line">2861</span><span class="line">2862</span><span class="line">2863</span><span class="line">2864</span><span class="line">2865</span><span class="line">2866</span><span class="line">2867</span><span class="line">2868</span><span class="line">2869</span><span class="line">2870</span><span class="line">2871</span><span class="line">2872</span><span class="line">2873</span><span class="line">2874</span><span class="line">2875</span><span class="line">2876</span><span class="line">2877</span><span class="line">2878</span><span class="line">2879</span><span class="line">2880</span><span class="line">2881</span><span class="line">2882</span><span class="line">2883</span><span class="line">2884</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ClassFileParser::parse_classfile_bootstrap_methods_attribute</span><span class="params">(u4 attribute_byte_length, TRAPS)</span> </span>&#123;</span><span class="line">  ClassFileStream* cfs = stream();</span><span class="line">  u1* current_start = cfs-&gt;current();</span><span class="line"></span><span class="line">  guarantee_property(attribute_byte_length &gt;= <span class="keyword">sizeof</span>(u2),</span><span class="line">                     <span class="string">"Invalid BootstrapMethods attribute length %u in class file %s"</span>,</span><span class="line">                     attribute_byte_length,</span><span class="line">                     CHECK);</span><span class="line"></span><span class="line">  cfs-&gt;guarantee_more(attribute_byte_length, CHECK);</span><span class="line"></span><span class="line">  <span class="keyword">int</span> attribute_array_length = cfs-&gt;get_u2_fast();</span><span class="line"></span><span class="line">  guarantee_property(_max_bootstrap_specifier_index &lt; attribute_array_length,</span><span class="line">                     <span class="string">"Short length on BootstrapMethods in class file %s"</span>,</span><span class="line">                     CHECK);</span><span class="line"></span><span class="line">  <span class="comment">// The attribute contains a counted array of counted tuples of shorts,</span></span><span class="line">  <span class="comment">// represending bootstrap specifiers:</span></span><span class="line">  <span class="comment">//    length*&#123;bootstrap_method_index, argument_count*&#123;argument_index&#125;&#125;</span></span><span class="line">  <span class="keyword">int</span> operand_count = (attribute_byte_length - <span class="keyword">sizeof</span>(u2)) / <span class="keyword">sizeof</span>(u2);</span><span class="line">  <span class="comment">// operand_count = number of shorts in attr, except for leading length</span></span><span class="line"></span><span class="line">  <span class="comment">// The attribute is copied into a short[] array.</span></span><span class="line">  <span class="comment">// The array begins with a series of short[2] pairs, one for each tuple.</span></span><span class="line">  <span class="keyword">int</span> index_size = (attribute_array_length * <span class="number">2</span>);</span><span class="line"></span><span class="line">  Array&lt;u2&gt;* operands = MetadataFactory::new_array&lt;u2&gt;(_loader_data, index_size + operand_count, CHECK);</span><span class="line"></span><span class="line">  <span class="comment">// Eagerly assign operands so they will be deallocated with the constant</span></span><span class="line">  <span class="comment">// pool if there is an error.</span></span><span class="line">  _cp-&gt;set_operands(operands);</span><span class="line"></span><span class="line">  <span class="keyword">int</span> operand_fill_index = index_size;</span><span class="line">  <span class="keyword">int</span> cp_size = _cp-&gt;length();</span><span class="line"></span><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; attribute_array_length; n++) &#123;</span><span class="line">    <span class="comment">// Store a 32-bit offset into the header of the operand array.</span></span><span class="line">    ConstantPool::operand_offset_at_put(operands, n, operand_fill_index);</span><span class="line"></span><span class="line">    <span class="comment">// Read a bootstrap specifier.</span></span><span class="line">    cfs-&gt;guarantee_more(<span class="keyword">sizeof</span>(u2) * <span class="number">2</span>, CHECK);  <span class="comment">// bsm, argc</span></span><span class="line">    u2 bootstrap_method_index = cfs-&gt;get_u2_fast();</span><span class="line">    u2 argument_count = cfs-&gt;get_u2_fast();</span><span class="line">    check_property(</span><span class="line">      valid_cp_range(bootstrap_method_index, cp_size) &amp;&amp;</span><span class="line">      _cp-&gt;tag_at(bootstrap_method_index).is_method_handle(),</span><span class="line">      <span class="string">"bootstrap_method_index %u has bad constant type in class file %s"</span>,</span><span class="line">      bootstrap_method_index,</span><span class="line">      CHECK);</span><span class="line"></span><span class="line">    guarantee_property((operand_fill_index + <span class="number">1</span> + argument_count) &lt; operands-&gt;length(),</span><span class="line">      <span class="string">"Invalid BootstrapMethods num_bootstrap_methods or num_bootstrap_arguments value in class file %s"</span>,</span><span class="line">      CHECK);</span><span class="line"></span><span class="line">    operands-&gt;at_put(operand_fill_index++, bootstrap_method_index);</span><span class="line">    operands-&gt;at_put(operand_fill_index++, argument_count);</span><span class="line"></span><span class="line">    cfs-&gt;guarantee_more(<span class="keyword">sizeof</span>(u2) * argument_count, CHECK);  <span class="comment">// argv[argc]</span></span><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; argument_count; j++) &#123;</span><span class="line">      u2 argument_index = cfs-&gt;get_u2_fast();</span><span class="line">      check_property(</span><span class="line">        valid_cp_range(argument_index, cp_size) &amp;&amp;</span><span class="line">        _cp-&gt;tag_at(argument_index).is_loadable_constant(),</span><span class="line">        <span class="string">"argument_index %u has bad constant type in class file %s"</span>,</span><span class="line">        argument_index,</span><span class="line">        CHECK);</span><span class="line">      operands-&gt;at_put(operand_fill_index++, argument_index);</span><span class="line">    &#125;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">  assert(operand_fill_index == operands-&gt;length(), <span class="string">"exact fill"</span>);</span><span class="line"></span><span class="line">  u1* current_end = cfs-&gt;current();</span><span class="line">  guarantee_property(current_end == current_start + attribute_byte_length,</span><span class="line">                     <span class="string">"Bad length on BootstrapMethods in class file %s"</span>,</span><span class="line">                     CHECK);</span><span class="line">&#125;</span></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/blog/java/2018/08/04/hotspot-source-code-class-file-parse.html#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/java/2018/08/04/hotspot-source-code-call-java-main-method.html" itemprop="url">
                  hotspot source code - call java main method
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-08-04T21:18:43+08:00" content="2018-08-04">
              2018-08-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p><a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/f3108e56b502/src/share/vm/prims/jni.cpp" target="_blank" rel="noopener">vm/prims/jni.cpp</a> 第<code>1311</code>行，<code>jni_invoke_static()</code>方法中第<code>1329</code>行通过<code>JavaCalls::call()</code>方法调用 Java 的<code>main(String[])</code>方法，源码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1311</span><span class="line">1312</span><span class="line">1313</span><span class="line">1314</span><span class="line">1315</span><span class="line">1316</span><span class="line">1317</span><span class="line">1318</span><span class="line">1319</span><span class="line">1320</span><span class="line">1321</span><span class="line">1322</span><span class="line">1323</span><span class="line">1324</span><span class="line">1325</span><span class="line">1326</span><span class="line">1327</span><span class="line">1328</span><span class="line">1329</span><span class="line">1330</span><span class="line">1331</span><span class="line">1332</span><span class="line">1333</span><span class="line">1334</span><span class="line">1335</span><span class="line">1336</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">jni_invoke_static</span><span class="params">(JNIEnv *env, JavaValue* result, jobject receiver, JNICallType call_type, jmethodID method_id, JNI_ArgumentPusher *args, TRAPS)</span> </span>&#123;</span><span class="line">  <span class="function">methodHandle <span class="title">method</span><span class="params">(THREAD, Method::resolve_jmethod_id(method_id))</span></span>;</span><span class="line"></span><span class="line">  <span class="comment">// Create object to hold arguments for the JavaCall, and associate it with</span></span><span class="line">  <span class="comment">// the jni parser</span></span><span class="line">  <span class="function">ResourceMark <span class="title">rm</span><span class="params">(THREAD)</span></span>;</span><span class="line">  <span class="keyword">int</span> number_of_parameters = method-&gt;size_of_parameters();</span><span class="line">  <span class="function">JavaCallArguments <span class="title">java_args</span><span class="params">(number_of_parameters)</span></span>;</span><span class="line">  args-&gt;set_java_argument_object(&amp;java_args);</span><span class="line"></span><span class="line">  assert(method-&gt;is_static(), <span class="string">"method should be static"</span>);</span><span class="line"></span><span class="line">  <span class="comment">// Fill out JavaCallArguments object</span></span><span class="line">  args-&gt;iterate( Fingerprinter(method).fingerprint() );</span><span class="line">  <span class="comment">// Initialize result type</span></span><span class="line">  result-&gt;set_type(args-&gt;get_ret_type());</span><span class="line"></span><span class="line">  <span class="comment">// Invoke the method. Result is returned as oop.</span></span><span class="line">  JavaCalls::call(result, method, &amp;java_args, CHECK);</span><span class="line"></span><span class="line">  <span class="comment">// Convert result</span></span><span class="line">  <span class="keyword">if</span> (result-&gt;get_type() == T_OBJECT || result-&gt;get_type() == T_ARRAY) &#123;</span><span class="line">    result-&gt;set_jobject(JNIHandles::make_local(env, (oop) result-&gt;get_jobject()));</span><span class="line">  &#125;</span><span class="line">&#125;</span><span class="line"></span></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/blog/java/2018/08/04/hotspot-source-code-call-java-main-method.html#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/blog/java/2018/08/04/hotspot-source-code-jvm-create.html" itemprop="url">
                  hotspot source code - jvm create
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2018-08-04T21:05:57+08:00" content="2018-08-04">
              2018-08-04
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="JVM-虚拟机创建"><a href="#JVM-虚拟机创建" class="headerlink" title="JVM 虚拟机创建"></a>JVM 虚拟机创建</h2><p>进入<a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/f3108e56b502/src/share/vm/runtime/thread.cpp" target="_blank" rel="noopener">vm/runtime/thread.cpp</a>文件的第<code>3317</code>行，查看主要方法<code>Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain)</code>，源码如下：</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/blog/java/2018/08/04/hotspot-source-code-jvm-create.html#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/5/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/blog/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/99/">99</a><a class="extend next" rel="next" href="/blog/page/7/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/blog/images/avatar.jpg" alt="yuweijun">
          <p class="site-author-name" itemprop="name">yuweijun</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">492</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yuweijun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/yuweijun" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-github"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuweijun</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist.KISS
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.ui.min.js"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
