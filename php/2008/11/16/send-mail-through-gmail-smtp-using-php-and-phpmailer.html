<!doctype html>




<html class="theme-next mist">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">


















  

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">






  <link rel="alternate" href="/blog/atom.xml" title="一" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1">






<meta name="description" content="用gmail smtp和php的phpmailer类库发送邮件。">
<meta property="og:type" content="article">
<meta property="og:title" content="send mail through gmail smtp using php and phpmailer">
<meta property="og:url" content="http://www.4e00.com/php/2008/11/16/send-mail-through-gmail-smtp-using-php-and-phpmailer.html">
<meta property="og:site_name" content="一">
<meta property="og:description" content="用gmail smtp和php的phpmailer类库发送邮件。">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-03-06T01:24:26.055Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="send mail through gmail smtp using php and phpmailer">
<meta name="twitter:description" content="用gmail smtp和php的phpmailer类库发送邮件。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"hide"},
    fancybox: false,
    motion: false,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://www.4e00.com/blog/php/2008/11/16/send-mail-through-gmail-smtp-using-php-and-phpmailer.html">

  <title> send mail through gmail smtp using php and phpmailer | 一 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/" class="brand" rel="start">
      <span class="site-title">一</span>
    </a>
  </div>
  <p class="site-subtitle">{"type":"编程笔记"}</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      <li class="menu-item menu-item-search">
        <a href="https://www.google.com.hk/search?q=site%3Ahttp://www.4e00.com/blog/" class="popup-trigger">
          <i class="menu-item-icon fa fa-search fa-fw"></i>Search
        </a>
      </li>
    </ul>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                send mail through gmail smtp using php and phpmailer
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2008-11-16T14:44:00+08:00" content="2008-11-16">
              2008-11-16
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="//schema.org/Thing">
                  <a href="/blog/categories/php/" itemprop="url" rel="index">
                    <span itemprop="name">php</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>用gmail smtp和php的phpmailer类库发送邮件。</p>
<a id="more"></a>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><span class="line"><span class="keyword">require_once</span>(<span class="string">"class.phpmailer.php"</span>);</span><span class="line">$mail              = <span class="keyword">new</span> PHPMailer();</span><span class="line">$mail-&gt;IsSMTP(); <span class="comment">// telling the class to use SMTP</span></span><span class="line">$mail-&gt;ContentType = <span class="string">"text/plain"</span>; <span class="comment">// text/plain or text/html</span></span><span class="line"></span><span class="line">$mail-&gt;Host        = <span class="string">"smtp.gmail.com"</span>; <span class="comment">// had been hacked in class.smtp.php, ssl://smtp.gmail.com</span></span><span class="line">$mail-&gt;SMTPAuth    = <span class="keyword">true</span>;</span><span class="line">$mail-&gt;Username    = <span class="string">"test@gmail.com"</span>;</span><span class="line">$mail-&gt;Password    = <span class="string">"****password****"</span>;</span><span class="line"></span><span class="line">$mail-&gt;From        = <span class="string">"test@gmail.com"</span>;</span><span class="line">$mail-&gt;FromName    = <span class="string">"www.gmail.com"</span>;</span><span class="line">$mail-&gt;AddAddress(<span class="string">"test@gmail.com"</span>);</span><span class="line"></span><span class="line"><span class="comment">// CC and BCC</span></span><span class="line"><span class="comment">// $mail-&gt;AddCC("test@test.com");</span></span><span class="line"><span class="comment">// $mail-&gt;AddBCC("anothermail@test.com");</span></span><span class="line"></span><span class="line">$mail-&gt;Subject     = <span class="string">"This is my subject"</span>;</span><span class="line">$mail-&gt;Body        = <span class="string">"This is my message"</span>;</span><span class="line"></span><span class="line"><span class="keyword">if</span>(!$mail-&gt;Send()) &#123;</span><span class="line">    <span class="keyword">echo</span> <span class="string">"Message was not sent"</span>;</span><span class="line">    <span class="keyword">echo</span> <span class="string">"Mailer Error: "</span> . $mail-&gt;ErrorInfo;</span><span class="line">&#125; <span class="keyword">else</span> &#123;</span><span class="line">    <span class="keyword">echo</span> <span class="string">"Email sent"</span>;</span><span class="line">&#125;</span><span class="line"><span class="meta">?&gt;</span></span></pre></td></tr></table></figure>
<h2 id="class-phpmailer-php-source"><a href="#class-phpmailer-php-source" class="headerlink" title="class.phpmailer.php source"></a>class.phpmailer.php source</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////</span></span><span class="line"><span class="comment">// PHPMailer - PHP email class</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Class for sending email using either</span></span><span class="line"><span class="comment">// sendmail, PHP mail(), or SMTP.  Methods are</span></span><span class="line"><span class="comment">// based upon the standard AspEmail(tm) classes.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Copyright (C) 2001 - 2003  Brent R. Matzelle</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// License: LGPL, see LICENSE</span></span><span class="line"><span class="comment">////////////////////////////////////////////////////</span></span><span class="line"></span><span class="line"><span class="comment">/**</span></span><span class="line"><span class="comment"> * PHPMailer - PHP email transport class</span></span><span class="line"><span class="comment"> * <span class="doctag">@package</span> PHPMailer</span></span><span class="line"><span class="comment"> * <span class="doctag">@author</span> Brent R. Matzelle</span></span><span class="line"><span class="comment"> * <span class="doctag">@copyright</span> 2001 - 2003 Brent R. Matzelle</span></span><span class="line"><span class="comment"> */</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PHPMailer</span></span></span><span class="line"><span class="class"></span>&#123;</span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// PUBLIC VARIABLES</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Email priority (1 = High, 3 = Normal, 5 = low).</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Priority          = <span class="number">3</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the CharSet of the message.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $CharSet           = <span class="string">"iso-8859-1"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the Content-type of the message.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $ContentType        = <span class="string">"text/plain"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the Encoding of the message. Options for this are "8bit",</span></span><span class="line"><span class="comment">     * "7bit", "binary", "base64", and "quoted-printable".</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Encoding          = <span class="string">"8bit"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Holds the most recent mailer error message.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $ErrorInfo         = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the From email address for the message.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $From               = <span class="string">"root@localhost"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the From name of the message.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $FromName           = <span class="string">"Root User"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the Sender email (Return-Path) of the message.  If not empty,</span></span><span class="line"><span class="comment">     * will be sent via -f to sendmail or as 'MAIL FROM' in smtp mode.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Sender            = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the Subject of the message.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Subject           = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the Body of the message.  This can be either an HTML or text body.</span></span><span class="line"><span class="comment">     * If HTML then run IsHTML(true).</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Body               = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the text-only body of the message.  This automatically sets the</span></span><span class="line"><span class="comment">     * email to multipart/alternative.  This body can be read by mail</span></span><span class="line"><span class="comment">     * clients that do not have HTML email capability such as mutt. Clients</span></span><span class="line"><span class="comment">     * that can read HTML will view the normal Body.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $AltBody           = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets word wrapping on the body of the message to a given number of</span></span><span class="line"><span class="comment">     * characters.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $WordWrap          = <span class="number">0</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Method to send mail: ("mail", "sendmail", or "smtp").</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Mailer            = <span class="string">"mail"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the path of the sendmail program.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Sendmail          = <span class="string">"/usr/sbin/sendmail"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Path to PHPMailer plugins.  This is now only useful if the SMTP class</span></span><span class="line"><span class="comment">     * is in a different directory than the PHP include path.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $PluginDir         = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Holds PHPMailer version.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Version           = <span class="string">"1.73"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the email address that a reading confirmation will be sent.</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $ConfirmReadingTo  = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets the hostname to use in Message-Id and Received headers</span></span><span class="line"><span class="comment">     *  and as default HELO string. If empty, the value returned</span></span><span class="line"><span class="comment">     *  by SERVER_NAME is used or 'localhost.localdomain'.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Hostname          = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// SMTP VARIABLES</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets the SMTP hosts.  All hosts must be separated by a</span></span><span class="line"><span class="comment">     *  semicolon.  You can also specify a different port</span></span><span class="line"><span class="comment">     *  for each host by using this format: [hostname:port]</span></span><span class="line"><span class="comment">     *  (e.g. "smtp1.example.com:25;smtp2.example.com").</span></span><span class="line"><span class="comment">     *  Hosts will be tried in order.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Host        = <span class="string">"localhost"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets the default SMTP server port.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> int</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Port        = <span class="number">25</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets the SMTP HELO of the message (Default is $Hostname).</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Helo        = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets SMTP authentication. Utilizes the Username and Password variables.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $SMTPAuth     = <span class="keyword">false</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets SMTP username.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Username     = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets SMTP password.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Password     = <span class="string">""</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets the SMTP server timeout in seconds. This function will not</span></span><span class="line"><span class="comment">     *  work with the win32 version.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> int</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $Timeout      = <span class="number">10</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets SMTP class debugging on or off.</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $SMTPDebug    = <span class="keyword">false</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Prevents the SMTP connection from being closed after each mail</span></span><span class="line"><span class="comment">     * sending.  If this is set to true then to close the connection</span></span><span class="line"><span class="comment">     * requires an explicit call to SmtpClose().</span></span><span class="line"><span class="comment">     * <span class="doctag">@var</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $SMTPKeepAlive = <span class="keyword">false</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**#@+</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $smtp            = <span class="keyword">NULL</span>;</span><span class="line">    <span class="keyword">var</span> $to              = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $cc              = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $bcc             = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $ReplyTo         = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $attachment      = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $CustomHeader    = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $message_type    = <span class="string">""</span>;</span><span class="line">    <span class="keyword">var</span> $boundary        = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $language        = <span class="keyword">array</span>();</span><span class="line">    <span class="keyword">var</span> $error_count     = <span class="number">0</span>;</span><span class="line">    <span class="keyword">var</span> $LE              = <span class="string">"\n"</span>;</span><span class="line">    <span class="comment">/**#@-*/</span></span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// VARIABLE METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets message type to HTML.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> bool $bool</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">IsHTML</span><span class="params">($bool)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>($bool == <span class="keyword">true</span>)</span><span class="line">            <span class="keyword">$this</span>-&gt;ContentType = <span class="string">"text/html"</span>;</span><span class="line">        <span class="keyword">else</span></span><span class="line">            <span class="keyword">$this</span>-&gt;ContentType = <span class="string">"text/plain"</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets Mailer to send message using SMTP.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">IsSMTP</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;Mailer = <span class="string">"smtp"</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets Mailer to send message using PHP mail() function.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">IsMail</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;Mailer = <span class="string">"mail"</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets Mailer to send message using the $Sendmail program.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">IsSendmail</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;Mailer = <span class="string">"sendmail"</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets Mailer to send message using the qmail MTA.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">IsQmail</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;Sendmail = <span class="string">"/var/qmail/bin/sendmail"</span>;</span><span class="line">        <span class="keyword">$this</span>-&gt;Mailer = <span class="string">"sendmail"</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// RECIPIENT METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds a "To" address.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $address</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddAddress</span><span class="params">($address, $name = <span class="string">""</span>)</span> </span>&#123;</span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;to);</span><span class="line">        <span class="keyword">$this</span>-&gt;to[$cur][<span class="number">0</span>] = trim($address);</span><span class="line">        <span class="keyword">$this</span>-&gt;to[$cur][<span class="number">1</span>] = $name;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds a "Cc" address. <span class="doctag">Note:</span> this function works</span></span><span class="line"><span class="comment">     * with the SMTP mailer on win32, not with the "mail"</span></span><span class="line"><span class="comment">     * mailer.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $address</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">    */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddCC</span><span class="params">($address, $name = <span class="string">""</span>)</span> </span>&#123;</span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;cc);</span><span class="line">        <span class="keyword">$this</span>-&gt;cc[$cur][<span class="number">0</span>] = trim($address);</span><span class="line">        <span class="keyword">$this</span>-&gt;cc[$cur][<span class="number">1</span>] = $name;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds a "Bcc" address. <span class="doctag">Note:</span> this function works</span></span><span class="line"><span class="comment">     * with the SMTP mailer on win32, not with the "mail"</span></span><span class="line"><span class="comment">     * mailer.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $address</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddBCC</span><span class="params">($address, $name = <span class="string">""</span>)</span> </span>&#123;</span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;bcc);</span><span class="line">        <span class="keyword">$this</span>-&gt;bcc[$cur][<span class="number">0</span>] = trim($address);</span><span class="line">        <span class="keyword">$this</span>-&gt;bcc[$cur][<span class="number">1</span>] = $name;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds a "Reply-to" address.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $address</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddReplyTo</span><span class="params">($address, $name = <span class="string">""</span>)</span> </span>&#123;</span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;ReplyTo);</span><span class="line">        <span class="keyword">$this</span>-&gt;ReplyTo[$cur][<span class="number">0</span>] = trim($address);</span><span class="line">        <span class="keyword">$this</span>-&gt;ReplyTo[$cur][<span class="number">1</span>] = $name;</span><span class="line">    &#125;</span><span class="line"></span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// MAIL SENDING METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Creates message and assigns Mailer. If the message is</span></span><span class="line"><span class="comment">     * not sent successfully then it returns false.  Use the ErrorInfo</span></span><span class="line"><span class="comment">     * variable to view description of the error.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Send</span><span class="params">()</span> </span>&#123;</span><span class="line">        $header = <span class="string">""</span>;</span><span class="line">        $body = <span class="string">""</span>;</span><span class="line">        $result = <span class="keyword">true</span>;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>((count(<span class="keyword">$this</span>-&gt;to) + count(<span class="keyword">$this</span>-&gt;cc) + count(<span class="keyword">$this</span>-&gt;bcc)) &lt; <span class="number">1</span>)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"provide_address"</span>));</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Set whether the message is multipart/alternative</span></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;AltBody))</span><span class="line">            <span class="keyword">$this</span>-&gt;ContentType = <span class="string">"multipart/alternative"</span>;</span><span class="line"></span><span class="line">        <span class="keyword">$this</span>-&gt;error_count = <span class="number">0</span>; <span class="comment">// reset errors</span></span><span class="line">        <span class="keyword">$this</span>-&gt;SetMessageType();</span><span class="line">        $header .= <span class="keyword">$this</span>-&gt;CreateHeader();</span><span class="line">        $body = <span class="keyword">$this</span>-&gt;CreateBody();</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($body == <span class="string">""</span>) &#123; <span class="keyword">return</span> <span class="keyword">false</span>; &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Choose the mailer</span></span><span class="line">        <span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;Mailer)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">case</span> <span class="string">"sendmail"</span>:</span><span class="line">                $result = <span class="keyword">$this</span>-&gt;SendmailSend($header, $body);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"mail"</span>:</span><span class="line">                $result = <span class="keyword">$this</span>-&gt;MailSend($header, $body);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"smtp"</span>:</span><span class="line">                $result = <span class="keyword">$this</span>-&gt;SmtpSend($header, $body);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">default</span>:</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Mailer . <span class="keyword">$this</span>-&gt;Lang(<span class="string">"mailer_not_supported"</span>));</span><span class="line">                $result = <span class="keyword">false</span>;</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends mail using the $Sendmail program.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SendmailSend</span><span class="params">($header, $body)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;Sender != <span class="string">""</span>)</span><span class="line">            $sendmail = sprintf(<span class="string">"%s -oi -f %s -t"</span>, <span class="keyword">$this</span>-&gt;Sendmail, <span class="keyword">$this</span>-&gt;Sender);</span><span class="line">        <span class="keyword">else</span></span><span class="line">            $sendmail = sprintf(<span class="string">"%s -oi -t"</span>, <span class="keyword">$this</span>-&gt;Sendmail);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!@$mail = popen($sendmail, <span class="string">"w"</span>))</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"execute"</span>) . <span class="keyword">$this</span>-&gt;Sendmail);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs($mail, $header);</span><span class="line">        fputs($mail, $body);</span><span class="line"></span><span class="line">        $result = pclose($mail) &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xFF</span>;</span><span class="line">        <span class="keyword">if</span>($result != <span class="number">0</span>)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"execute"</span>) . <span class="keyword">$this</span>-&gt;Sendmail);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends mail using the PHP mail() function.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">MailSend</span><span class="params">($header, $body)</span> </span>&#123;</span><span class="line">        $to = <span class="string">""</span>;</span><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count(<span class="keyword">$this</span>-&gt;to); $i++)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>($i != <span class="number">0</span>) &#123; $to .= <span class="string">", "</span>; &#125;</span><span class="line">            $to .= <span class="keyword">$this</span>-&gt;to[$i][<span class="number">0</span>];</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;Sender != <span class="string">""</span> &amp;&amp; strlen(ini_get(<span class="string">"safe_mode"</span>))&lt; <span class="number">1</span>)</span><span class="line">        &#123;</span><span class="line">            $old_from = ini_get(<span class="string">"sendmail_from"</span>);</span><span class="line">            ini_set(<span class="string">"sendmail_from"</span>, <span class="keyword">$this</span>-&gt;Sender);</span><span class="line">            $params = sprintf(<span class="string">"-oi -f %s"</span>, <span class="keyword">$this</span>-&gt;Sender);</span><span class="line">            $rt = @mail($to, <span class="keyword">$this</span>-&gt;EncodeHeader(<span class="keyword">$this</span>-&gt;Subject), $body,</span><span class="line">                        $header, $params);</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">else</span></span><span class="line">            $rt = @mail($to, <span class="keyword">$this</span>-&gt;EncodeHeader(<span class="keyword">$this</span>-&gt;Subject), $body, $header);</span><span class="line"></span><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($old_from))</span><span class="line">            ini_set(<span class="string">"sendmail_from"</span>, $old_from);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!$rt)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"instantiate"</span>));</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends mail via SMTP using PhpSMTP (Author:</span></span><span class="line"><span class="comment">     * Chris Ryan).  Returns bool.  Returns false if there is a</span></span><span class="line"><span class="comment">     * bad MAIL FROM, RCPT, or DATA input.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SmtpSend</span><span class="params">($header, $body)</span> </span>&#123;</span><span class="line">        <span class="keyword">include_once</span>(<span class="keyword">$this</span>-&gt;PluginDir . <span class="string">"class.smtp.php"</span>);</span><span class="line">        $error = <span class="string">""</span>;</span><span class="line">        $bad_rcpt = <span class="keyword">array</span>();</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;SmtpConnect())</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line"></span><span class="line">        $smtp_from = (<span class="keyword">$this</span>-&gt;Sender == <span class="string">""</span>) ? <span class="keyword">$this</span>-&gt;From : <span class="keyword">$this</span>-&gt;Sender;</span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;smtp-&gt;Mail($smtp_from))</span><span class="line">        &#123;</span><span class="line">            $error = <span class="keyword">$this</span>-&gt;Lang(<span class="string">"from_failed"</span>) . $smtp_from;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError($error);</span><span class="line">            <span class="keyword">$this</span>-&gt;smtp-&gt;Reset();</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Attempt to send attach all recipients</span></span><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count(<span class="keyword">$this</span>-&gt;to); $i++)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;smtp-&gt;Recipient(<span class="keyword">$this</span>-&gt;to[$i][<span class="number">0</span>]))</span><span class="line">                $bad_rcpt[] = <span class="keyword">$this</span>-&gt;to[$i][<span class="number">0</span>];</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count(<span class="keyword">$this</span>-&gt;cc); $i++)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;smtp-&gt;Recipient(<span class="keyword">$this</span>-&gt;cc[$i][<span class="number">0</span>]))</span><span class="line">                $bad_rcpt[] = <span class="keyword">$this</span>-&gt;cc[$i][<span class="number">0</span>];</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count(<span class="keyword">$this</span>-&gt;bcc); $i++)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;smtp-&gt;Recipient(<span class="keyword">$this</span>-&gt;bcc[$i][<span class="number">0</span>]))</span><span class="line">                $bad_rcpt[] = <span class="keyword">$this</span>-&gt;bcc[$i][<span class="number">0</span>];</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(count($bad_rcpt) &gt; <span class="number">0</span>) <span class="comment">// Create error message</span></span><span class="line">        &#123;</span><span class="line">            <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count($bad_rcpt); $i++)</span><span class="line">            &#123;</span><span class="line">                <span class="keyword">if</span>($i != <span class="number">0</span>) &#123; $error .= <span class="string">", "</span>; &#125;</span><span class="line">                $error .= $bad_rcpt[$i];</span><span class="line">            &#125;</span><span class="line">            $error = <span class="keyword">$this</span>-&gt;Lang(<span class="string">"recipients_failed"</span>) . $error;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError($error);</span><span class="line">            <span class="keyword">$this</span>-&gt;smtp-&gt;Reset();</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;smtp-&gt;Data($header . $body))</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"data_not_accepted"</span>));</span><span class="line">            <span class="keyword">$this</span>-&gt;smtp-&gt;Reset();</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;SMTPKeepAlive == <span class="keyword">true</span>)</span><span class="line">            <span class="keyword">$this</span>-&gt;smtp-&gt;Reset();</span><span class="line">        <span class="keyword">else</span></span><span class="line">            <span class="keyword">$this</span>-&gt;SmtpClose();</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Initiates a connection to an SMTP server.  Returns false if the</span></span><span class="line"><span class="comment">     * operation failed.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SmtpConnect</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;smtp == <span class="keyword">NULL</span>) &#123; <span class="keyword">$this</span>-&gt;smtp = <span class="keyword">new</span> SMTP(); &#125;</span><span class="line"></span><span class="line">        <span class="keyword">$this</span>-&gt;smtp-&gt;do_debug = <span class="keyword">$this</span>-&gt;SMTPDebug;</span><span class="line">        $hosts = explode(<span class="string">";"</span>, <span class="keyword">$this</span>-&gt;Host);</span><span class="line">        $index = <span class="number">0</span>;</span><span class="line">        $connection = (<span class="keyword">$this</span>-&gt;smtp-&gt;Connected());</span><span class="line"></span><span class="line">        <span class="comment">// Retry while there is no connection</span></span><span class="line">        <span class="keyword">while</span>($index &lt; count($hosts) &amp;&amp; $connection == <span class="keyword">false</span>)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(strstr($hosts[$index], <span class="string">":"</span>))</span><span class="line">                <span class="keyword">list</span>($host, $port) = explode(<span class="string">":"</span>, $hosts[$index]);</span><span class="line">            <span class="keyword">else</span></span><span class="line">            &#123;</span><span class="line">                $host = $hosts[$index];</span><span class="line">                $port = <span class="keyword">$this</span>-&gt;Port;</span><span class="line">            &#125;</span><span class="line"></span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;smtp-&gt;Connect($host, $port, <span class="keyword">$this</span>-&gt;Timeout))</span><span class="line">            &#123;</span><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;Helo != <span class="string">''</span>)</span><span class="line">                    <span class="keyword">$this</span>-&gt;smtp-&gt;Hello(<span class="keyword">$this</span>-&gt;Helo);</span><span class="line">                <span class="keyword">else</span></span><span class="line">                    <span class="keyword">$this</span>-&gt;smtp-&gt;Hello(<span class="keyword">$this</span>-&gt;ServerHostname());</span><span class="line"></span><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;SMTPAuth)</span><span class="line">                &#123;</span><span class="line">                    <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;smtp-&gt;Authenticate(<span class="keyword">$this</span>-&gt;Username,</span><span class="line">                                                  <span class="keyword">$this</span>-&gt;Password))</span><span class="line">                    &#123;</span><span class="line">                        <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"authenticate"</span>));</span><span class="line">                        <span class="keyword">$this</span>-&gt;smtp-&gt;Reset();</span><span class="line">                        $connection = <span class="keyword">false</span>;</span><span class="line">                    &#125;</span><span class="line">                &#125;</span><span class="line">                $connection = <span class="keyword">true</span>;</span><span class="line">            &#125;</span><span class="line">            $index++;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span>(!$connection)</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"connect_host"</span>));</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $connection;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Closes the active SMTP session if one exists.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SmtpClose</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;smtp != <span class="keyword">NULL</span>)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;smtp-&gt;Connected())</span><span class="line">            &#123;</span><span class="line">                <span class="keyword">$this</span>-&gt;smtp-&gt;Quit();</span><span class="line">                <span class="keyword">$this</span>-&gt;smtp-&gt;Close();</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the language for all class error messages.  Returns false</span></span><span class="line"><span class="comment">     * if it cannot load the language file.  The default language type</span></span><span class="line"><span class="comment">     * is English.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $lang_type Type of language (e.g. Portuguese: "br")</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $lang_path Path to the language file directory</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SetLanguage</span><span class="params">($lang_type, $lang_path = <span class="string">"include/system/classes/language/"</span>)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(file_exists($lang_path.<span class="string">'phpmailer.lang-'</span>.$lang_type.<span class="string">'.php'</span>)) &#123;</span><span class="line">            <span class="keyword">include</span>($lang_path.<span class="string">'phpmailer.lang-'</span>.$lang_type.<span class="string">'.php'</span>);</span><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(file_exists($lang_path.<span class="string">'phpmailer.lang-en.php'</span>)) &#123;</span><span class="line">          <span class="keyword">include</span>($lang_path.<span class="string">'phpmailer.lang-en.php'</span>);</span><span class="line">        &#125; <span class="keyword">else</span></span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="string">"Could not load language file"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">$this</span>-&gt;language = $PHPMAILER_LANG;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// MESSAGE CREATION METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Creates recipient headers.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddrAppend</span><span class="params">($type, $addr)</span> </span>&#123;</span><span class="line">        $addr_str = $type . <span class="string">": "</span>;</span><span class="line">        $addr_str .= <span class="keyword">$this</span>-&gt;AddrFormat($addr[<span class="number">0</span>]);</span><span class="line">        <span class="keyword">if</span>(count($addr) &gt; <span class="number">1</span>)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">for</span>($i = <span class="number">1</span>; $i &lt; count($addr); $i++)</span><span class="line">                $addr_str .= <span class="string">", "</span> . <span class="keyword">$this</span>-&gt;AddrFormat($addr[$i]);</span><span class="line">        &#125;</span><span class="line">        $addr_str .= <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $addr_str;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Formats an address correctly.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddrFormat</span><span class="params">($addr)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($addr[<span class="number">1</span>]))</span><span class="line">            $formatted = $addr[<span class="number">0</span>];</span><span class="line">        <span class="keyword">else</span></span><span class="line">        &#123;</span><span class="line">            $formatted = <span class="keyword">$this</span>-&gt;EncodeHeader($addr[<span class="number">1</span>], <span class="string">'phrase'</span>) . <span class="string">" &lt;"</span> .</span><span class="line">                         $addr[<span class="number">0</span>] . <span class="string">"&gt;"</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $formatted;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Wraps message for use with mailers that do not</span></span><span class="line"><span class="comment">     * automatically perform wrapping and for quoted-printable.</span></span><span class="line"><span class="comment">     * Original written by philippe.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">WrapText</span><span class="params">($message, $length, $qp_mode = false)</span> </span>&#123;</span><span class="line">        $soft_break = ($qp_mode) ? sprintf(<span class="string">" =%s"</span>, <span class="keyword">$this</span>-&gt;LE) : <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">        $message = <span class="keyword">$this</span>-&gt;FixEOL($message);</span><span class="line">        <span class="keyword">if</span> (substr($message, <span class="number">-1</span>) == <span class="keyword">$this</span>-&gt;LE)</span><span class="line">            $message = substr($message, <span class="number">0</span>, <span class="number">-1</span>);</span><span class="line"></span><span class="line">        $line = explode(<span class="keyword">$this</span>-&gt;LE, $message);</span><span class="line">        $message = <span class="string">""</span>;</span><span class="line">        <span class="keyword">for</span> ($i=<span class="number">0</span> ;$i &lt; count($line); $i++)</span><span class="line">        &#123;</span><span class="line">          $line_part = explode(<span class="string">" "</span>, $line[$i]);</span><span class="line">          $buf = <span class="string">""</span>;</span><span class="line">          <span class="keyword">for</span> ($e = <span class="number">0</span>; $e          &#123;</span><span class="line">              $word = $line_part[$e];</span><span class="line">              <span class="keyword">if</span> ($qp_mode <span class="keyword">and</span> (strlen($word) &gt; $length))</span><span class="line">              &#123;</span><span class="line">                $space_left = $length - strlen($buf) - <span class="number">1</span>;</span><span class="line">                <span class="keyword">if</span> ($e != <span class="number">0</span>)</span><span class="line">                &#123;</span><span class="line">                    <span class="keyword">if</span> ($space_left &gt; <span class="number">20</span>)</span><span class="line">                    &#123;</span><span class="line">                        $len = $space_left;</span><span class="line">                        <span class="keyword">if</span> (substr($word, $len - <span class="number">1</span>, <span class="number">1</span>) == <span class="string">"="</span>)</span><span class="line">                          $len--;</span><span class="line">                        <span class="keyword">elseif</span> (substr($word, $len - <span class="number">2</span>, <span class="number">1</span>) == <span class="string">"="</span>)</span><span class="line">                          $len -= <span class="number">2</span>;</span><span class="line">                        $part = substr($word, <span class="number">0</span>, $len);</span><span class="line">                        $word = substr($word, $len);</span><span class="line">                        $buf .= <span class="string">" "</span> . $part;</span><span class="line">                        $message .= $buf . sprintf(<span class="string">"=%s"</span>, <span class="keyword">$this</span>-&gt;LE);</span><span class="line">                    &#125;</span><span class="line">                    <span class="keyword">else</span></span><span class="line">                    &#123;</span><span class="line">                        $message .= $buf . $soft_break;</span><span class="line">                    &#125;</span><span class="line">                    $buf = <span class="string">""</span>;</span><span class="line">                &#125;</span><span class="line">                <span class="keyword">while</span> (strlen($word) &gt; <span class="number">0</span>)</span><span class="line">                &#123;</span><span class="line">                    $len = $length;</span><span class="line">                    <span class="keyword">if</span> (substr($word, $len - <span class="number">1</span>, <span class="number">1</span>) == <span class="string">"="</span>)</span><span class="line">                        $len--;</span><span class="line">                    <span class="keyword">elseif</span> (substr($word, $len - <span class="number">2</span>, <span class="number">1</span>) == <span class="string">"="</span>)</span><span class="line">                        $len -= <span class="number">2</span>;</span><span class="line">                    $part = substr($word, <span class="number">0</span>, $len);</span><span class="line">                    $word = substr($word, $len);</span><span class="line"></span><span class="line">                    <span class="keyword">if</span> (strlen($word) &gt; <span class="number">0</span>)</span><span class="line">                        $message .= $part . sprintf(<span class="string">"=%s"</span>, <span class="keyword">$this</span>-&gt;LE);</span><span class="line">                    <span class="keyword">else</span></span><span class="line">                        $buf = $part;</span><span class="line">                &#125;</span><span class="line">              &#125;</span><span class="line">              <span class="keyword">else</span></span><span class="line">              &#123;</span><span class="line">                $buf_o = $buf;</span><span class="line">                $buf .= ($e == <span class="number">0</span>) ? $word : (<span class="string">" "</span> . $word);</span><span class="line"></span><span class="line">                <span class="keyword">if</span> (strlen($buf) &gt; $length <span class="keyword">and</span> $buf_o != <span class="string">""</span>)</span><span class="line">                &#123;</span><span class="line">                    $message .= $buf_o . $soft_break;</span><span class="line">                    $buf = $word;</span><span class="line">                &#125;</span><span class="line">              &#125;</span><span class="line">          &#125;</span><span class="line">          $message .= $buf . <span class="keyword">$this</span>-&gt;LE;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $message;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Set the body wrapping.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SetWordWrap</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;WordWrap &lt; <span class="number">1</span>)</span><span class="line">            <span class="keyword">return</span>;</span><span class="line"></span><span class="line">        <span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;message_type)</span><span class="line">        &#123;</span><span class="line">           <span class="keyword">case</span> <span class="string">"alt"</span>:</span><span class="line">              <span class="comment">// fall through</span></span><span class="line">           <span class="keyword">case</span> <span class="string">"alt_attachments"</span>:</span><span class="line">              <span class="keyword">$this</span>-&gt;AltBody = <span class="keyword">$this</span>-&gt;WrapText(<span class="keyword">$this</span>-&gt;AltBody, <span class="keyword">$this</span>-&gt;WordWrap);</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">           <span class="keyword">default</span>:</span><span class="line">              <span class="keyword">$this</span>-&gt;Body = <span class="keyword">$this</span>-&gt;WrapText(<span class="keyword">$this</span>-&gt;Body, <span class="keyword">$this</span>-&gt;WordWrap);</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">        &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Assembles message header.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CreateHeader</span><span class="params">()</span> </span>&#123;</span><span class="line">        $result = <span class="string">""</span>;</span><span class="line"></span><span class="line">        <span class="comment">// Set the boundaries</span></span><span class="line">        $uniq_id = md5(uniqid(time()));</span><span class="line">        <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>] = <span class="string">"b1_"</span> . $uniq_id;</span><span class="line">        <span class="keyword">$this</span>-&gt;boundary[<span class="number">2</span>] = <span class="string">"b2_"</span> . $uniq_id;</span><span class="line"></span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Date"</span>, <span class="keyword">$this</span>-&gt;RFCDate());</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;Sender == <span class="string">""</span>)</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Return-Path"</span>, trim(<span class="keyword">$this</span>-&gt;From));</span><span class="line">        <span class="keyword">else</span></span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Return-Path"</span>, trim(<span class="keyword">$this</span>-&gt;Sender));</span><span class="line"></span><span class="line">        <span class="comment">// To be created automatically by mail()</span></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;Mailer != <span class="string">"mail"</span>)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;to) &gt; <span class="number">0</span>)</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;AddrAppend(<span class="string">"To"</span>, <span class="keyword">$this</span>-&gt;to);</span><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (count(<span class="keyword">$this</span>-&gt;cc) == <span class="number">0</span>)</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"To"</span>, <span class="string">"undisclosed-recipients:;"</span>);</span><span class="line">            <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;cc) &gt; <span class="number">0</span>)</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;AddrAppend(<span class="string">"Cc"</span>, <span class="keyword">$this</span>-&gt;cc);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $from = <span class="keyword">array</span>();</span><span class="line">        $from[<span class="number">0</span>][<span class="number">0</span>] = trim(<span class="keyword">$this</span>-&gt;From);</span><span class="line">        $from[<span class="number">0</span>][<span class="number">1</span>] = <span class="keyword">$this</span>-&gt;FromName;</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;AddrAppend(<span class="string">"From"</span>, $from);</span><span class="line"></span><span class="line">        <span class="comment">// sendmail and mail() extract Bcc from the header before sending</span></span><span class="line">        <span class="keyword">if</span>(((<span class="keyword">$this</span>-&gt;Mailer == <span class="string">"sendmail"</span>) || (<span class="keyword">$this</span>-&gt;Mailer == <span class="string">"mail"</span>)) &amp;&amp; (count(<span class="keyword">$this</span>-&gt;bcc) &gt; <span class="number">0</span>))</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;AddrAppend(<span class="string">"Bcc"</span>, <span class="keyword">$this</span>-&gt;bcc);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;ReplyTo) &gt; <span class="number">0</span>)</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;AddrAppend(<span class="string">"Reply-to"</span>, <span class="keyword">$this</span>-&gt;ReplyTo);</span><span class="line"></span><span class="line">        <span class="comment">// mail() sets the subject itself</span></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;Mailer != <span class="string">"mail"</span>)</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Subject"</span>, <span class="keyword">$this</span>-&gt;EncodeHeader(trim(<span class="keyword">$this</span>-&gt;Subject)));</span><span class="line"></span><span class="line">        $result .= sprintf(<span class="string">"Message-ID: &lt;%s@%s&gt;%s"</span>, $uniq_id, <span class="keyword">$this</span>-&gt;ServerHostname(), <span class="keyword">$this</span>-&gt;LE);</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"X-Priority"</span>, <span class="keyword">$this</span>-&gt;Priority);</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"X-Mailer"</span>, <span class="string">"PHPMailer [version "</span> . <span class="keyword">$this</span>-&gt;Version . <span class="string">"]"</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ConfirmReadingTo != <span class="string">""</span>)</span><span class="line">        &#123;</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Disposition-Notification-To"</span>,</span><span class="line">                       <span class="string">"&lt;"</span> . trim(<span class="keyword">$this</span>-&gt;ConfirmReadingTo) . <span class="string">"&gt;"</span>);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Add custom headers</span></span><span class="line">        <span class="keyword">for</span>($index = <span class="number">0</span>; $index &lt; count(<span class="keyword">$this</span>-&gt;CustomHeader); $index++)</span><span class="line">        &#123;</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;HeaderLine(trim(<span class="keyword">$this</span>-&gt;CustomHeader[$index][<span class="number">0</span>]),</span><span class="line">                       <span class="keyword">$this</span>-&gt;EncodeHeader(trim(<span class="keyword">$this</span>-&gt;CustomHeader[$index][<span class="number">1</span>])));</span><span class="line">        &#125;</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"MIME-Version"</span>, <span class="string">"1.0"</span>);</span><span class="line"></span><span class="line">        <span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;message_type)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">case</span> <span class="string">"plain"</span>:</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Content-Transfer-Encoding"</span>, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                $result .= sprintf(<span class="string">"Content-Type: %s; charset=\"%s\""</span>,</span><span class="line">                                    <span class="keyword">$this</span>-&gt;ContentType, <span class="keyword">$this</span>-&gt;CharSet);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"attachments"</span>:</span><span class="line">                <span class="comment">// fall through</span></span><span class="line">            <span class="keyword">case</span> <span class="string">"alt_attachments"</span>:</span><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;InlineImageExists())</span><span class="line">                &#123;</span><span class="line">                    $result .= sprintf(<span class="string">"Content-Type: %s;%s\ttype=\"text/html\";%s\tboundary=\"%s\"%s"</span>,</span><span class="line">                                    <span class="string">"multipart/related"</span>, <span class="keyword">$this</span>-&gt;LE, <span class="keyword">$this</span>-&gt;LE,</span><span class="line">                                    <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="keyword">$this</span>-&gt;LE);</span><span class="line">                &#125;</span><span class="line">                <span class="keyword">else</span></span><span class="line">                &#123;</span><span class="line">                    $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Content-Type"</span>, <span class="string">"multipart/mixed;"</span>);</span><span class="line">                    $result .= <span class="keyword">$this</span>-&gt;TextLine(<span class="string">"\tboundary=\""</span> . <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>] . <span class="string">'"'</span>);</span><span class="line">                &#125;</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"alt"</span>:</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Content-Type"</span>, <span class="string">"multipart/alternative;"</span>);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;TextLine(<span class="string">"\tboundary=\""</span> . <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>] . <span class="string">'"'</span>);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;Mailer != <span class="string">"mail"</span>)</span><span class="line">            $result .= <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Assembles the message body.  Returns an empty string on failure.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CreateBody</span><span class="params">()</span> </span>&#123;</span><span class="line">        $result = <span class="string">""</span>;</span><span class="line"></span><span class="line">        <span class="keyword">$this</span>-&gt;SetWordWrap();</span><span class="line"></span><span class="line">        <span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;message_type)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">case</span> <span class="string">"alt"</span>:</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;GetBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="string">""</span>,</span><span class="line">                                              <span class="string">"text/plain"</span>, <span class="string">""</span>);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EncodeString(<span class="keyword">$this</span>-&gt;AltBody, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;GetBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="string">""</span>,</span><span class="line">                                              <span class="string">"text/html"</span>, <span class="string">""</span>);</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EncodeString(<span class="keyword">$this</span>-&gt;Body, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EndBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>]);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"plain"</span>:</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EncodeString(<span class="keyword">$this</span>-&gt;Body, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"attachments"</span>:</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;GetBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="string">""</span>, <span class="string">""</span>, <span class="string">""</span>);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EncodeString(<span class="keyword">$this</span>-&gt;Body, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;AttachAll();</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            <span class="keyword">case</span> <span class="string">"alt_attachments"</span>:</span><span class="line">                $result .= sprintf(<span class="string">"--%s%s"</span>, <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="keyword">$this</span>-&gt;LE);</span><span class="line">                $result .= sprintf(<span class="string">"Content-Type: %s;%s"</span> .</span><span class="line">                                   <span class="string">"\tboundary=\"%s\"%s"</span>,</span><span class="line">                                   <span class="string">"multipart/alternative"</span>, <span class="keyword">$this</span>-&gt;LE,</span><span class="line">                                   <span class="keyword">$this</span>-&gt;boundary[<span class="number">2</span>], <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE);</span><span class="line"></span><span class="line">                <span class="comment">// Create text body</span></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;GetBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">2</span>], <span class="string">""</span>,</span><span class="line">                                              <span class="string">"text/plain"</span>, <span class="string">""</span>) . <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EncodeString(<span class="keyword">$this</span>-&gt;AltBody, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">                <span class="comment">// Create the HTML body</span></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;GetBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">2</span>], <span class="string">""</span>,</span><span class="line">                                              <span class="string">"text/html"</span>, <span class="string">""</span>) . <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EncodeString(<span class="keyword">$this</span>-&gt;Body, <span class="keyword">$this</span>-&gt;Encoding);</span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;EndBoundary(<span class="keyword">$this</span>-&gt;boundary[<span class="number">2</span>]);</span><span class="line"></span><span class="line">                $result .= <span class="keyword">$this</span>-&gt;AttachAll();</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;IsError())</span><span class="line">            $result = <span class="string">""</span>;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns the start of a message boundary.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">GetBoundary</span><span class="params">($boundary, $charSet, $contentType, $encoding)</span> </span>&#123;</span><span class="line">        $result = <span class="string">""</span>;</span><span class="line">        <span class="keyword">if</span>($charSet == <span class="string">""</span>) &#123; $charSet = <span class="keyword">$this</span>-&gt;CharSet; &#125;</span><span class="line">        <span class="keyword">if</span>($contentType == <span class="string">""</span>) &#123; $contentType = <span class="keyword">$this</span>-&gt;ContentType; &#125;</span><span class="line">        <span class="keyword">if</span>($encoding == <span class="string">""</span>) &#123; $encoding = <span class="keyword">$this</span>-&gt;Encoding; &#125;</span><span class="line"></span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;TextLine(<span class="string">"--"</span> . $boundary);</span><span class="line">        $result .= sprintf(<span class="string">"Content-Type: %s; charset = \"%s\""</span>,</span><span class="line">                            $contentType, $charSet);</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;LE;</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;HeaderLine(<span class="string">"Content-Transfer-Encoding"</span>, $encoding);</span><span class="line">        $result .= <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns the end of a message boundary.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">EndBoundary</span><span class="params">($boundary)</span> </span>&#123;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;LE . <span class="string">"--"</span> . $boundary . <span class="string">"--"</span> . <span class="keyword">$this</span>-&gt;LE;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sets the message type.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SetMessageType</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;attachment) &lt; <span class="number">1</span> &amp;&amp; strlen(<span class="keyword">$this</span>-&gt;AltBody) &lt; <span class="number">1</span>)</span><span class="line">            <span class="keyword">$this</span>-&gt;message_type = <span class="string">"plain"</span>;</span><span class="line">        <span class="keyword">else</span></span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;attachment) &gt; <span class="number">0</span>)</span><span class="line">                <span class="keyword">$this</span>-&gt;message_type = <span class="string">"attachments"</span>;</span><span class="line">            <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;AltBody) &gt; <span class="number">0</span> &amp;&amp; count(<span class="keyword">$this</span>-&gt;attachment) &lt; <span class="number">1</span>)</span><span class="line">                <span class="keyword">$this</span>-&gt;message_type = <span class="string">"alt"</span>;</span><span class="line">            <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;AltBody) &gt; <span class="number">0</span> &amp;&amp; count(<span class="keyword">$this</span>-&gt;attachment) &gt; <span class="number">0</span>)</span><span class="line">                <span class="keyword">$this</span>-&gt;message_type = <span class="string">"alt_attachments"</span>;</span><span class="line">        &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns a formatted header line.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">HeaderLine</span><span class="params">($name, $value)</span> </span>&#123;</span><span class="line">        <span class="keyword">return</span> $name . <span class="string">": "</span> . $value . <span class="keyword">$this</span>-&gt;LE;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns a formatted mail line.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">TextLine</span><span class="params">($value)</span> </span>&#123;</span><span class="line">        <span class="keyword">return</span> $value . <span class="keyword">$this</span>-&gt;LE;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// ATTACHMENT METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds an attachment from a path on the filesystem.</span></span><span class="line"><span class="comment">     * Returns false if the file could not be found</span></span><span class="line"><span class="comment">     * or accessed.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $path Path to the attachment.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name Overrides the attachment name.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $encoding File encoding (see $Encoding).</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $type File extension (MIME) type.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddAttachment</span><span class="params">($path, $name = <span class="string">""</span>, $encoding = <span class="string">"base64"</span>,</span></span></span><span class="line"><span class="function"><span class="params">                           $type = <span class="string">"application/octet-stream"</span>)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(!@is_file($path))</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"file_access"</span>) . $path);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $filename = basename($path);</span><span class="line">        <span class="keyword">if</span>($name == <span class="string">""</span>)</span><span class="line">            $name = $filename;</span><span class="line"></span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;attachment);</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">0</span>] = $path;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">1</span>] = $filename;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">2</span>] = $name;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">3</span>] = $encoding;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">4</span>] = $type;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">5</span>] = <span class="keyword">false</span>; <span class="comment">// isStringAttachment</span></span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">6</span>] = <span class="string">"attachment"</span>;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">7</span>] = <span class="number">0</span>;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Attaches all fs, string, and binary attachments to the message.</span></span><span class="line"><span class="comment">     * Returns an empty string on failure.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AttachAll</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="comment">// Return text of body</span></span><span class="line">        $mime = <span class="keyword">array</span>();</span><span class="line"></span><span class="line">        <span class="comment">// Add all attachments</span></span><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count(<span class="keyword">$this</span>-&gt;attachment); $i++)</span><span class="line">        &#123;</span><span class="line">            <span class="comment">// Check for string attachment</span></span><span class="line">            $bString = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">5</span>];</span><span class="line">            <span class="keyword">if</span> ($bString)</span><span class="line">                $string = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">0</span>];</span><span class="line">            <span class="keyword">else</span></span><span class="line">                $path = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">0</span>];</span><span class="line"></span><span class="line">            $filename    = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">1</span>];</span><span class="line">            $name        = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">2</span>];</span><span class="line">            $encoding    = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">3</span>];</span><span class="line">            $type        = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">4</span>];</span><span class="line">            $disposition = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">6</span>];</span><span class="line">            $cid         = <span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">7</span>];</span><span class="line"></span><span class="line">            $mime[] = sprintf(<span class="string">"--%s%s"</span>, <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="keyword">$this</span>-&gt;LE);</span><span class="line">            $mime[] = sprintf(<span class="string">"Content-Type: %s; name=\"%s\"%s"</span>, $type, $name, <span class="keyword">$this</span>-&gt;LE);</span><span class="line">            $mime[] = sprintf(<span class="string">"Content-Transfer-Encoding: %s%s"</span>, $encoding, <span class="keyword">$this</span>-&gt;LE);</span><span class="line"></span><span class="line">            <span class="keyword">if</span>($disposition == <span class="string">"inline"</span>)</span><span class="line">                $mime[] = sprintf(<span class="string">"Content-ID: &lt;%s&gt;%s"</span>, $cid, <span class="keyword">$this</span>-&gt;LE);</span><span class="line"></span><span class="line">            $mime[] = sprintf(<span class="string">"Content-Disposition: %s; filename=\"%s\"%s"</span>,</span><span class="line">                              $disposition, $name, <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE);</span><span class="line"></span><span class="line">            <span class="comment">// Encode as string attachment</span></span><span class="line">            <span class="keyword">if</span>($bString)</span><span class="line">            &#123;</span><span class="line">                $mime[] = <span class="keyword">$this</span>-&gt;EncodeString($string, $encoding);</span><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;IsError()) &#123; <span class="keyword">return</span> <span class="string">""</span>; &#125;</span><span class="line">                $mime[] = <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">else</span></span><span class="line">            &#123;</span><span class="line">                $mime[] = <span class="keyword">$this</span>-&gt;EncodeFile($path, $encoding);</span><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;IsError()) &#123; <span class="keyword">return</span> <span class="string">""</span>; &#125;</span><span class="line">                $mime[] = <span class="keyword">$this</span>-&gt;LE.<span class="keyword">$this</span>-&gt;LE;</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $mime[] = sprintf(<span class="string">"--%s--%s"</span>, <span class="keyword">$this</span>-&gt;boundary[<span class="number">1</span>], <span class="keyword">$this</span>-&gt;LE);</span><span class="line"></span><span class="line">        <span class="keyword">return</span> join(<span class="string">""</span>, $mime);</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Encodes attachment in requested format.  Returns an</span></span><span class="line"><span class="comment">     * empty string on failure.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">EncodeFile</span> <span class="params">($path, $encoding = <span class="string">"base64"</span>)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(!@$fd = fopen($path, <span class="string">"rb"</span>))</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"file_open"</span>) . $path);</span><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><span class="line">        &#125;</span><span class="line">        $magic_quotes = get_magic_quotes_runtime();</span><span class="line">        set_magic_quotes_runtime(<span class="number">0</span>);</span><span class="line">        $file_buffer = fread($fd, filesize($path));</span><span class="line">        $file_buffer = <span class="keyword">$this</span>-&gt;EncodeString($file_buffer, $encoding);</span><span class="line">        fclose($fd);</span><span class="line">        set_magic_quotes_runtime($magic_quotes);</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $file_buffer;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Encodes string to requested format. Returns an</span></span><span class="line"><span class="comment">     * empty string on failure.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">EncodeString</span> <span class="params">($str, $encoding = <span class="string">"base64"</span>)</span> </span>&#123;</span><span class="line">        $encoded = <span class="string">""</span>;</span><span class="line">        <span class="keyword">switch</span>(strtolower($encoding)) &#123;</span><span class="line">          <span class="keyword">case</span> <span class="string">"base64"</span>:</span><span class="line">              <span class="comment">// chunk_split is found in PHP &gt;= 3.0.6</span></span><span class="line">              $encoded = chunk_split(base64_encode($str), <span class="number">76</span>, <span class="keyword">$this</span>-&gt;LE);</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">          <span class="keyword">case</span> <span class="string">"7bit"</span>:</span><span class="line">          <span class="keyword">case</span> <span class="string">"8bit"</span>:</span><span class="line">              $encoded = <span class="keyword">$this</span>-&gt;FixEOL($str);</span><span class="line">              <span class="keyword">if</span> (substr($encoded, -(strlen(<span class="keyword">$this</span>-&gt;LE))) != <span class="keyword">$this</span>-&gt;LE)</span><span class="line">                $encoded .= <span class="keyword">$this</span>-&gt;LE;</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">          <span class="keyword">case</span> <span class="string">"binary"</span>:</span><span class="line">              $encoded = $str;</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">          <span class="keyword">case</span> <span class="string">"quoted-printable"</span>:</span><span class="line">              $encoded = <span class="keyword">$this</span>-&gt;EncodeQP($str);</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">          <span class="keyword">default</span>:</span><span class="line">              <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"encoding"</span>) . $encoding);</span><span class="line">              <span class="keyword">break</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> $encoded;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Encode a header string to best of Q, B, quoted or none.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">EncodeHeader</span> <span class="params">($str, $position = <span class="string">'text'</span>)</span> </span>&#123;</span><span class="line">      $x = <span class="number">0</span>;</span><span class="line"></span><span class="line">      <span class="keyword">switch</span> (strtolower($position)) &#123;</span><span class="line">        <span class="keyword">case</span> <span class="string">'phrase'</span>:</span><span class="line">          <span class="keyword">if</span> (!preg_match(<span class="string">'/[\200-\377]/'</span>, $str)) &#123;</span><span class="line">            <span class="comment">// Can't use addslashes as we don't know what value has magic_quotes_sybase.</span></span><span class="line">            $encoded = addcslashes($str, <span class="string">"\0..\37\177\\\""</span>);</span><span class="line"></span><span class="line">            <span class="keyword">if</span> (($str == $encoded) &amp;&amp; !preg_match(<span class="string">'/[^A-Za-z0-9!#$%&amp;\'*+\/=?^_`&#123;|&#125;~ -]/'</span>, $str))</span><span class="line">              <span class="keyword">return</span> ($encoded);</span><span class="line">            <span class="keyword">else</span></span><span class="line">              <span class="keyword">return</span> (<span class="string">"\"$encoded\""</span>);</span><span class="line">          &#125;</span><span class="line">          $x = preg_match_all(<span class="string">'/[^\040\041\043-\133\135-\176]/'</span>, $str, $matches);</span><span class="line">          <span class="keyword">break</span>;</span><span class="line">        <span class="keyword">case</span> <span class="string">'comment'</span>:</span><span class="line">          $x = preg_match_all(<span class="string">'/[()"]/'</span>, $str, $matches);</span><span class="line">          <span class="comment">// Fall-through</span></span><span class="line">        <span class="keyword">case</span> <span class="string">'text'</span>:</span><span class="line">        <span class="keyword">default</span>:</span><span class="line">          $x += preg_match_all(<span class="string">'/[\000-\010\013\014\016-\037\177-\377]/'</span>, $str, $matches);</span><span class="line">          <span class="keyword">break</span>;</span><span class="line">      &#125;</span><span class="line"></span><span class="line">      <span class="keyword">if</span> ($x == <span class="number">0</span>)</span><span class="line">        <span class="keyword">return</span> ($str);</span><span class="line"></span><span class="line">      $maxlen = <span class="number">75</span> - <span class="number">7</span> - strlen(<span class="keyword">$this</span>-&gt;CharSet);</span><span class="line">      <span class="comment">// Try to select the encoding which should produce the shortest output</span></span><span class="line">      <span class="keyword">if</span> (strlen($str)/<span class="number">3</span> &lt; $x) &#123;</span><span class="line">        $encoding = <span class="string">'B'</span>;</span><span class="line">        $encoded = base64_encode($str);</span><span class="line">        $maxlen -= $maxlen % <span class="number">4</span>;</span><span class="line">        $encoded = trim(chunk_split($encoded, $maxlen, <span class="string">"\n"</span>));</span><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><span class="line">        $encoding = <span class="string">'Q'</span>;</span><span class="line">        $encoded = <span class="keyword">$this</span>-&gt;EncodeQ($str, $position);</span><span class="line">        $encoded = <span class="keyword">$this</span>-&gt;WrapText($encoded, $maxlen, <span class="keyword">true</span>);</span><span class="line">        $encoded = str_replace(<span class="string">"="</span>.<span class="keyword">$this</span>-&gt;LE, <span class="string">"\n"</span>, trim($encoded));</span><span class="line">      &#125;</span><span class="line"></span><span class="line">      $encoded = preg_replace(<span class="string">'/^(.*)$/m'</span>, <span class="string">" =?"</span>.<span class="keyword">$this</span>-&gt;CharSet.<span class="string">"?$encoding?\\1?="</span>, $encoded);</span><span class="line">      $encoded = trim(str_replace(<span class="string">"\n"</span>, <span class="keyword">$this</span>-&gt;LE, $encoded));</span><span class="line"></span><span class="line">      <span class="keyword">return</span> $encoded;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Encode string to quoted-printable.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">EncodeQP</span> <span class="params">($str)</span> </span>&#123;</span><span class="line">        $encoded = <span class="keyword">$this</span>-&gt;FixEOL($str);</span><span class="line">        <span class="keyword">if</span> (substr($encoded, -(strlen(<span class="keyword">$this</span>-&gt;LE))) != <span class="keyword">$this</span>-&gt;LE)</span><span class="line">            $encoded .= <span class="keyword">$this</span>-&gt;LE;</span><span class="line"></span><span class="line">        <span class="comment">// Replace every high ascii, control and = characters</span></span><span class="line">        $encoded = preg_replace(<span class="string">'/([\000-\010\013\014\016-\037\075\177-\377])/e'</span>,</span><span class="line">                  <span class="string">"'='.sprintf('%02X', ord('\\1'))"</span>, $encoded);</span><span class="line">        <span class="comment">// Replace every spaces and tabs when it's the last character on a line</span></span><span class="line">        $encoded = preg_replace(<span class="string">"/([\011\040])"</span>.<span class="keyword">$this</span>-&gt;LE.<span class="string">"/e"</span>,</span><span class="line">                  <span class="string">"'='.sprintf('%02X', ord('\\1')).'"</span>.<span class="keyword">$this</span>-&gt;LE.<span class="string">"'"</span>, $encoded);</span><span class="line"></span><span class="line">        <span class="comment">// Maximum line length of 76 characters before CRLF (74 + space + '=')</span></span><span class="line">        $encoded = <span class="keyword">$this</span>-&gt;WrapText($encoded, <span class="number">74</span>, <span class="keyword">true</span>);</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $encoded;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Encode string to q encoding.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">EncodeQ</span> <span class="params">($str, $position = <span class="string">"text"</span>)</span> </span>&#123;</span><span class="line">        <span class="comment">// There should not be any EOL in the string</span></span><span class="line">        $encoded = preg_replace(<span class="string">"[\r\n]"</span>, <span class="string">""</span>, $str);</span><span class="line"></span><span class="line">        <span class="keyword">switch</span> (strtolower($position)) &#123;</span><span class="line">          <span class="keyword">case</span> <span class="string">"phrase"</span>:</span><span class="line">            $encoded = preg_replace(<span class="string">"/([^A-Za-z0-9!*+\/ -])/e"</span>, <span class="string">"'='.sprintf('%02X', ord('\\1'))"</span>, $encoded);</span><span class="line">            <span class="keyword">break</span>;</span><span class="line">          <span class="keyword">case</span> <span class="string">"comment"</span>:</span><span class="line">            $encoded = preg_replace(<span class="string">"/([\(\)\"])/e"</span>, <span class="string">"'='.sprintf('%02X', ord('\\1'))"</span>, $encoded);</span><span class="line">          <span class="keyword">case</span> <span class="string">"text"</span>:</span><span class="line">          <span class="keyword">default</span>:</span><span class="line">            <span class="comment">// Replace every high ascii, control =, ? and _ characters</span></span><span class="line">            $encoded = preg_replace(<span class="string">'/([\000-\011\013\014\016-\037\075\077\137\177-\377])/e'</span>,</span><span class="line">                  <span class="string">"'='.sprintf('%02X', ord('\\1'))"</span>, $encoded);</span><span class="line">            <span class="keyword">break</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Replace every spaces to _ (more readable than =20)</span></span><span class="line">        $encoded = str_replace(<span class="string">" "</span>, <span class="string">"_"</span>, $encoded);</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $encoded;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds a string or binary attachment (non-filesystem) to the list.</span></span><span class="line"><span class="comment">     * This method can be used to attach ascii or binary data,</span></span><span class="line"><span class="comment">     * such as a BLOB record from a database.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $string String attachment data.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $filename Name of the attachment.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $encoding File encoding (see $Encoding).</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $type File extension (MIME) type.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddStringAttachment</span><span class="params">($string, $filename, $encoding = <span class="string">"base64"</span>,</span></span></span><span class="line"><span class="function"><span class="params">                                 $type = <span class="string">"application/octet-stream"</span>)</span> </span>&#123;</span><span class="line">        <span class="comment">// Append to $attachment array</span></span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;attachment);</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">0</span>] = $string;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">1</span>] = $filename;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">2</span>] = $filename;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">3</span>] = $encoding;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">4</span>] = $type;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">5</span>] = <span class="keyword">true</span>; <span class="comment">// isString</span></span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">6</span>] = <span class="string">"attachment"</span>;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">7</span>] = <span class="number">0</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds an embedded attachment.  This can include images, sounds, and</span></span><span class="line"><span class="comment">     * just about any other document.  Make sure to set the $type to an</span></span><span class="line"><span class="comment">     * image type.  For JPEG images use "image/jpeg" and for GIF images</span></span><span class="line"><span class="comment">     * use "image/gif".</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $path Path to the attachment.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $cid Content ID of the attachment.  Use this to identify</span></span><span class="line"><span class="comment">     *        the Id for accessing the image in an HTML form.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $name Overrides the attachment name.</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $encoding File encoding (see $Encoding).</span></span><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $type File extension (MIME) type.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddEmbeddedImage</span><span class="params">($path, $cid, $name = <span class="string">""</span>, $encoding = <span class="string">"base64"</span>,</span></span></span><span class="line"><span class="function"><span class="params">                              $type = <span class="string">"application/octet-stream"</span>)</span> </span>&#123;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!@is_file($path))</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;SetError(<span class="keyword">$this</span>-&gt;Lang(<span class="string">"file_access"</span>) . $path);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $filename = basename($path);</span><span class="line">        <span class="keyword">if</span>($name == <span class="string">""</span>)</span><span class="line">            $name = $filename;</span><span class="line"></span><span class="line">        <span class="comment">// Append to $attachment array</span></span><span class="line">        $cur = count(<span class="keyword">$this</span>-&gt;attachment);</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">0</span>] = $path;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">1</span>] = $filename;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">2</span>] = $name;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">3</span>] = $encoding;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">4</span>] = $type;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">5</span>] = <span class="keyword">false</span>; <span class="comment">// isStringAttachment</span></span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">6</span>] = <span class="string">"inline"</span>;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment[$cur][<span class="number">7</span>] = $cid;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns true if an inline attachment is present.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">InlineImageExists</span><span class="params">()</span> </span>&#123;</span><span class="line">        $result = <span class="keyword">false</span>;</span><span class="line">        <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; count(<span class="keyword">$this</span>-&gt;attachment); $i++)</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;attachment[$i][<span class="number">6</span>] == <span class="string">"inline"</span>)</span><span class="line">            &#123;</span><span class="line">                $result = <span class="keyword">true</span>;</span><span class="line">                <span class="keyword">break</span>;</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// MESSAGE RESET METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all recipients assigned in the TO array.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearAddresses</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all recipients assigned in the CC array.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearCCs</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;cc = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all recipients assigned in the BCC array.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearBCCs</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;bcc = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all recipients assigned in the ReplyTo array.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearReplyTos</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;ReplyTo = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all recipients assigned in the TO, CC and BCC</span></span><span class="line"><span class="comment">     * array.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearAllRecipients</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;to = <span class="keyword">array</span>();</span><span class="line">        <span class="keyword">$this</span>-&gt;cc = <span class="keyword">array</span>();</span><span class="line">        <span class="keyword">$this</span>-&gt;bcc = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all previously set filesystem, string, and binary</span></span><span class="line"><span class="comment">     * attachments.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearAttachments</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;attachment = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Clears all custom headers.  Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ClearCustomHeaders</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;CustomHeader = <span class="keyword">array</span>();</span><span class="line">    &#125;</span><span class="line"></span><span class="line"></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line">    <span class="comment">// MISCELLANEOUS METHODS</span></span><span class="line">    <span class="comment">/////////////////////////////////////////////////</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds the error message to the error container.</span></span><span class="line"><span class="comment">     * Returns void.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SetError</span><span class="params">($msg)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error_count++;</span><span class="line">        <span class="keyword">$this</span>-&gt;ErrorInfo = $msg;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns the proper RFC 822 formatted date.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">RFCDate</span><span class="params">()</span> </span>&#123;</span><span class="line">        $tz = date(<span class="string">"Z"</span>);</span><span class="line">        $tzs = ($tz &lt; <span class="number">0</span>) ? <span class="string">"-"</span> : <span class="string">"+"</span>;</span><span class="line">        $tz = abs($tz);</span><span class="line">        $tz = ($tz/<span class="number">3600</span>)*<span class="number">100</span> + ($tz%<span class="number">3600</span>)/<span class="number">60</span>;</span><span class="line">        $result = sprintf(<span class="string">"%s %s%04d"</span>, date(<span class="string">"D, j M Y H:i:s"</span>), $tzs, $tz);</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns the appropriate server variable.  Should work with both</span></span><span class="line"><span class="comment">     * PHP 4.1.0+ as well as older versions.  Returns an empty string</span></span><span class="line"><span class="comment">     * if nothing is found.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ServerVar</span><span class="params">($varName)</span> </span>&#123;</span><span class="line">        <span class="keyword">global</span> $HTTP_SERVER_VARS;</span><span class="line">        <span class="keyword">global</span> $HTTP_ENV_VARS;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SERVER))</span><span class="line">        &#123;</span><span class="line">            $_SERVER = $HTTP_SERVER_VARS;</span><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]))</span><span class="line">                $_SERVER = $HTTP_ENV_VARS; <span class="comment">// must be Apache</span></span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[$varName]))</span><span class="line">            <span class="keyword">return</span> $_SERVER[$varName];</span><span class="line">        <span class="keyword">else</span></span><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns the server hostname or 'localhost.localdomain' if unknown.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ServerHostname</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;Hostname != <span class="string">""</span>)</span><span class="line">            $result = <span class="keyword">$this</span>-&gt;Hostname;</span><span class="line">        <span class="keyword">elseif</span> (<span class="keyword">$this</span>-&gt;ServerVar(<span class="string">'SERVER_NAME'</span>) != <span class="string">""</span>)</span><span class="line">            $result = <span class="keyword">$this</span>-&gt;ServerVar(<span class="string">'SERVER_NAME'</span>);</span><span class="line">        <span class="keyword">else</span></span><span class="line">            $result = <span class="string">"localhost.localdomain"</span>;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $result;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns a message in the appropriate language.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Lang</span><span class="params">($key)</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(count(<span class="keyword">$this</span>-&gt;language) &lt; <span class="number">1</span>)</span><span class="line">            <span class="keyword">$this</span>-&gt;SetLanguage(<span class="string">"en"</span>); <span class="comment">// set the default language</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;language[$key]))</span><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;language[$key];</span><span class="line">        <span class="keyword">else</span></span><span class="line">            <span class="keyword">return</span> <span class="string">"Language string failed to load: "</span> . $key;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns true if an error occurred.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">IsError</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">return</span> (<span class="keyword">$this</span>-&gt;error_count &gt; <span class="number">0</span>);</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Changes every end of line from CR or LF to CRLF.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">FixEOL</span><span class="params">($str)</span> </span>&#123;</span><span class="line">        $str = str_replace(<span class="string">"\r\n"</span>, <span class="string">"\n"</span>, $str);</span><span class="line">        $str = str_replace(<span class="string">"\r"</span>, <span class="string">"\n"</span>, $str);</span><span class="line">        $str = str_replace(<span class="string">"\n"</span>, <span class="keyword">$this</span>-&gt;LE, $str);</span><span class="line">        <span class="keyword">return</span> $str;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Adds a custom header.</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">AddCustomHeader</span><span class="params">($custom_header)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;CustomHeader[] = explode(<span class="string">":"</span>, $custom_header, <span class="number">2</span>);</span><span class="line">    &#125;</span><span class="line">&#125;</span><span class="line"></span><span class="line"><span class="meta">?&gt;</span></span></pre></td></tr></table></figure>
<h2 id="class-smtp-php-source-modified-for-gmail"><a href="#class-smtp-php-source-modified-for-gmail" class="headerlink" title="class.smtp.php source (modified for gmail)"></a>class.smtp.php source (modified for gmail)</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">////////////////////////////////////////////////////</span></span><span class="line"><span class="comment">// SMTP - PHP SMTP class</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Version 1.02</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Define an SMTP class that can be used to connect</span></span><span class="line"><span class="comment">// and communicate with any SMTP server. It implements</span></span><span class="line"><span class="comment">// all the SMTP functions defined in RFC821 except TURN.</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// Author: Chris Ryan</span></span><span class="line"><span class="comment">//</span></span><span class="line"><span class="comment">// License: LGPL, see LICENSE</span></span><span class="line"><span class="comment">////////////////////////////////////////////////////</span></span><span class="line"></span><span class="line"><span class="comment">/**</span></span><span class="line"><span class="comment"> * SMTP is rfc 821 compliant and implements all the rfc 821 SMTP</span></span><span class="line"><span class="comment"> * commands except TURN which will always return a not implemented</span></span><span class="line"><span class="comment"> * error. SMTP also provides some utility methods for sending mail</span></span><span class="line"><span class="comment"> * to an SMTP server.</span></span><span class="line"><span class="comment"> * <span class="doctag">@package</span> PHPMailer</span></span><span class="line"><span class="comment"> * <span class="doctag">@author</span> Chris Ryan</span></span><span class="line"><span class="comment"> */</span></span><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTP</span></span></span><span class="line"><span class="class"></span>&#123;</span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  SMTP server port</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> int</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $SMTP_PORT = <span class="number">25</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  SMTP reply line ending</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $CRLF = <span class="string">"\r\n"</span>;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     *  Sets whether debugging is turned on</span></span><span class="line"><span class="comment">     *  <span class="doctag">@var</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $do_debug;       <span class="comment"># the level of debug to perform</span></span><span class="line"></span><span class="line">    <span class="comment">/**#@+</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="keyword">var</span> $smtp_conn;      <span class="comment"># the socket to the server</span></span><span class="line">    <span class="keyword">var</span> $error;          <span class="comment"># error if any on the last call</span></span><span class="line">    <span class="keyword">var</span> $helo_rply;      <span class="comment"># the reply the server sent to us for HELO</span></span><span class="line">    <span class="comment">/**#@-*/</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Initialize the class so that the data is in a known state.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SMTP</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;smtp_conn = <span class="number">0</span>;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>;</span><span class="line">        <span class="keyword">$this</span>-&gt;helo_rply = <span class="keyword">null</span>;</span><span class="line"></span><span class="line">        <span class="keyword">$this</span>-&gt;do_debug = <span class="number">0</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/*************************************************************</span></span><span class="line"><span class="comment">     *                    CONNECTION FUNCTIONS                  *</span></span><span class="line"><span class="comment">     ***********************************************************/</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Connect to the server specified on the port specified.</span></span><span class="line"><span class="comment">     * If the port is not specified use the default SMTP_PORT.</span></span><span class="line"><span class="comment">     * If tval is specified then a connection will try and be</span></span><span class="line"><span class="comment">     * established with the server for that number of seconds.</span></span><span class="line"><span class="comment">     * If tval is not specified the default is 30 seconds to</span></span><span class="line"><span class="comment">     * try on the connection.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 220</span></span><span class="line"><span class="comment">     * SMTP CODE FAILURE: 421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Connect</span><span class="params">($host,$port=<span class="number">0</span>,$tval=<span class="number">30</span>)</span> </span>&#123;</span><span class="line">        <span class="comment"># set the error val to null so there is no confusion</span></span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>;</span><span class="line"></span><span class="line">        <span class="comment"># make sure we are __not__ connected</span></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="comment"># ok we are connected! what should we do?</span></span><span class="line">            <span class="comment"># for now we will just give an error saying we</span></span><span class="line">            <span class="comment"># are already connected</span></span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"Already connected to a server"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($port)) &#123;</span><span class="line">            $port = <span class="keyword">$this</span>-&gt;SMTP_PORT;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">  <span class="comment">// fsockopen --  Open Internet or Unix domain socket connection</span></span><span class="line">  <span class="comment">// As of PHP 4.3.0, if you have compiled in OpenSSL support, you may prefix the hostname with either 'ssl://' or 'tls://' to use an SSL or TLS client connection over TCP/IP to connect to the remote host.</span></span><span class="line">  <span class="keyword">if</span> ($host == <span class="string">"smtp.gmail.com"</span>) &#123;</span><span class="line">   $host = <span class="string">"ssl://smtp.gmail.com"</span>;</span><span class="line">   $port = <span class="number">465</span>;</span><span class="line">  &#125;</span><span class="line"></span><span class="line">        <span class="comment">#connect to the smtp server</span></span><span class="line">        <span class="keyword">$this</span>-&gt;smtp_conn = fsockopen($host,    <span class="comment"># the host of the server</span></span><span class="line">                                     $port,    <span class="comment"># the port to use</span></span><span class="line">                                     $errno,   <span class="comment"># error number if any</span></span><span class="line">                                     $errstr,  <span class="comment"># error message if any</span></span><span class="line">                                     $tval);   <span class="comment"># give up after ? secs</span></span><span class="line">        <span class="comment"># verify we connected properly</span></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;smtp_conn)) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"Failed to connect to server"</span>,</span><span class="line">                                 <span class="string">"errno"</span> =&gt; $errno,</span><span class="line">                                 <span class="string">"errstr"</span> =&gt; $errstr);</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": $errstr ($errno)"</span> . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment"># sometimes the SMTP server takes a little longer to respond</span></span><span class="line">        <span class="comment"># so we will give it a longer timeout for the first read</span></span><span class="line">        <span class="comment">// Windows still does not have support for this timeout function</span></span><span class="line">        <span class="keyword">if</span>(substr(PHP_OS, <span class="number">0</span>, <span class="number">3</span>) != <span class="string">"WIN"</span>)</span><span class="line">           socket_set_timeout(<span class="keyword">$this</span>-&gt;smtp_conn, $tval, <span class="number">0</span>);</span><span class="line"></span><span class="line">        <span class="comment"># get any announcement stuff</span></span><span class="line">        $announce = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line"></span><span class="line">        <span class="comment"># set the timeout  of any socket functions at 1/10 of a second</span></span><span class="line">        <span class="comment">//if(function_exists("socket_set_timeout"))</span></span><span class="line">        <span class="comment">//   socket_set_timeout($this-&gt;smtp_conn, 0, 100000);</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $announce;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Performs SMTP authentication.  Must be run after running the</span></span><span class="line"><span class="comment">     * Hello() method.  Returns true if successfully authenticated.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Authenticate</span><span class="params">($username, $password)</span> </span>&#123;</span><span class="line">        <span class="comment">// Start authentication</span></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"AUTH LOGIN"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">334</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"AUTH not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Send encoded username</span></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn, base64_encode($username) . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">334</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"Username not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Send encoded password</span></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn, base64_encode($password) . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">235</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"Password not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Returns true if connected to a server otherwise false</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Connected</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;smtp_conn)) &#123;</span><span class="line">            $sock_status = socket_get_status(<span class="keyword">$this</span>-&gt;smtp_conn);</span><span class="line">            <span class="keyword">if</span>($sock_status[<span class="string">"eof"</span>]) &#123;</span><span class="line">                <span class="comment"># hmm this is an odd situation... the socket is</span></span><span class="line">                <span class="comment"># valid but we aren't connected anymore</span></span><span class="line">                <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                    <span class="keyword">echo</span> <span class="string">"SMTP -&gt; NOTICE:"</span> . <span class="keyword">$this</span>-&gt;CRLF .</span><span class="line">                         <span class="string">"EOF caught while checking if connected"</span>;</span><span class="line">                &#125;</span><span class="line">                <span class="keyword">$this</span>-&gt;Close();</span><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment"># everything looks good</span></span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Closes the socket and cleans up the state of the class.</span></span><span class="line"><span class="comment">     * It is not considered good to use this function without</span></span><span class="line"><span class="comment">     * first trying to use QUIT.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Close</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so there is no confusion</span></span><span class="line">        <span class="keyword">$this</span>-&gt;helo_rply = <span class="keyword">null</span>;</span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;smtp_conn)) &#123;</span><span class="line">            <span class="comment"># close the connection and cleanup</span></span><span class="line">            fclose(<span class="keyword">$this</span>-&gt;smtp_conn);</span><span class="line">            <span class="keyword">$this</span>-&gt;smtp_conn = <span class="number">0</span>;</span><span class="line">        &#125;</span><span class="line">    &#125;</span><span class="line"></span><span class="line"></span><span class="line">    <span class="comment">/***************************************************************</span></span><span class="line"><span class="comment">     *                        SMTP COMMANDS                       *</span></span><span class="line"><span class="comment">     *************************************************************/</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Issues a data command and sends the msg_data to the server</span></span><span class="line"><span class="comment">     * finializing the mail transaction. $msg_data is the message</span></span><span class="line"><span class="comment">     * that is to be send with the headers. Each header needs to be</span></span><span class="line"><span class="comment">     * on a single line followed by a  with the message headers</span></span><span class="line"><span class="comment">     * and the message body being seperated by and additional .</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: DATA</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE INTERMEDIATE: 354</span></span><span class="line"><span class="comment">     *     [data]</span></span><span class="line"><span class="comment">     *     .</span></span><span class="line"><span class="comment">     *     SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     *     SMTP CODE FAILURE: 552,554,451,452</span></span><span class="line"><span class="comment">     * SMTP CODE FAILURE: 451,554</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500,501,503,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Data</span><span class="params">($msg_data)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Data() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"DATA"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">354</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"DATA command not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment"># the server is ready to accept data!</span></span><span class="line">        <span class="comment"># according to rfc 821 we should not send more than 1000</span></span><span class="line">        <span class="comment"># including the CRLF</span></span><span class="line">        <span class="comment"># characters on a single line so we will break the data up</span></span><span class="line">        <span class="comment"># into lines by \r and/or \n then if needed we will break</span></span><span class="line">        <span class="comment"># each of those into smaller lines to fit within the limit.</span></span><span class="line">        <span class="comment"># in addition we will be looking for lines that start with</span></span><span class="line">        <span class="comment"># a period '.' and append and additional period '.' to that</span></span><span class="line">        <span class="comment"># line. <span class="doctag">NOTE:</span> this does not count towards are limit.</span></span><span class="line"></span><span class="line">        <span class="comment"># normalize the line breaks so we know the explode works</span></span><span class="line">        $msg_data = str_replace(<span class="string">"\r\n"</span>,<span class="string">"\n"</span>,$msg_data);</span><span class="line">        $msg_data = str_replace(<span class="string">"\r"</span>,<span class="string">"\n"</span>,$msg_data);</span><span class="line">        $lines = explode(<span class="string">"\n"</span>,$msg_data);</span><span class="line"></span><span class="line">        <span class="comment"># we need to find a good way to determine is headers are</span></span><span class="line">        <span class="comment"># in the msg_data or if it is a straight msg body</span></span><span class="line">        <span class="comment"># currently I'm assuming rfc 822 definitions of msg headers</span></span><span class="line">        <span class="comment"># and if the first field of the first line (':' sperated)</span></span><span class="line">        <span class="comment"># does not contain a space then it _should_ be a header</span></span><span class="line">        <span class="comment"># and we can process all lines before a blank "" line as</span></span><span class="line">        <span class="comment"># headers.</span></span><span class="line">        $field = substr($lines[<span class="number">0</span>],<span class="number">0</span>,strpos($lines[<span class="number">0</span>],<span class="string">":"</span>));</span><span class="line">        $in_headers = <span class="keyword">false</span>;</span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($field) &amp;&amp; !strstr($field,<span class="string">" "</span>)) &#123;</span><span class="line">            $in_headers = <span class="keyword">true</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $max_line_length = <span class="number">998</span>; <span class="comment"># used below; set here for ease in change</span></span><span class="line"></span><span class="line">        <span class="keyword">while</span>(<span class="keyword">list</span>(,$line) = @each($lines)) &#123;</span><span class="line">            $lines_out = <span class="keyword">null</span>;</span><span class="line">            <span class="keyword">if</span>($line == <span class="string">""</span> &amp;&amp; $in_headers) &#123;</span><span class="line">                $in_headers = <span class="keyword">false</span>;</span><span class="line">            &#125;</span><span class="line">            <span class="comment"># ok we need to break this line up into several</span></span><span class="line">            <span class="comment"># smaller lines</span></span><span class="line">            <span class="keyword">while</span>(strlen($line) &gt; $max_line_length) &#123;</span><span class="line">                $pos = strrpos(substr($line,<span class="number">0</span>,$max_line_length),<span class="string">" "</span>);</span><span class="line"></span><span class="line">                <span class="comment"># Patch to fix DOS attack</span></span><span class="line">                <span class="keyword">if</span>(!$pos) &#123;</span><span class="line">                    $pos = $max_line_length - <span class="number">1</span>;</span><span class="line">                &#125;</span><span class="line"></span><span class="line">                $lines_out[] = substr($line,<span class="number">0</span>,$pos);</span><span class="line">                $line = substr($line,$pos + <span class="number">1</span>);</span><span class="line">                <span class="comment"># if we are processing headers we need to</span></span><span class="line">                <span class="comment"># add a LWSP-char to the front of the new line</span></span><span class="line">                <span class="comment"># rfc 822 on long msg headers</span></span><span class="line">                <span class="keyword">if</span>($in_headers) &#123;</span><span class="line">                    $line = <span class="string">"\t"</span> . $line;</span><span class="line">                &#125;</span><span class="line">            &#125;</span><span class="line">            $lines_out[] = $line;</span><span class="line"></span><span class="line">            <span class="comment"># now send the lines to the server</span></span><span class="line">            <span class="keyword">while</span>(<span class="keyword">list</span>(,$line_out) = @each($lines_out)) &#123;</span><span class="line">                <span class="keyword">if</span>(strlen($line_out) &gt; <span class="number">0</span>)</span><span class="line">                &#123;</span><span class="line">                    <span class="keyword">if</span>(substr($line_out, <span class="number">0</span>, <span class="number">1</span>) == <span class="string">"."</span>) &#123;</span><span class="line">                        $line_out = <span class="string">"."</span> . $line_out;</span><span class="line">                    &#125;</span><span class="line">                &#125;</span><span class="line">                fputs(<span class="keyword">$this</span>-&gt;smtp_conn,$line_out . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment"># ok all the message data has been sent so lets get this</span></span><span class="line">        <span class="comment"># over with aleady</span></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn, <span class="keyword">$this</span>-&gt;CRLF . <span class="string">"."</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"DATA not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Expand takes the name and asks the server to list all the</span></span><span class="line"><span class="comment">     * people who are members of the _list_. Expand will return</span></span><span class="line"><span class="comment">     * back and array of the result or false if an error occurs.</span></span><span class="line"><span class="comment">     * Each value in the array returned has the format of:</span></span><span class="line"><span class="comment">     *     [   ]</span></span><span class="line"><span class="comment">     * The definition of  is defined in rfc 821</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: EXPN</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE FAILURE: 550</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500,501,502,504,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string array</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Expand</span><span class="params">($name)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Expand() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"EXPN "</span> . $name . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"EXPN not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment"># parse the reply and place in our array to return to user</span></span><span class="line">        $entries = explode(<span class="keyword">$this</span>-&gt;CRLF,$rply);</span><span class="line">        <span class="keyword">while</span>(<span class="keyword">list</span>(,$l) = @each($entries)) &#123;</span><span class="line">            $list[] = substr($l,<span class="number">4</span>);</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $list;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends the HELO command to the smtp server.</span></span><span class="line"><span class="comment">     * This makes sure that we and the server are in</span></span><span class="line"><span class="comment">     * the same known state.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements from rfc 821: HELO</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500, 501, 504, 421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hello</span><span class="params">($host=<span class="string">""</span>)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Hello() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment"># if a hostname for the HELO wasn't specified determine</span></span><span class="line">        <span class="comment"># a suitable one to send</span></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($host)) &#123;</span><span class="line">            <span class="comment"># we need to determine some sort of appopiate default</span></span><span class="line">            <span class="comment"># to send to the server</span></span><span class="line">            $host = <span class="string">"localhost"</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment">// Send extended hello first (RFC 2821)</span></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;SendHello(<span class="string">"EHLO"</span>, $host))</span><span class="line">        &#123;</span><span class="line">            <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;SendHello(<span class="string">"HELO"</span>, $host))</span><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends a HELO/EHLO command.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SendHello</span><span class="params">($hello, $host)</span> </span>&#123;</span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn, $hello . <span class="string">" "</span> . $host . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER: "</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; $hello . <span class="string">" not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">$this</span>-&gt;helo_rply = $rply;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Gets help information on the keyword specified. If the keyword</span></span><span class="line"><span class="comment">     * is not specified then returns generic help, ussually contianing</span></span><span class="line"><span class="comment">     * A list of keywords that help is available on. This function</span></span><span class="line"><span class="comment">     * returns the results back to the user. It is up to the user to</span></span><span class="line"><span class="comment">     * handle the returned data. If an error occurs then false is</span></span><span class="line"><span class="comment">     * returned with $this-&gt;error set appropiately.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: HELP [   ]</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 211,214</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500,501,502,504,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Help</span><span class="params">($keyword=<span class="string">""</span>)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># to avoid confusion</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Help() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $extra = <span class="string">""</span>;</span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($keyword)) &#123;</span><span class="line">            $extra = <span class="string">" "</span> . $keyword;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"HELP"</span> . $extra . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">211</span> &amp;&amp; $code != <span class="number">214</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"HELP not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $rply;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Starts a mail transaction from the email address specified in</span></span><span class="line"><span class="comment">     * $from. Returns true if successful or false otherwise. If True</span></span><span class="line"><span class="comment">     * the mail transaction is started and then one or more Recipient</span></span><span class="line"><span class="comment">     * commands may be called followed by a Data command.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: MAIL  FROM:</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 552,451,452</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 500,501,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Mail</span><span class="params">($from)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Mail() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"MAIL FROM:&lt;"</span> . $from . <span class="string">"&gt;"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"MAIL not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends the command NOOP to the SMTP server.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements from rfc 821: NOOP</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500, 421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Noop</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Noop() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"NOOP"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"NOOP not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends the quit command to the server and then closes the socket</span></span><span class="line"><span class="comment">     * if there is no error or the $close_on_error argument is true.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements from rfc 821: QUIT</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 221</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Quit</span><span class="params">($close_on_error=true)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so there is no confusion</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Quit() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="comment"># send the quit command to the server</span></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"quit"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        <span class="comment"># get any good-bye messages</span></span><span class="line">        $byemsg = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $byemsg;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        $rval = <span class="keyword">true</span>;</span><span class="line">        $e = <span class="keyword">null</span>;</span><span class="line"></span><span class="line">        $code = substr($byemsg,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line">        <span class="keyword">if</span>($code != <span class="number">221</span>) &#123;</span><span class="line">            <span class="comment"># use e as a tmp var cause Close will overwrite $this-&gt;error</span></span><span class="line">            $e = <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"SMTP server rejected quit command"</span>,</span><span class="line">                       <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                       <span class="string">"smtp_rply"</span> =&gt; substr($byemsg,<span class="number">4</span>));</span><span class="line">            $rval = <span class="keyword">false</span>;</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . $e[<span class="string">"error"</span>] . <span class="string">": "</span> .</span><span class="line">                         $byemsg . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($e) || $close_on_error) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;Close();</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> $rval;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends the command RCPT to the SMTP server with the TO: argument of $to.</span></span><span class="line"><span class="comment">     * Returns true if the recipient was accepted false if it was rejected.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements from rfc 821: RCPT  TO:</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250,251</span></span><span class="line"><span class="comment">     * SMTP CODE FAILURE: 550,551,552,553,450,451,452</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500,501,503,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Recipient</span><span class="params">($to)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Recipient() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"RCPT TO:&lt;"</span> . $to . <span class="string">"&gt;"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span> &amp;&amp; $code != <span class="number">251</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"RCPT not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Sends the RSET command to abort and transaction that is</span></span><span class="line"><span class="comment">     * currently in progress. Returns true if successful false</span></span><span class="line"><span class="comment">     * otherwise.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: RSET</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500,501,504,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Reset</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Reset() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"RSET"</span> . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"RSET failed"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Starts a mail transaction from the email address specified in</span></span><span class="line"><span class="comment">     * $from. Returns true if successful or false otherwise. If True</span></span><span class="line"><span class="comment">     * the mail transaction is started and then one or more Recipient</span></span><span class="line"><span class="comment">     * commands may be called followed by a Data command. This command</span></span><span class="line"><span class="comment">     * will send the message to the users terminal if they are logged</span></span><span class="line"><span class="comment">     * in.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: SEND  FROM:</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 552,451,452</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 500,501,502,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Send</span><span class="params">($from)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Send() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"SEND FROM:"</span> . $from . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"SEND not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Starts a mail transaction from the email address specified in</span></span><span class="line"><span class="comment">     * $from. Returns true if successful or false otherwise. If True</span></span><span class="line"><span class="comment">     * the mail transaction is started and then one or more Recipient</span></span><span class="line"><span class="comment">     * commands may be called followed by a Data command. This command</span></span><span class="line"><span class="comment">     * will send the message to the users terminal if they are logged</span></span><span class="line"><span class="comment">     * in and send them an email.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: SAML  FROM:</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 552,451,452</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 500,501,502,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SendAndMail</span><span class="params">($from)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                <span class="string">"error"</span> =&gt; <span class="string">"Called SendAndMail() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"SAML FROM:"</span> . $from . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"SAML not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Starts a mail transaction from the email address specified in</span></span><span class="line"><span class="comment">     * $from. Returns true if successful or false otherwise. If True</span></span><span class="line"><span class="comment">     * the mail transaction is started and then one or more Recipient</span></span><span class="line"><span class="comment">     * commands may be called followed by a Data command. This command</span></span><span class="line"><span class="comment">     * will send the message to the users terminal if they are logged</span></span><span class="line"><span class="comment">     * in or mail it to them if they are not.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: SOML  FROM:</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 552,451,452</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 500,501,502,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SendOrMail</span><span class="params">($from)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                <span class="string">"error"</span> =&gt; <span class="string">"Called SendOrMail() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"SOML FROM:"</span> . $from . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"SOML not accepted from server"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * This is an optional command for SMTP that this class does not</span></span><span class="line"><span class="comment">     * support. This method is here to make the RFC821 Definition</span></span><span class="line"><span class="comment">     * complete for this class and __may__ be implimented in the future</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements from rfc 821: TURN</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250</span></span><span class="line"><span class="comment">     * SMTP CODE FAILURE: 502</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500, 503</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Turn</span><span class="params">()</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"This method, TURN, of the SMTP "</span>.</span><span class="line">                                        <span class="string">"is not implemented"</span>);</span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; NOTICE: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Verifies that the name is recognized by the server.</span></span><span class="line"><span class="comment">     * Returns false if the name could not be verified otherwise</span></span><span class="line"><span class="comment">     * the response from the server is returned.</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * Implements rfc 821: VRFY</span></span><span class="line"><span class="comment">     *</span></span><span class="line"><span class="comment">     * SMTP CODE SUCCESS: 250,251</span></span><span class="line"><span class="comment">     * SMTP CODE FAILURE: 550,551,553</span></span><span class="line"><span class="comment">     * SMTP CODE ERROR  : 500,501,502,421</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> int</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Verify</span><span class="params">($name)</span> </span>&#123;</span><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="keyword">null</span>; <span class="comment"># so no confusion is caused</span></span><span class="line"></span><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;connected()) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="keyword">array</span>(</span><span class="line">                    <span class="string">"error"</span> =&gt; <span class="string">"Called Verify() without being connected"</span>);</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        fputs(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="string">"VRFY "</span> . $name . <span class="keyword">$this</span>-&gt;CRLF);</span><span class="line"></span><span class="line">        $rply = <span class="keyword">$this</span>-&gt;get_lines();</span><span class="line">        $code = substr($rply,<span class="number">0</span>,<span class="number">3</span>);</span><span class="line"></span><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">2</span>) &#123;</span><span class="line">            <span class="keyword">echo</span> <span class="string">"SMTP -&gt; FROM SERVER:"</span> . <span class="keyword">$this</span>-&gt;CRLF . $rply;</span><span class="line">        &#125;</span><span class="line"></span><span class="line">        <span class="keyword">if</span>($code != <span class="number">250</span> &amp;&amp; $code != <span class="number">251</span>) &#123;</span><span class="line">            <span class="keyword">$this</span>-&gt;error =</span><span class="line">                <span class="keyword">array</span>(<span class="string">"error"</span> =&gt; <span class="string">"VRFY failed on name '$name'"</span>,</span><span class="line">                      <span class="string">"smtp_code"</span> =&gt; $code,</span><span class="line">                      <span class="string">"smtp_msg"</span> =&gt; substr($rply,<span class="number">4</span>));</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">1</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; ERROR: "</span> . <span class="keyword">$this</span>-&gt;error[<span class="string">"error"</span>] .</span><span class="line">                         <span class="string">": "</span> . $rply . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> $rply;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">    <span class="comment">/*******************************************************************</span></span><span class="line"><span class="comment">     *                       INTERNAL FUNCTIONS                       *</span></span><span class="line"><span class="comment">     ******************************************************************/</span></span><span class="line"></span><span class="line">    <span class="comment">/**</span></span><span class="line"><span class="comment">     * Read in as many lines as possible</span></span><span class="line"><span class="comment">     * either before eof or socket timeout occurs on the operation.</span></span><span class="line"><span class="comment">     * With SMTP we can tell if we have more lines to read if the</span></span><span class="line"><span class="comment">     * 4th character is '-' symbol. If it is a space then we don't</span></span><span class="line"><span class="comment">     * need to read anything else.</span></span><span class="line"><span class="comment">     * <span class="doctag">@access</span> private</span></span><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><span class="line"><span class="comment">     */</span></span><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_lines</span><span class="params">()</span> </span>&#123;</span><span class="line">        $data = <span class="string">""</span>;</span><span class="line">        <span class="keyword">while</span>($str = fgets(<span class="keyword">$this</span>-&gt;smtp_conn,<span class="number">515</span>)) &#123;</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">4</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; get_lines(): \$data was \"$data\""</span> .</span><span class="line">                         <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; get_lines(): \$str is \"$str\""</span> .</span><span class="line">                         <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            $data .= $str;</span><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;do_debug &gt;= <span class="number">4</span>) &#123;</span><span class="line">                <span class="keyword">echo</span> <span class="string">"SMTP -&gt; get_lines(): \$data is \"$data\""</span> . <span class="keyword">$this</span>-&gt;CRLF;</span><span class="line">            &#125;</span><span class="line">            <span class="comment"># if the 4th character is a space then we are done reading</span></span><span class="line">            <span class="comment"># so just break the loop</span></span><span class="line">            <span class="keyword">if</span>(substr($str,<span class="number">3</span>,<span class="number">1</span>) == <span class="string">" "</span>) &#123; <span class="keyword">break</span>; &#125;</span><span class="line">        &#125;</span><span class="line">        <span class="keyword">return</span> $data;</span><span class="line">    &#125;</span><span class="line"></span><span class="line">&#125;</span><span class="line"><span class="meta">?&gt;</span></span></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/java/2008/11/16/send-mail-through-gmail-smtp-using-javamail.html" rel="next" title="send mail through gmail smtp using javamail">
                <i class="fa fa-chevron-left"></i>
                send mail through gmail smtp using javamail
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/java/2008/11/18/java-polymorphism.html" rel="prev" title="java polymorphism多态">
                <i class="fa fa-chevron-right"></i>
                java polymorphism多态
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/blog/images/avatar.jpg" alt="yuweijun">
          <p class="site-author-name" itemprop="name">yuweijun</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">492</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">categories</span>
              
            </div>
          

          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yuweijun" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/yuweijun" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#class-phpmailer-php-source"><span class="nav-number">1.</span> <span class="nav-text">class.phpmailer.php source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#class-smtp-php-source-modified-for-gmail"><span class="nav-number">2.</span> <span class="nav-text">class.smtp.php source (modified for gmail)</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-github"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yuweijun</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist.KISS
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>











  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.ui.min.js"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
